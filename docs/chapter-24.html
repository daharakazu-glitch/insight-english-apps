<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Insight App - Chapter 24</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&family=Tinos:wght@700&display=swap');
        
        body {
            background-color: #007BFF; /* ビビットなブルー */
            font-family: 'Noto Sans JP', sans-serif;
        }

        /* 英語フォントをTimes New Romanに設定 */
        .font-english {
            font-family: 'Tinos', 'Times New Roman', serif;
            font-weight: 700;
            font-size: 1.25rem; /* 20px */
            line-height: 1.75rem; /* 28px */
        }

        .answer-span {
            color: #DC2626; /* 赤色 */
            font-weight: 700;
            display: none;
        }

        .underline-span {
            text-decoration: underline;
            text-underline-offset: 4px;
            display: inline;
        }

        .show-answer .answer-span {
            display: inline;
        }

        .show-answer .underline-span {
            display: none;
        }
        
        .explanation {
            display: none;
            white-space: pre-wrap;
        }

        /* Button Styles for Modal */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }
        .btn-primary {
            background-color: #3b82f6;
            color: white;
        }
        .btn-primary:hover {
            background-color: #2563eb;
        }
        .btn-secondary {
            background-color: #6b7280;
            color: white;
        }
        .btn-secondary:hover {
            background-color: #4b5563;
        }
    </style>
</head>
<body class="text-gray-800">

    <div id="app-container" class="container mx-auto p-4 md:p-8 max-w-4xl">
        <header class="text-center mb-8 bg-blue-500 p-4 rounded-xl shadow-lg">
            <h1 class="text-2xl md:text-3xl font-bold text-white">Insight 英文法・語法・熟語</h1>
            <h2 id="app-subtitle" class="text-xl md:text-2xl font-bold text-white">学習用サイト（Chapter 24）</h2>
        </header>

        <main class="bg-white/90 backdrop-blur-sm p-6 rounded-xl shadow-lg mb-28">
            <div class="flex justify-between items-center mb-6">
                 <!-- PDF Control Section -->
                 <div class="flex-1 mr-4">
                    <div class="p-4 bg-gray-50 rounded-lg border border-gray-200">
                        <h3 class="font-bold text-sm md:text-base mb-2">選択した問題でPDFを作成</h3>
                        <div class="flex flex-col md:flex-row md:items-center justify-between gap-3">
                            <div class="flex items-center">
                                <input type="checkbox" id="select-all-checkbox" class="h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                <label for="select-all-checkbox" class="ml-2 text-sm font-medium text-gray-700 cursor-pointer">すべて選択 / 解除</label>
                            </div>
                            <button id="open-pdf-modal-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow text-sm transition-transform transform hover:scale-105">
                                PDF作成メニュー
                            </button>
                        </div>
                    </div>
                </div>

                <button id="start-quiz-btn" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-lg shadow transition-transform transform hover:scale-105 whitespace-nowrap">
                    ランダムテスト
                </button>
            </div>

            <div id="sentence-list" class="space-y-6">
                <!-- Sentences will be populated by JS -->
            </div>
        </main>
    </div>

    <!-- Control Panel -->
    <div id="control-panel" class="fixed bottom-0 left-0 right-0 bg-white/80 backdrop-blur-md p-4 border-t-2 border-gray-200 shadow-2xl flex justify-center items-center space-x-2 md:space-x-4">
        <button id="toggle-answer-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">表示/非表示</button>
        <button id="play-sound-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">音声再生</button>
        <button id="record-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">録音評価</button>
        <button id="toggle-explanation-btn" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">解説</button>
    </div>

    <!-- Message/Score Modal -->
    <div id="message-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50">
        <div id="message-content" class="bg-white p-8 rounded-lg shadow-xl text-center">
            <!-- Message content will be populated by JS -->
        </div>
    </div>
    
    <!-- Quiz Modal -->
    <div id="quiz-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center z-40 p-4">
        <div class="bg-white w-full max-w-2xl p-8 rounded-2xl shadow-2xl relative">
            <button id="close-quiz-btn" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-3xl font-bold">&times;</button>
            <div id="quiz-content">
                <!-- Quiz content will be populated by JS -->
            </div>
        </div>
    </div>

    <!-- PDF Download Modal -->
    <div id="pdf-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50">
        <div class="relative mx-auto p-5 border w-11/12 md:w-1/2 lg:w-1/3 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">ダウンロードするPDFの種類を選択</h3>
                <div class="mt-2 space-y-3">
                    <button id="download-list-btn" class="btn btn-primary w-full justify-start text-left">1. 完全なリスト (熟語・意味・例文)</button>
                    <button id="download-en-quiz-btn" class="btn btn-primary w-full justify-start text-left">2. 熟語テスト (英語を解答)</button>
                    <button id="download-ja-quiz-btn" class="btn btn-primary w-full justify-start text-left">3. 熟語テスト (意味を解答)</button>
                    <button id="download-mixed-quiz-btn" class="btn btn-primary w-full justify-start text-left">4. 熟語テスト (混合)</button>
                    <button id="download-sentence-quiz-btn" class="btn btn-primary w-full justify-start text-left">5. 例文の穴埋め問題</button>
                    <button id="download-sentence-mixed-quiz-btn" class="btn btn-primary w-full justify-start text-left">6. 例文の混合問題 (穴埋め/和訳)</button>
                </div>
                <div class="mt-6">
                    <button id="close-modal-btn" class="btn btn-secondary w-full">キャンセル</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const chapterData = [
    {
        "id": "1056",
        "ja": "電車は20分遅れて東京駅に到着した。",
        "en": "The train {arrived at Tokyo Station} 20 minutes late.",
        "answer": "arrived at Tokyo Station",
        "explanation": "▶ at は前置詞で， 「場所の一点，目標点」などの意味を表す。➡Grasp33\narrive at A"
    },
    {
        "id": "1057",
        "ja": "人をじっと見るのは失礼だ。",
        "en": "It is rude to {stare at people}.",
        "answer": "stare at people",
        "explanation": "stare at A ʮAͭΊΔʯ"
    },
    {
        "id": "1058",
        "ja": "その政策は CO2排出量の削減をめざしている。",
        "en": "The policy {aims at cutting} down on CO2 emissions.",
        "answer": "aims at cutting",
        "explanation": ""
    },
    {
        "id": "1059",
        "ja": "私はその大会で 失 敗して悔しい思いをした。",
        "en": "I felt disappointed because I {failed in} the competition.",
        "answer": "failed in",
        "explanation": "▶ in は前置詞で，空間・状態・分野などの「中」を表す。➡Grasp33– p.393\nfail in A ʮAഊ͢Δʯ"
    },
    {
        "id": "1060",
        "ja": "幸せは小さなことの中にある。",
        "en": "Happiness {lies in} small things.",
        "answer": "lies in",
        "explanation": "lie in AҼɾཧ༝ͳͲ͕ʣA ʹ͋Δʯ＝consist in A"
    },
    {
        "id": "1062",
        "ja": "ghost ʮ༓ྶʯ― 数えられる名詞 大学ではデータサイエンスを専攻したいです。",
        "en": "I would like to {major in} data science in college.",
        "answer": "major in",
        "explanation": "major in A\nspecialize in A    ʮA͢Δʯ"
    },
    {
        "id": "1063",
        "ja": "その会社は IT サービスとソフトウェア・ソリューションを取り扱っている。",
        "en": "The company {deals in} IT services and software solutions.",
        "answer": "deals in",
        "explanation": "deal in A ʮAʢ঎඼ͳͲʣΛऔΓѻ͏ɼA Λ঎͏ʯ"
    },
    {
        "id": "1065",
        "ja": "私の妹はしつこく同じ質問をした。",
        "en": "My sister {persisted in asking} the same question.",
        "answer": "persisted in asking",
        "explanation": "persist in doing ʮͭ͘͜͠ʙ ͢Δʯ"
    },
    {
        "id": "1066",
        "ja": "その男性は電車に乗るところだ。",
        "en": "The man is {getting on the train}.",
        "answer": "getting on the train",
        "explanation": "▶ on は前置詞で， 「～に接して，～の上に」などの意味を表す。➡Grasp34"
    },
    {
        "id": "1067-1",
        "ja": "いつでも私 を 頼りにしてください。",
        "en": "You can always {count on me}.",
        "answer": "count on me",
        "explanation": "count on AʮA Λ౰ͯʹ͢ΔɼA Λ པ Γ ʹ ͢ Δʢ＝rely on A ＝depend on Aʣʯ"
    },
    {
        "id": "1067-2",
        "ja": "私たちは日常生活でコンピューターに大きく依存している。",
        "en": "We {rely heavily on computers} in our daily lives.",
        "answer": "rely heavily on computers",
        "explanation": "rely on A ʮA ʹཔΔɼA ʹґଘ͢Δʯ＝depend on A"
    },
    {
        "id": "1067-3",
        "ja": "私たちは AIに頼り過ぎてはいけない。",
        "en": "We should not {depend too much on} AI.",
        "answer": "depend too much on",
        "explanation": "depend on A\nᶃʮA ʹཔΔɼA ʹ ґ ଘ ͢ Δʢ＝rely on AͳͲ͕ʣA·Δʯ"
    },
    {
        "id": "1067-4",
        "ja": "成功は勤勉さと決断力にかかっている。",
        "en": "Success {depends [rests] on} hard work and determination.",
        "answer": "depends [rests] on",
        "explanation": ""
    },
    {
        "id": "1068",
        "ja": "将来，年金だけで生活するのは 難しくなるだろう。",
        "en": "It will be difficult to {live on} a pension alone in the future.",
        "answer": "live on",
        "explanation": "live on A  ᶃʮA Λৗ৯ͱ͢Δʯᶄ ʮA͠ ͍ͯ͘ʯ"
    },
    {
        "id": "1069",
        "ja": "彼らは一緒に読書会を始めるこ とを思いついた。",
        "en": "They {hit on the idea} of starting a book club together.",
        "answer": "hit on the idea",
        "explanation": "hit on A ʮA͍ͭ͘ʯ＝come up with A"
    },
    {
        "id": "1070",
        "ja": "▶ hit 「打つ，ぶつかる」の活用形はhit—hit—hit チームミーティングの日程を決める必要がある。",
        "en": "We need to {decide on a date} for the team meeting.",
        "answer": "decide on a date",
        "explanation": "decide on Aͷத͔ΒʣAΊΔʯ"
    },
    {
        "id": "1071",
        "ja": "私の弟は自分の部屋を持ちたがっている。",
        "en": "My brother {insists on having} his own room.",
        "answer": "insists on having",
        "explanation": "insist on A ʮA Λओு͢Δʯ"
    },
    {
        "id": "1072",
        "ja": "音楽を聴きながら勉強に集中するのは難しい。",
        "en": "I find it hard to {concentrate on studying} while listening to music.",
        "answer": "concentrate on studying",
        "explanation": "concentrate on A [doing]ʮA ʹ ʦʙ͢Δ͜ͱʹʧ ूத͢Δʯ"
    },
    {
        "id": "1073",
        "ja": "私の家族は正月に祖父母を訪ねる。",
        "en": "My family {calls on my grandparents} during the New Year holidays.",
        "answer": "calls on my grandparents",
        "explanation": "call on A ʮAʢਓʣΛ๚ͶΔʯ＝visit A ＝pay a visit to A"
    },
    {
        "id": "1075",
        "ja": "drop in ＝drop by ＝stop byΔʯ―by は副詞で「そばに」の意味。 政府は教育にもっとお金を費やすべきだ。",
        "en": "The government should {spend more money on education}.",
        "answer": "spend more money on education",
        "explanation": "spend A on BʮA ΛB ʹඅ΍͢ʯ"
    },
    {
        "id": "1076",
        "ja": "発展 私は自分の見解を他の人に押しつけたくない 。",
        "en": "I don’t want to {impose my views on others}.",
        "answer": "impose my views on others",
        "explanation": "impose A on BʮA ΛB ʹ՝͢ɼA ΛB ʹԡ͚ͭ͠Δʯ"
    },
    {
        "id": "1077",
        "ja": "発展 卒業おめでとうございます。",
        "en": "I’d like to {congratulate you on your graduation}.",
        "answer": "congratulate you on your graduation",
        "explanation": "congratulate A on BʮB ͷ͜ͱͰAʢਓʣΛॕ෱͢Δʯ"
    },
    {
        "id": "1078",
        "ja": "私たちはコロナ禍を経験した。",
        "en": "We {went through} the COVID-19 pandemic.",
        "answer": "went through",
        "explanation": "go through A\nᶃʮA Λ௨Γൈ͚Δʯ\nᶄʮA͢ Δʢ＝experience A ＝undergo Aʣʯ"
    },
    {
        "id": "1079",
        "ja": "最近，ケイ トから連絡はありましたか。",
        "en": "Have you {heard from} Kate lately?",
        "answer": "heard from",
        "explanation": "▶ from は前置詞で， 「～から」という起点や距離などを表す。➡Grasp35\nhear from A ʮA ͔ΒศΓ͕͋ΔɼA ͔Βి࿩Λ΋Β͏ʯ"
    },
    {
        "id": "1080",
        "ja": "その国では，何百万もの人々が貧 困に苦しんでいる。",
        "en": "Millions of people are {suﬀering from poverty} in that country.",
        "answer": "suﬀering from poverty",
        "explanation": "suffer from A ʮA͠Ήʯ"
    },
    {
        "id": "1081",
        "ja": "その件についてのコメントは差し控えたいと思います。",
        "en": "I would like to {refrain from commenting on that.}",
        "answer": "refrain from commenting on that.",
        "explanation": "refrain from A [doing]ʮA͑Δʯ"
    },
    {
        "id": "1082",
        "ja": "祖母は時々私に手紙をくれる。",
        "en": "My grandmother sometimes {writes to me}.",
        "answer": "writes to me",
        "explanation": "▶ to は前置詞で，到達点「～へ」や方向「～の方へ 」などを表す。➡Grasp36"
    },
    {
        "id": "1083",
        "ja": "助けが必要なときは，友達に助けを求めればいい。",
        "en": "When you need help, you can {turn to} your friends.",
        "answer": "turn to",
        "explanation": "turn to A  ᶃʮA͘ʯ ᶄʮAΊ Δʢ＝ask A for helpʣʯ"
    },
    {
        "id": "1084",
        "ja": "校則は守らなければならない。",
        "en": "We must {keep to the school rules.}",
        "answer": "keep to the school rules.",
        "explanation": "keep to A\nᶃʮA ʹԊͬͯਐΉʯᶄ「Aըʣʹ ै ͏ʢ＝obey A ＝follow Aʣʯ"
    },
    {
        "id": "1085",
        "ja": "彼らはようやく合意に達した。",
        "en": "They have finally {come to an agreement}.",
        "answer": "come to an agreement",
        "explanation": ""
    },
    {
        "id": "1086",
        "ja": "現在，私の貯金は全部で20 万円ある。",
        "en": "My savings currently {amount to} 200,000 yen.",
        "answer": "amount to",
        "explanation": "amount to AܭA ʹͳΔʯ＝total A"
    },
    {
        "id": "1087",
        "ja": "▶ このamount は「総計に達する」という意味の動詞。 the amount of ʴ数えられない名詞ʮʙͷྔʯ➡715  ―このamount は「量」 。 先生は異文化を理解するこ との難しさに言及した。",
        "en": "The teacher {referred to} difficulties in understanding other cultures.",
        "answer": "referred to",
        "explanation": "refer to A\nᶃʮA͢ Δʢ＝mention Aʣʯ ᶄʮAর ͢ Δʢ＝consult Aʣʯ\nrefer to A as B ʮA ΛBͿʯ＝call A B\ndiﬃculty in doing ʮʙ͢Δ͜ͱͷ೉͠͞ʯ\nturn / keep / come / agreement / amount\nGrasp toのイメージ36\nto\n・～へ\n［到達点］\n・～の方へ\n［方向］\n402 403\nSelf\nCheck\n復習"
    },
    {
        "id": "1088",
        "ja": "私たちはあなた方の提案に同意します。",
        "en": "We {agree to your proposal}.",
        "answer": "agree to your proposal",
        "explanation": "agree to A\nconsent to A    ʮAըʣʹಉҙ͢Δʯ―A に「人」はこない。"
    },
    {
        "id": "1089",
        "ja": "ボランティ アは地域社会の福祉に貢献している。",
        "en": "Volunteers {contribute to} the community’s well-being.",
        "answer": "contribute to",
        "explanation": ""
    },
    {
        "id": "1090",
        "ja": "彼の音楽は多くの国の人々に訴えかける。",
        "en": "His music {appeals to people} from many countries.",
        "answer": "appeals to people",
        "explanation": "appeal to A ʮAʢͷ৺ʣʹૌ͑Δʯ"
    },
    {
        "id": "1091",
        "ja": "世界の指導者たちは，紛争を解決するための暴力に訴えるべきではない。",
        "en": "World leaders should not {resort to violence} to resolve conflicts.",
        "answer": "resort to violence",
        "explanation": ""
    },
    {
        "id": "1092",
        "ja": "▶ resort には名詞で「行楽地，リゾート地」の意味があるが，この問題文の 同調圧力にもかかわらず，彼は自分の信念を貫くことを決めた。",
        "en": "He decided to {stick to his principles} despite peer pressure.",
        "answer": "stick to his principles",
        "explanation": "stick to A  ᶃʮA ʹͬͭ͘͘ʯᶄ ʮA͢Δʯ"
    },
    {
        "id": "1093",
        "ja": "彼女はまだ夫が生きているという希望を失ってはいない。",
        "en": "She still {clings to} the hope that her husband is alive.",
        "answer": "clings to",
        "explanation": "cling to A  ᶃʮA͢Δʯᶄ ʮAྗͳͲʣʹ͕͠Έͭ͘ʯ"
    },
    {
        "id": "1094",
        "ja": "▶ この問題文のhope は名詞で「希望」の意味。that は同格のthat。 私はすぐに新しい留学生が好きになった。",
        "en": "I {took to} our new international student immediately.",
        "answer": "took to",
        "explanation": ""
    },
    {
        "id": "1095",
        "ja": "電車が遅れるかもしれないとは思いもしなかった。",
        "en": "{It didn’t occur to me that} the train might be late.",
        "answer": "It didn’t occur to me that",
        "explanation": "S occur to AʮS͑ͳͲʣ͕ Aʢਓʣͷ৺ʹු͔Ϳʯ＝S strike A"
    },
    {
        "id": "1096",
        "ja": "私たちは変化する天候に適応する必要がある。",
        "en": "We need to adapt (ourselves) to the changing weather conditions.",
        "answer": "???",
        "explanation": "adapt to A ʮA ʹదԠ͢Δʯ＝adapt oneself to A"
    },
    {
        "id": "1098",
        "ja": "私の母は病気の祖母の 世 話 をしている。",
        "en": "My mother has been {looking after} my sick grandmother.",
        "answer": "looking after",
        "explanation": "▶ after は前置詞で， 「～の後」という意味を表す。➡Grasp37\nlook after A ʮA ͷੈ࿩Λ͢Δʯ＝take care of A ＝care for A"
    },
    {
        "id": "1099",
        "ja": "彼女は本当に母 親 に そっくりだ。",
        "en": "She really {takes after her mother}.",
        "answer": "takes after her mother",
        "explanation": "take after A ʮA͍ͯΔʯ＝resemble A ＝look like A"
    },
    {
        "id": "1100",
        "ja": "父や母など血縁関係がある年長者に似ている場合に使う。進行形にはならない。 両親は，私の祖父の名をとって私に名前をつけた。",
        "en": "My parents {named me after my grandfather}.",
        "answer": "named me after my grandfather",
        "explanation": "name A after BʮB ͷ໊ΛͱͬͯA ʹ໊લΛ͚ͭΔʯ"
    },
    {
        "id": "1101",
        "ja": "サラを 探している。彼女を見かけた ？",
        "en": "I’m {looking for Sara. Have you seen her?}",
        "answer": "looking for Sara. Have you seen her?",
        "explanation": "▶ for は方向を表し， 「～のために，～を求めて」などの意味を持つ。➡Grasp38\nlook for A ʮA Λ୳͢ʯ➡Grasp32– p.392"
    },
    {
        "id": "1102",
        "ja": "家族が私の飛行機代 を 出してくれ た。",
        "en": "My family {paid for} my flight.",
        "answer": "paid for",
        "explanation": "pay for A ʮA෷͏ʯ"
    },
    {
        "id": "1103",
        "ja": "彼らがその試合に負けた時は，本当に同情した。",
        "en": "I really {felt for them} when they lost that game.",
        "answer": "felt for them",
        "explanation": "feel for A ʮA ʹಉ৘͢Δʯ＝sympathize with A"
    },
    {
        "id": "1104",
        "ja": "母は私の祖父の世話をするために，よく実家に帰る。",
        "en": "My mother often goes back to her parents’ house to {care for my}",
        "answer": "care for my",
        "explanation": "grandfather.\ncare for A  ᶃʮA ͷ ੈ ࿩ Λ ͢ Δʢ＝take care of AʣʯᶄʮAΉʢ＝like Aʣʯ"
    },
    {
        "id": "1105",
        "ja": "昨日のミーティングを欠 席したことについて説 明してくれますか。",
        "en": "Can you {account for your absence from yesterday’s meeting?}",
        "answer": "account for your absence from yesterday’s meeting?",
        "explanation": "account for A ʮA Λઆ໌͢Δʯ＝explain A"
    },
    {
        "id": "1106",
        "ja": "経験不足を補うため，彼は助言を求めた。",
        "en": "He asked for advice to {compensate for} his lack of experience.",
        "answer": "compensate for",
        "explanation": "compensate for A\nᶃʮAΘͤΛ͢Δ ʢ＝make up for Aʣʯ ᶄʮA Λิঈ͢Δʯ"
    },
    {
        "id": "1107",
        "ja": "私たちは２か月後の科学コンクールに応募する予定です。",
        "en": "We plan to {apply for} the science competition in two months.",
        "answer": "apply for",
        "explanation": "apply for A ʮAΉɼA ʹԠื͢Δʯ"
    },
    {
        "id": "1108",
        "ja": "in ʴ期間ʹʦ ͷ ʧʯ➡741 人々は平和を切望している。",
        "en": "People {long for peace}.",
        "answer": "long for peace",
        "explanation": ""
    },
    {
        "id": "1109",
        "ja": "緊急時に，スマート フォ ンは助けを呼ぶのに使える。",
        "en": "In case of emergency, smartphones can be used to {call for help}.",
        "answer": "call for help",
        "explanation": "call for A  ᶃʮA Λ ඞ ཁ ͱ ͢ Δʢ＝need Aʣʯ ᶄʮAΊΔʯ"
    },
    {
        "id": "1110",
        "ja": "体 調 が 良くないなら，医者に来てもらうよ。",
        "en": "If you’re not feeling well, I’ll {send for a doctor}.",
        "answer": "send for a doctor",
        "explanation": "send for A ʮAʢਓʣʹདྷͯ΋Β͏ʯ＝call A"
    },
    {
        "id": "1111",
        "ja": "発展 彼女は来年の大統領選に立候補するだろう。",
        "en": "She will {run for president} next year.",
        "answer": "run for president",
        "explanation": "run for A ʮAิ͢Δʯ"
    },
    {
        "id": "1112",
        "ja": "",
        "en": "AIは人工知能を意味する。",
        "answer": "???",
        "explanation": ""
    },
    {
        "id": "1112",
        "ja": "",
        "en": "AI {stands for arti/f_icial intelligence}.",
        "answer": "stands for arti/f_icial intelligence",
        "explanation": "stand for A\n͕ʣA Λ ද ͢ʢ＝represent AʣɼA Λ ҙ ຯ ͢ Δʢ＝mean Aʣʯ"
    },
    {
        "id": "1113",
        "ja": "多くの団体が子どもたちの権利を擁護している。",
        "en": "Many organizations {stand up for} children’s rights.",
        "answer": "stand up for",
        "explanation": "stand up for AʮA͢ΔɼA͢Δʯ＝support A ＝stand by A"
    },
    {
        "id": "1114",
        "ja": "私たちは最寄りのバス停へ向かった。",
        "en": "We {headed for} the nearest bus stop.",
        "answer": "headed for",
        "explanation": "head for A ʮA͔ ͏ʢ＝make for Aʣʯ"
    },
    {
        "id": "1115",
        "ja": "発展 良いコミュニケーションは強い人間関係をもたらす。",
        "en": "Good communication {makes for} strong relationships.",
        "answer": "makes for",
        "explanation": "make for A\nᶃʮA͔ ͏ʢ＝head for AʣʯᶄʮAՌʣΛ ΋ ͨ Β ͢ʢ＝contribute to Aʣ」"
    },
    {
        "id": "1116",
        "ja": "私は来週，フィ リピンへ発つ。",
        "en": "I’m {leaving for the Philippines next week.}",
        "answer": "leaving for the Philippines next week.",
        "explanation": ""
    },
    {
        "id": "1117",
        "ja": "助けを求めることを恐れないで。",
        "en": "Don’t be afraid to {ask for help}.",
        "answer": "ask for help",
        "explanation": "ask for A ʮAΊΔʯ＝request A"
    },
    {
        "id": "1118",
        "ja": "サラにアドバイスを求めては？",
        "en": "Why don’t you {ask Sara for her advice}?",
        "answer": "ask Sara for her advice",
        "explanation": "ask A for BʮA ʹBΊΔʯ"
    },
    {
        "id": "1119",
        "ja": "このシャツを大きいサイズのものと交換したいのですが。",
        "en": "I would like to {exchange this shirt for} one in a larger size.",
        "answer": "exchange this shirt for",
        "explanation": "exchange A for BʮA ΛB͢Δʯ"
    },
    {
        "id": "1120",
        "ja": "▶ shirt 「シャツ」の代用と して，代名詞one を使う。 このレシピで，バターの代わりにマーガリンを使ってもいいですか。",
        "en": "Can I {substitute margarine for} butter in this recipe?",
        "answer": "substitute margarine for",
        "explanation": "substitute A for BʮB ͷ୅ΘΓʹA͏ʯ"
    },
    {
        "id": "1121",
        "ja": "私はカホを彼女の双子の妹のリホと間違えることがある。",
        "en": "I sometimes {mistake [take] Kaho for her twin sister, Riho.}",
        "answer": "mistake [take] Kaho for her twin sister, Riho.",
        "explanation": "mistake A for B\ntake A for B    ʮA ΛBҧ͑Δʯ"
    },
    {
        "id": "1122",
        "ja": "委員会がその問題を 調 査している。",
        "en": "The committee is {looking into} the matter.",
        "answer": "looking into",
        "explanation": "▶ into は前置詞で， 「～の中へ」という意味を表す。➡Grasp39\nlook into A ʮA Λௐ΂Δʯ➡Grasp32– p.392 ＝investigate A"
    },
    {
        "id": "1123",
        "ja": "駅で中学時代の友達にばったり会った。",
        "en": "I {ran into a friend} from junior high school at the station.",
        "answer": "ran into a friend",
        "explanation": "run into A\nbump into A    ʮAવग़ձ͏ʯ＝run across A ＝come across A"
    },
    {
        "id": "1124",
        "ja": "先週，3軒の家が空き巣被害にあった。",
        "en": "Three houses {were broken into} last week.",
        "answer": "were broken into",
        "explanation": "break into A ʮAʢՈɾళͳͲʣʹԡ͠ೖΔʯ"
    },
    {
        "id": "1125",
        "ja": "そのコメディ アンのジョークがとてもおかし く て，会場全体が爆笑に包まれた。",
        "en": "The comedian’s jokes were so funny that the entire audience {burst}",
        "answer": "burst",
        "explanation": "into laughter.\nburst into laughter\nburst out laughing     ʹস͍ग़͢ʯ"
    },
    {
        "id": "1126",
        "ja": "環境への影響を考慮しなければならない。",
        "en": "The environmental impact should {be taken into account.}",
        "answer": "be taken into account.",
        "explanation": "take A into account\ntake A into consideration\ntake account of A                       ʮAྀʹೖΕΔʯ\nallow for A"
    },
    {
        "id": "1127",
        "ja": "図書館で，たまたま危険生物についての興味深い本を見つけた。",
        "en": "In the library, I {came across an interesting book about dangerous}",
        "answer": "came across an interesting book about dangerous",
        "explanation": "creatures.\ncome across A       ʮA͚ͭΔɼ\nrun across A     Aવग़ձ͏ ʢ＝run into Aʣʯ"
    },
    {
        "id": "1128",
        "ja": "▶ このacross は前置詞で，元々は「～を横切って」という意味を表す。 彼は妻の死のショックから立ち直っていない。",
        "en": "He has not {gotten over} the shock of his wife’s death.",
        "answer": "gotten over",
        "explanation": "get over A ʮA෰͢ΔɼA Λ৐Γӽ͑Δʯ\n＝overcome A ＝recover from A"
    },
    {
        "id": "1129",
        "ja": "契約を入念に調べる時間がいく らか必要です。",
        "en": "We’ll need some time to {go over} the contract.",
        "answer": "go over",
        "explanation": "go over A ʮA Λೖ೦ʹௐ΂Δʯ＝examine A ＝review A"
    },
    {
        "id": "1130",
        "ja": "その歌手の名前は聞いたこ とがない。人気があるの ？",
        "en": "I’ve never {heard of that singer before. Is he popular?}",
        "answer": "heard of that singer before. Is he popular?",
        "explanation": ""
    },
    {
        "id": "1131",
        "ja": "私の両親は，私が友達と遅くまで外出することを認めてくれ な い 。",
        "en": "My parents don’t {approve of} me staying out late with my friends.",
        "answer": "approve of",
        "explanation": "approve of A ʮA Λঝೝ͢Δʯ"
    },
    {
        "id": "1132",
        "ja": "各国政府はすべての核兵器を廃絶するために協力すべきだ。",
        "en": "Governments should work together to {get rid of all nuclear}",
        "answer": "get rid of all nuclear",
        "explanation": "weapons.\nget rid of A ʮA ΛऔΓআ͘ʯ"
    },
    {
        "id": "1133",
        "ja": "廃棄物を適切に処分する必要がある。",
        "en": "We need to {dispose of waste} properly.",
        "answer": "dispose of waste",
        "explanation": ""
    },
    {
        "id": "1134",
        "ja": "私たちのブラスバンドはおおよそ60名で構成されている。",
        "en": "Our brass band {consists of approximately 60 members}.",
        "answer": "consists of approximately 60 members",
        "explanation": "consist of A ʮA੒͞Ε͍ͯΔʯ\n＝be composed of A ＝be made up of A ＝comprise A\nconsist in AҼɾཧ༝ͳͲ͕ʣAʢͷதʣʹ͋Δʯ＝lie in A\napproximately ʮ͓͓Αͦʯ＝about"
    },
    {
        "id": "1135",
        "ja": "私の祖父は肺がんで亡くなった。",
        "en": "My grandfather {died of [from] lung cancer}.",
        "answer": "died of [from] lung cancer",
        "explanation": "die of A\ndie from A    ʮA͵ʯ―  die because of A とはしない。"
    },
    {
        "id": "1136-1",
        "ja": "pass away ʮ๢͘ͳΔʯ➡1031 ―die「死ぬ」の婉曲的な表現。死因を述べる際は pass away は使わず，die of A / die from A で表現する。 その点はあなたに賛成しません。",
        "en": "I don’t {agree with you} there.",
        "answer": "agree with you",
        "explanation": "▶ with は同伴を表す前置詞で， 「～と共に，～と一緒に，～と合って，\n～に関して，～を使って」などの意味を持つ。➡Grasp37– p.406\nagree with A\ngo along with A    ʮA੒͢Δʯ"
    },
    {
        "id": "1136-2",
        "ja": "▶ agree with A はgo along with Aよ り も積極的な賛成を表す。 日々の生活でAIを使う という考えに，私は賛成です。",
        "en": "I {agree with the idea} of using AI in our daily lives.",
        "answer": "agree with the idea",
        "explanation": "▶ 〈agree with＋考え〉 の文。agree with の後には「人」も「考え」も く る。"
    },
    {
        "id": "1137",
        "ja": "サラは誰とでもうまくやってい ける。",
        "en": "Sara {gets along with} everyone.",
        "answer": "gets along with",
        "explanation": ""
    },
    {
        "id": "1138",
        "ja": "発展 私は子どもの頃のテディ ベアを手放せなかった。",
        "en": "I could not {part with} my childhood teddy bear.",
        "answer": "part with",
        "explanation": "part with A ʮA Λख์͢ʯ"
    },
    {
        "id": "1139",
        "ja": "私はストレスに対 処 するために音楽を聴く。",
        "en": "I listen to music to {cope with stress}.",
        "answer": "cope with stress",
        "explanation": "cope with A ʮA ʹ͏·͘ରॲ͢Δʯ＝deal with A"
    },
    {
        "id": "1140",
        "ja": "私たちはその問題に対処する必要がある。",
        "en": "We need to {deal with the problem}.",
        "answer": "deal with the problem",
        "explanation": "deal with A\nᶃʮA ʹ ର ॲ ͢ Δʢ＝cope with Aʣʯ ᶄʮAฑʣΛ ѻ ͏ʢ＝handle Aʣʯ"
    },
    {
        "id": "1141",
        "ja": "発展 朝食は卵かけご飯で済ませることもある。",
        "en": "Sometimes I {make do with raw egg over rice for breakfast.}",
        "answer": "make do with raw egg over rice for breakfast.",
        "explanation": "make do with A ʮAΘͤͷ΋ͷʣͰԿͱ͔͢Δʯ＝manage with A"
    },
    {
        "id": "1142",
        "ja": "raw egg over rice ʮཛ͔͚͝൧ʯ―raw は「生の」の意味。 日本の多くの学校は冷房なしではやっていけない。",
        "en": "Many schools in Japan cannot {do without} air conditioning.",
        "answer": "do without",
        "explanation": "do without A\ndispense with A    ʮA·ͤΔʯ"
    },
    {
        "id": "1143",
        "ja": "今日の多くの生徒たちは環境に関心を持っ ている。",
        "en": "Many students today {care about the environment}.",
        "answer": "care about the environment",
        "explanation": "▶ about は前置詞で， 「～について，～の辺り」などの意味を表す。"
    },
    {
        "id": "1144",
        "ja": "夕食後にキッチンの掃除に取りかかりましょう。",
        "en": "Let’s {set about cleaning} the kitchen after dinner.",
        "answer": "set about cleaning",
        "explanation": "set about A [doing]\ngo about A [doing]    ʮA ʹʦ ʙ ͢ Δ ͜ ͱ ʹ ʧऔ Γ ͔ ͔ Δ ʯ"
    },
    {
        "id": "1145",
        "ja": "私の家族はつらい時に私の味方になっ て くれる。",
        "en": "My family {stands by me in hard times.}",
        "answer": "stands by me in hard times.",
        "explanation": "▶ by は前置詞で， 「～のそばに」などの意味を表す。➡Grasp40\nstand by A ʮA͢ΔɼAʢਓʣͷྗʹͳΔʯ"
    },
    {
        "id": "1146",
        "ja": "どうやってこれらのコンサートチケットを手に入れたのですか。",
        "en": "How did you {come by} these concert tickets?",
        "answer": "come by",
        "explanation": "come by A ʮA ΛखʹೖΕΔʯ"
    },
    {
        "id": "1147",
        "ja": "新しい市庁舎が建設中だ。",
        "en": "The new City Hall {is under construction}.",
        "answer": "is under construction",
        "explanation": "▶ under は前置詞で， 「～の下に，～下で」という意味を表す。\n➡Grasp40, File106\nbe under constructionઃதͰ͋Δʯ＝be being built"
    },
    {
        "id": "1148",
        "ja": "City Hall໾ॴʯ―市の市役所は１つに特定されているため固有名詞扱いとなり， C とH は大文字で表記することが多い。 文化祭の準備は順調に進んでいる。",
        "en": "Preparations for the school festival are well {under way}.",
        "answer": "under way",
        "explanation": "under way\nunderway     ·͍ͬͯΔʯ"
    },
    {
        "id": "1149",
        "ja": "その森林火災を鎮火するのに 1 週間かかった。",
        "en": "It took a week to bring the forest fires {under control}.",
        "answer": "under control",
        "explanation": ""
    },
    {
        "id": "1150",
        "ja": "いくつ か のトイレ が故 障していた。",
        "en": "Some of the toilets were {out of order}.",
        "answer": "out of order",
        "explanation": "▶ out of は前置詞と して扱い， 「～の外へ，～を外れて，～を出て」などの意味\nを表す。➡Grasp41\nout of orderো͠ ͯʯ＝broken"
    },
    {
        "id": "1151",
        "ja": "発展 各地で森林火災が発生し，燃え盛っ て制御不能となった。",
        "en": "Forest fires broke out in many places and raged {out of control}.",
        "answer": "out of control",
        "explanation": "out of control\nout of hand        ͕͖͔ͳ͍ɼखʹෛ͑ͳ͍ʯ"
    },
    {
        "id": "1152",
        "ja": "ケンは遅れて到着し，完全に息 を 切らしていた。",
        "en": "Ken arrived late and was completely {out of breath}.",
        "answer": "out of breath",
        "explanation": "out of breath ʮଉΛ੾Βͯ͠ʯ＝short of breath"
    },
    {
        "id": "1153",
        "ja": "私の携帯電話は古いので，新しいのが必要だ。",
        "en": "My phone is {out of date} and I need a new one.",
        "answer": "out of date",
        "explanation": "out of date\nout of fashion    ͷʯ"
    },
    {
        "id": "1154",
        "ja": "パーティーでは場違いな感じがした。",
        "en": "I felt {out of place} at the party.",
        "answer": "out of place",
        "explanation": "out of place ʮ৔ҧ͍ͳʯ"
    },
    {
        "id": "1155",
        "ja": "学校をサボるなんて論外だ。",
        "en": "Skipping school is {out of the question}.",
        "answer": "out of the question",
        "explanation": "out of the question  ᶃ ʮෆՄೳͳ ʢ＝impossibleʣ ʯᶄ ʮ࿦֎Ͱʯ"
    },
    {
        "id": "1156",
        "ja": "発展 ナオミが突然，私たちの教室に入っ て来た。",
        "en": "Naomi came into our classroom {out of the blue}.",
        "answer": "out of the blue",
        "explanation": "out of the blueͳ͠ʹʯ＝suddenly ＝unexpectedly"
    },
    {
        "id": "1157",
        "ja": "のへきれき」と同じようなニュアンス。 私たちは人の陰口をたたくのは悪いことだとわかっている。",
        "en": "We know it is wrong to {talk about people behind their backs.}",
        "answer": "talk about people behind their backs.",
        "explanation": "▶ behind は前置詞で， 「～の後ろに，～に遅れて」などの意味を表す。\n➡Grasp42\nbehind one’s backʮʙͷ͍ͳ͍ͱ͜ΖͰʯ"
    },
    {
        "id": "1158",
        "ja": "その考えは少し時代遅れだ。",
        "en": "That idea is a bit {behind the times}.",
        "answer": "behind the times",
        "explanation": "behind the times୅஗Εͷʯ―  behind the time"
    },
    {
        "id": "1159",
        "ja": "その夕焼けの美しさは言葉では言い表せないほどだった。",
        "en": "The beauty of the sunset was {beyond description}.",
        "answer": "beyond description",
        "explanation": "▶ beyond は前置詞で， 「～を超えて」などの意味を表す。➡Grasp42\nbeyond AʮA Λӽ͑ͯʯ\nbeyond description͍දͤͳ͍΄Ͳʯ"
    }
];

        // --- App State ---
        let activeSentenceElement = null;
        let selectedSentences = new Set();
        let SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition;
        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.lang = 'en-US';
            recognition.interimResults = false;
        }
        
        // --- Voice Synthesis Setup ---
        let synthesisVoice = null;

        function setSynthesisVoice() {
            const voices = speechSynthesis.getVoices();
            // 優先順位: Google US English -> Microsoft Zira/David -> その他英語
            synthesisVoice = voices.find(voice => voice.name === 'Google US English') ||
                             voices.find(voice => voice.name.includes('Google') && voice.lang.includes('en-US')) ||
                             voices.find(voice => voice.name.includes('Microsoft') && voice.lang.includes('en-US')) ||
                             voices.find(voice => voice.lang === 'en-US') ||
                             voices.find(voice => voice.lang.startsWith('en'));
        }

        // 音声リストがロードされたら設定を実行
        if (speechSynthesis.onvoiceschanged !== undefined) {
            speechSynthesis.onvoiceschanged = setSynthesisVoice;
        }
        // 初期化時にも実行
        setSynthesisVoice();


        // --- DOM Elements ---
        const sentenceList = document.getElementById('sentence-list');
        const toggleAnswerBtn = document.getElementById('toggle-answer-btn');
        const playSoundBtn = document.getElementById('play-sound-btn');
        const recordBtn = document.getElementById('record-btn');
        const toggleExplanationBtn = document.getElementById('toggle-explanation-btn');
        const startQuizBtn = document.getElementById('start-quiz-btn');
        const messageModal = document.getElementById('message-modal');
        const messageContent = document.getElementById('message-content');
        const quizModal = document.getElementById('quiz-modal');
        const closeQuizBtn = document.getElementById('close-quiz-btn');
        const quizContent = document.getElementById('quiz-content');
        
        const selectAllCheckbox = document.getElementById('select-all-checkbox');
        const pdfModal = document.getElementById('pdf-modal');
        const openPdfModalBtn = document.getElementById('open-pdf-modal-btn');
        const closeModalBtn = document.getElementById('close-modal-btn');


        // --- Functions ---

        /**
         * Parses the English sentence template and creates the HTML structure.
         */
        function formatEnglishSentence(enTemplate, answer) {
            const blank = '__________';
            const answerHtml = `<span class="answer-span">${answer}</span>`;
            const underlineHtml = `<span class="underline-span">${blank}</span>`;
            const formattedSentence = enTemplate.replace(`{${answer}}`, `${answerHtml}${underlineHtml}`);
            return formattedSentence;
        }

        /**
         * Renders all sentences for the chapter.
         */
        function renderChapter() {
            sentenceList.innerHTML = '';
            chapterData.forEach(item => {
                const sentenceDiv = document.createElement('div');
                sentenceDiv.className = 'sentence-item p-4 border border-gray-200 rounded-lg bg-white transition-shadow duration-300 hover:shadow-md cursor-pointer';
                sentenceDiv.dataset.id = item.id;
                sentenceDiv.dataset.fullSentence = item.en.replace(`{${item.answer}}`, item.answer);

                const englishSentenceHtml = formatEnglishSentence(item.en, item.answer);

                sentenceDiv.innerHTML = `
                    <div class="flex items-start space-x-4">
                         <div class="flex items-center pt-1" onclick="event.stopPropagation()">
                            <input type="checkbox" class="sentence-checkbox h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500" data-id="${item.id}">
                        </div>
                        <span class="text-lg font-bold text-gray-500 w-10 shrink-0 pt-1">${item.id}</span>
                        <div class="flex-1">
                            <p class="mb-2 text-gray-700">${item.ja}</p>
                            <p class="font-english">${englishSentenceHtml}</p>
                            <div class="explanation mt-4 p-4 bg-yellow-100 border-l-4 border-yellow-400 text-gray-700 rounded-r-lg">
                                ${item.explanation}
                            </div>
                        </div>
                    </div>
                `;
                sentenceList.appendChild(sentenceDiv);
            });
            
            // Add click listener to each sentence item
            document.querySelectorAll('.sentence-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    // Don't select if clicking inside explanation
                    if (e.target.closest('.explanation')) return;
                    if (e.target.closest('.sentence-checkbox')) return; // Checkbox click is handled separately

                    if (activeSentenceElement) {
                        activeSentenceElement.classList.remove('ring-2', 'ring-blue-400', 'shadow-xl');
                    }
                    activeSentenceElement = item;
                    activeSentenceElement.classList.add('ring-2', 'ring-blue-400', 'shadow-xl');
                });
            });

            // Checkbox logic
            document.querySelectorAll('.sentence-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    const id = e.target.dataset.id;
                    if (e.target.checked) {
                        selectedSentences.add(id);
                    } else {
                        selectedSentences.delete(id);
                    }
                });
            });
            
            // Select the first sentence by default
            if (sentenceList.firstChild) {
                 sentenceList.firstChild.click();
            }
        }
        
        // --- PDF / Print Logic ---
        
        function openPrintWindow(bodyContent, title) {
            const htmlContent = `
                <!DOCTYPE html>
                <html lang="ja">
                <head>
                    <meta charset="UTF-8">
                    <title>Insight App - Chapter 24</title>
                    <style>
                        body { font-family: "Hiragino Kaku Gothic ProN", "Meiryo", sans-serif; line-height: 1.8; margin: 25px; color: #333; }
                        @media print { .no-print { display: none; } }
                        h1, h2 { text-align: center; border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 25px; }
                        ol, ul { list-style-position: inside; padding-left: 0; }
                        li { margin-bottom: 15px; }
                        .list-container { 
                            column-count: 2; 
                            column-gap: 40px; 
                        }
                        .list-container li, .list-container p { 
                            -webkit-column-break-inside: avoid; 
                            page-break-inside: avoid; 
                            break-inside: avoid; 
                        }
                        ol li {
                            list-style-type: decimal;
                            margin-left: 1.5em; 
                        }
                        .inline-content {
                            display: inline;
                        }
                        @media (max-width: 700px) { .list-container { column-count: 1; } }
                        .answer-key { page-break-before: always; margin-top: 50px; }
                        u { text-decoration: underline; text-underline-offset: 3px; }
                    </style>
                </head>
                <body>
                    <h1>${title}</h1>
                    <p class="no-print" style="text-align:center; margin-bottom: 20px; font-size: 0.9em; color: #666;">
                        ※印刷ダイアログが表示されない場合は、Ctrl+P (または Cmd+P) を押してください。
                    </p>
                    ${bodyContent}
                </body>
                </html>
            `;
            const printWindow = window.open('', '_blank');
            if (!printWindow) {
                showMessage('<p>ポップアップがブロックされました。設定を確認してください。</p>', 5000);
                return;
            }
            printWindow.document.write(htmlContent);
            printWindow.document.close();
            setTimeout(() => {
                printWindow.focus(); 
                printWindow.print();
            }, 250);
        }

        function getSelectedItems() {
            if (selectedSentences.size === 0) {
                showMessage('<p>PDFを作成する問題を選択してください。</p>', 3000);
                return null;
            }
            // Sort items based on ID
            return Array.from(selectedSentences)
                .map(id => chapterData.find(item => item.id === id))
                .filter(Boolean)
                .sort((a, b) => {
                     // Handle IDs like "1382-1" vs "1382-2"
                     const aParts = a.id.split('-').map(s => parseInt(s) || 0);
                     const bParts = b.id.split('-').map(s => parseInt(s) || 0);
                     if (aParts[0] !== bParts[0]) return aParts[0] - bParts[0];
                     return (aParts[1] || 0) - (bParts[1] || 0);
                });
        }
        
        function getUniqueItems(items) {
             const uniqueMap = new Map();
             items.forEach(item => {
                 // Use answer as key to deduplicate same phrases
                 if (!uniqueMap.has(item.answer)) {
                     uniqueMap.set(item.answer, item);
                 }
             });
             return Array.from(uniqueMap.values()).sort((a, b) => {
                 const aId = parseInt(a.id.split('-')[0]);
                 const bId = parseInt(b.id.split('-')[0]);
                 return aId - bId;
             });
        }


        // --- Message & Sound Functions ---
        
        function showMessage(htmlContent, duration = null) {
            messageContent.innerHTML = htmlContent;
            messageModal.classList.remove('hidden');
            if (duration) {
                setTimeout(() => {
                    messageModal.classList.add('hidden');
                }, duration);
            }
        }

        function playSound() {
            if (!activeSentenceElement) {
                showMessage('<p>文を選択してください。</p>', 2000);
                return;
            }

            // 音声が未設定なら再取得を試みる
            if (!synthesisVoice) {
                setSynthesisVoice();
            }

            // 連続再生を防ぐために一度キャンセル
            speechSynthesis.cancel();
            
            let textToSpeak = activeSentenceElement.dataset.fullSentence;
            // 念のため不要な記号を除去
            textToSpeak = textToSpeak.replace(/[{}]/g, '');

            const utterance = new SpeechSynthesisUtterance(textToSpeak);
            utterance.lang = 'en-US';

            // 英語音声が取得できていれば設定
            if (synthesisVoice) {
                utterance.voice = synthesisVoice;
            }

            utterance.rate = 1.0; 
            utterance.pitch = 1.0;

            speechSynthesis.speak(utterance);
        }

        function handleRecording() {
            if (!activeSentenceElement) {
                showMessage('<p>文を選択してください。</p>', 2000);
                return;
            }
            if (!SpeechRecognition) {
                showMessage('<p>お使いのブラウザは音声認識に対応していません。</p>', 3000);
                return;
            }

            showMessage('<p class="text-2xl">マイクに向かって話してください...</p><div class="animate-pulse text-red-500 text-4xl mt-4">●</div>');
            
            recognition.start();

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                evaluatePronunciation(transcript);
            };

            recognition.onerror = (event) => {
                showMessage(`<p>エラーが発生しました: ${event.error}</p>`, 3000);
            };
            
            recognition.onend = () => {
                 if (messageModal.classList.contains('hidden') === false && messageContent.innerHTML.includes('マイクに')) {
                    messageModal.classList.add('hidden');
                 }
            };
        }
        
        function evaluatePronunciation(transcript) {
            const originalText = activeSentenceElement.dataset.fullSentence;

            const cleanOrig = originalText.toLowerCase().replace(/[^\w\s]/g, '').split(' ');
            const cleanTrans = transcript.toLowerCase().replace(/[^\w\s]/g, '').split(' ');
            
            let matches = 0;
            cleanOrig.forEach(word => {
                if (cleanTrans.includes(word)) {
                    matches++;
                }
            });

            const similarity = matches / cleanOrig.length;
            
            let score;
            if (similarity > 0.9) {
                score = 95 + Math.floor(Math.random() * 5);
            } else if (similarity > 0.7) {
                score = 90 + Math.floor(Math.random() * 6);
            } else if (similarity > 0.5) {
                score = 85 + Math.floor(Math.random() * 5);
            } else if (similarity > 0.3) {
                score = 80 + Math.floor(Math.random() * 5);
            } else {
                score = 70 + Math.floor(Math.random() * 10);
            }
            
            if (score === 100 && Math.random() < 0.3) score = 99;

            const messageHtml = `
                <h3 class="text-2xl font-bold mb-4">評価結果</h3>
                <p class="text-7xl font-bold text-blue-600 mb-4">${score}<span class="text-2xl">点</span></p>
                <p class="text-gray-600 mb-2"><strong>あなたの発音:</strong> ${transcript}</p>
                <p class="text-gray-600"><strong>元の文:</strong> ${originalText}</p>
                <button onclick="document.getElementById('message-modal').classList.add('hidden')" class="mt-6 bg-blue-500 text-white py-2 px-6 rounded-lg">閉じる</button>
            `;
            showMessage(messageHtml);
        }

        // --- Quiz Functions ---

        function startQuiz() {
            if (chapterData.length < 10) {
                 showMessage('<p>クイズを作成するには、文が10個以上必要です。</p>', 3000);
                 return;
            }

            const shuffled = [...chapterData].sort(() => 0.5 - Math.random());
            const questions = shuffled.slice(0, 10);

            let currentQuestionIndex = 0;
            let score = 0;

            function showQuestion() {
                if (currentQuestionIndex >= questions.length) {
                    showQuizResult();
                    return;
                }

                const question = questions[currentQuestionIndex];
                const correctAnswer = question.answer;

                const incorrectAnswers = chapterData
                    .filter(item => item.answer !== correctAnswer)
                    .sort(() => 0.5 - Math.random())
                    .slice(0, 3)
                    .map(item => item.answer);

                const options = [correctAnswer, ...incorrectAnswers].sort(() => 0.5 - Math.random());
                
                const questionSentence = question.en.replace(`{${question.answer}}`, ' (______) ');

                quizContent.innerHTML = `
                    <h3 class="text-2xl font-bold mb-2">問題 ${currentQuestionIndex + 1}/10</h3>
                    <p class="text-lg mb-4">${question.ja}</p>
                    <p class="font-english text-xl mb-6 p-4 bg-gray-100 rounded-lg">${questionSentence}</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        ${options.map(opt => `<button class="quiz-option p-4 bg-blue-100 hover:bg-blue-200 rounded-lg text-left text-lg font-english" data-answer="${opt}">${opt}</button>`).join('')}
                    </div>
                `;

                document.querySelectorAll('.quiz-option').forEach(button => {
                    button.addEventListener('click', () => {
                        if (button.dataset.answer === correctAnswer) {
                            score++;
                            button.classList.add('bg-green-400', 'text-white');
                        } else {
                            button.classList.add('bg-red-400', 'text-white');
                            document.querySelector(`.quiz-option[data-answer="${CSS.escape(correctAnswer)}"]`).classList.add('bg-green-400', 'text-white');
                        }
                        
                        setTimeout(() => {
                            currentQuestionIndex++;
                            showQuestion();
                        }, 1200);
                    });
                });
            }

            function showQuizResult() {
                quizContent.innerHTML = `
                    <h3 class="text-3xl font-bold mb-4 text-center">テスト終了！</h3>
                    <p class="text-center text-xl mb-6">あなたのスコアは...</p>
                    <p class="text-center text-7xl font-bold text-purple-600">${score * 10}<span class="text-3xl">点</span></p>
                    <p class="text-center text-xl mt-2">(${questions.length}問中 ${score}問正解)</p>
                `;
            }

            showQuestion();
            quizModal.classList.remove('hidden');
        }


        // --- Event Listeners ---

        toggleAnswerBtn.addEventListener('click', () => {
            if (!activeSentenceElement) {
                showMessage('<p>文を選択してください。</p>', 2000);
                return;
            }
            activeSentenceElement.classList.toggle('show-answer');
        });

        toggleExplanationBtn.addEventListener('click', () => {
            if (!activeSentenceElement) {
                showMessage('<p>文を選択してください。</p>', 2000);
                return;
            }
            const explanationDiv = activeSentenceElement.querySelector('.explanation');
            if (explanationDiv.style.display === 'block') {
                explanationDiv.style.display = 'none';
            } else {
                explanationDiv.style.display = 'block';
            }
        });
        
        playSoundBtn.addEventListener('click', playSound);
        recordBtn.addEventListener('click', handleRecording);
        startQuizBtn.addEventListener('click', startQuiz);
        closeQuizBtn.addEventListener('click', () => quizModal.classList.add('hidden'));
        
        // Select All Logic
        selectAllCheckbox.addEventListener('change', (e) => {
            const isChecked = e.target.checked;
            const checkboxes = document.querySelectorAll('.sentence-checkbox');
            checkboxes.forEach(cb => {
                cb.checked = isChecked;
                if (isChecked) selectedSentences.add(cb.dataset.id);
                else selectedSentences.delete(cb.dataset.id);
            });
        });

        // PDF Modal Logic
        openPdfModalBtn.addEventListener('click', () => {
             if (selectedSentences.size === 0) {
                showMessage('<p>PDFを作成する問題を選択してください。</p>', 3000);
                return;
            }
            pdfModal.classList.remove('hidden');
        });
        closeModalBtn.addEventListener('click', () => pdfModal.classList.add('hidden'));

        // --- PDF Generation Buttons Listeners ---

        // 変更: PDF内のサブタイトルを「Insight 英文法・語法・熟語 ＋ 章とその題」の形式にする
        // h1: "Insight 英文法・語法・熟語"
        // h2: "学習用サイト（28章 その他の重要熟語）" -> "（28章 その他の重要熟語）" の部分を抽出して結合
        const mainTitle = document.querySelector('header h1').innerText;
        const subTitleRaw = document.getElementById('app-subtitle').innerText;
        // "学習用サイト" という文字が含まれていれば削除して整形
        const chapterTitle = subTitleRaw.replace('学習用サイト', '').trim();
        const subtitleText = `${mainTitle} ${chapterTitle}`;

        // 1. 完全なリスト
        document.getElementById('download-list-btn').addEventListener('click', () => {
            const items = getSelectedItems();
            if(!items) return;
            // リスト作成の場合は重複があっても良いが、見やすくするために熟語ベースでユニークにするか、
            // そのままID順で並べるか。ここではID順ですべて表示する。
            
            const listItems = items.map(item => {
                // Remove { } for clean display
                const cleanEn = item.en.replace(/[{}]/g, '');
                return `<li>
                    <span class="inline-content"><strong>${item.answer}</strong>: ${item.explanation.replace(/\n/g, '<br>')}</span><br>
                    <span style="font-size:0.9em; color:#555;">Ex: ${cleanEn} / ${item.ja}</span>
                </li>`;
            }).join('');
            
            openPrintWindow(`<ul class="list-container">${listItems}</ul>`, '重要熟語リスト');
            pdfModal.classList.add('hidden');
        });

        // 2. 英語を解答
        document.getElementById('download-en-quiz-btn').addEventListener('click', () => {
            const items = getUniqueItems(getSelectedItems());
            
            const quizItems = items.map(item => 
                `<li><span class="inline-content">${item.explanation.replace(/\n/g, ' ')} : ____________________</span></li>`
            ).join('');
            const answerItems = items.map(item => 
                `<li><span class="inline-content">${item.answer}</span></li>`
            ).join('');
            
            const body = `<h2>${subtitleText}</h2><ol class="list-container">${quizItems}</ol><div class="answer-key"><h2>解答</h2><ol class="list-container">${answerItems}</ol></div>`;
            openPrintWindow(body, '熟語テスト (英語を解答)');
            pdfModal.classList.add('hidden');
        });

        // 3. 意味を解答
        document.getElementById('download-ja-quiz-btn').addEventListener('click', () => {
            const items = getUniqueItems(getSelectedItems());
            
            const quizItems = items.map(item => 
                `<li><span class="inline-content"><strong>${item.answer}</strong> : ____________________</span></li>`
            ).join('');
            const answerItems = items.map(item => 
                `<li><span class="inline-content">${item.explanation.replace(/\n/g, ' ')}</span></li>`
            ).join('');
            
            const body = `<h2>${subtitleText}</h2><ol class="list-container">${quizItems}</ol><div class="answer-key"><h2>解答</h2><ol class="list-container">${answerItems}</ol></div>`;
            openPrintWindow(body, '熟語テスト (意味を解答)');
            pdfModal.classList.add('hidden');
        });

        // 4. 混合
        document.getElementById('download-mixed-quiz-btn').addEventListener('click', () => {
            const items = getUniqueItems(getSelectedItems());
            let quizItems = '';
            let answerItems = '';
            
            items.forEach(item => {
                if (Math.random() > 0.5) {
                    // 日本語 -> 英語
                    quizItems += `<li><span class="inline-content">${item.explanation.replace(/\n/g, ' ')} : ____________________</span></li>`;
                    answerItems += `<li><span class="inline-content">${item.answer}</span></li>`;
                } else {
                    // 英語 -> 日本語
                    quizItems += `<li><span class="inline-content"><strong>${item.answer}</strong> : ____________________</span></li>`;
                    answerItems += `<li><span class="inline-content">${item.explanation.replace(/\n/g, ' ')}</span></li>`;
                }
            });
            
            const body = `<h2>${subtitleText}</h2><ol class="list-container">${quizItems}</ol><div class="answer-key"><h2>解答</h2><ol class="list-container">${answerItems}</ol></div>`;
            openPrintWindow(body, '熟語テスト (混合)');
            pdfModal.classList.add('hidden');
        });

        // 5. 例文穴埋め
        document.getElementById('download-sentence-quiz-btn').addEventListener('click', () => {
            const items = getSelectedItems(); // 例文問題なので重複（文脈違い）も含める
            
            const quizItems = items.map(item => {
                // Replace {answer} with underscore
                const blankSentence = item.en.replace(`{${item.answer}}`, '____________________');
                return `<li>${blankSentence}<br><span style="font-size:0.9em;">(${item.ja})</span></li>`;
            }).join('');
            
            const answerItems = items.map(item => 
                `<li>${item.answer}</li>`
            ).join('');

            const body = `<h2>${subtitleText}</h2><ol>${quizItems}</ol><div class="answer-key"><h2>解答</h2><ol class="list-container">${answerItems}</ol></div>`;
            openPrintWindow(body, '熟語テスト (例文穴埋め)');
            pdfModal.classList.add('hidden');
        });

        // 6. 例文混合 (穴埋め / 下線部和訳)
        document.getElementById('download-sentence-mixed-quiz-btn').addEventListener('click', () => {
            const items = getSelectedItems();
            let quizItems = '';
            let answerItems = '';
            
            const instruction = '<p style="border:1px solid #ccc; padding:10px; margin-bottom:20px;">指示：空所には適切な語句を補い、下線部がある文は下線部の意味を日本語で答えなさい。</p>';

            items.forEach(item => {
                if (Math.random() > 0.5) {
                    // 穴埋め
                    const blankSentence = item.en.replace(`{${item.answer}}`, '____________________');
                    quizItems += `<li>${blankSentence}<br><span style="font-size:0.9em;">(${item.ja})</span></li>`;
                    answerItems += `<li>${item.answer}</li>`;
                } else {
                    // 下線部和訳 (ここでは熟語の意味を問う形にする)
                    const underlineSentence = item.en.replace(`{${item.answer}}`, `<u>${item.answer}</u>`);
                    quizItems += `<li>${underlineSentence}<br>意味: ____________________</li>`;
                    answerItems += `<li>${item.explanation.split('\n')[0]}</li>`; // 解説の1行目を答えとする
                }
            });

            const body = `<h2>${subtitleText}</h2>${instruction}<ol>${quizItems}</ol><div class="answer-key"><h2>解答</h2><ol class="list-container">${answerItems}</ol></div>`;
            openPrintWindow(body, '熟語テスト (例文混合)');
            pdfModal.classList.add('hidden');
        });


        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            renderChapter();
        });
    </script>
</body>
</html>