<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Insight App - Chapter 8</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&family=Tinos:wght@700&display=swap');

        body {
            background-color: #007BFF;
            /* ビビットなブルー */
            font-family: 'Noto Sans JP', sans-serif;
        }

        /* 英語フォントをTimes New Romanに設定 */
        .font-english {
            font-family: 'Tinos', 'Times New Roman', serif;
            font-weight: 700;
            font-size: 1.25rem;
            /* 20px */
            line-height: 1.75rem;
            /* 28px */
        }

        .answer-span {
            color: #DC2626;
            /* 赤色 */
            font-weight: 700;
            display: none;
        }

        .underline-span {
            text-decoration: underline;
            text-underline-offset: 4px;
            display: inline;
        }

        .show-answer .answer-span {
            display: inline;
        }

        .show-answer .underline-span {
            display: none;
        }

        .explanation {
            display: none;
            white-space: pre-wrap;
        }

        /* Button Styles for Modal */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }

        .btn-primary {
            background-color: #3b82f6;
            color: white;
        }

        .btn-primary:hover {
            background-color: #2563eb;
        }

        .btn-secondary {
            background-color: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #4b5563;
        }
    </style>
</head>

<body class="text-gray-800">

    <div id="app-container" class="container mx-auto p-4 md:p-8 max-w-4xl">
        <header class="text-center mb-8 bg-blue-500 p-4 rounded-xl shadow-lg">
            <h1 class="text-2xl md:text-3xl font-bold text-white">Insight 英文法・語法・熟語</h1>
            <h2 id="app-subtitle" class="text-xl md:text-2xl font-bold text-white">学習用サイト（Chapter 8）</h2>
        </header>

        <main class="bg-white/90 backdrop-blur-sm p-6 rounded-xl shadow-lg mb-28">
            <div class="flex justify-between items-center mb-6">
                <!-- PDF Control Section -->
                <div class="flex-1 mr-4">
                    <div class="p-4 bg-gray-50 rounded-lg border border-gray-200">
                        <h3 class="font-bold text-sm md:text-base mb-2">選択した問題でPDFを作成</h3>
                        <div class="flex flex-col md:flex-row md:items-center justify-between gap-3">
                            <div class="flex items-center">
                                <input type="checkbox" id="select-all-checkbox"
                                    class="h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                <label for="select-all-checkbox"
                                    class="ml-2 text-sm font-medium text-gray-700 cursor-pointer">すべて選択 / 解除</label>
                            </div>
                            <button id="open-pdf-modal-btn"
                                class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow text-sm transition-transform transform hover:scale-105">
                                PDF作成メニュー
                            </button>
                        </div>
                    </div>
                </div>

                <button id="start-quiz-btn"
                    class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-lg shadow transition-transform transform hover:scale-105 whitespace-nowrap">
                    ランダムテスト
                </button>
            </div>

            <div id="sentence-list" class="space-y-6">
                <!-- Sentences will be populated by JS -->
            </div>
        </main>
    </div>

    <!-- Control Panel -->
    <div id="control-panel"
        class="fixed bottom-0 left-0 right-0 bg-white/80 backdrop-blur-md p-4 border-t-2 border-gray-200 shadow-2xl flex justify-center items-center space-x-2 md:space-x-4">
        <button id="toggle-answer-btn"
            class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">表示/非表示</button>
        <button id="play-sound-btn"
            class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">音声再生</button>
        <button id="record-btn"
            class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">録音評価</button>
        <button id="toggle-explanation-btn"
            class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">解説</button>
    </div>

    <!-- Message/Score Modal -->
    <div id="message-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50">
        <div id="message-content" class="bg-white p-8 rounded-lg shadow-xl text-center">
            <!-- Message content will be populated by JS -->
        </div>
    </div>

    <!-- Quiz Modal -->
    <div id="quiz-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center z-40 p-4">
        <div class="bg-white w-full max-w-2xl p-8 rounded-2xl shadow-2xl relative">
            <button id="close-quiz-btn"
                class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-3xl font-bold">&times;</button>
            <div id="quiz-content">
                <!-- Quiz content will be populated by JS -->
            </div>
        </div>
    </div>

    <!-- PDF Download Modal -->
    <div id="pdf-modal"
        class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50">
        <div class="relative mx-auto p-5 border w-11/12 md:w-1/2 lg:w-1/3 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">ダウンロードするPDFの種類を選択</h3>
                <div class="mt-2 space-y-3">
                    <button id="download-list-btn" class="btn btn-primary w-full justify-start text-left">1. 完全なリスト
                        (熟語・意味・例文)</button>
                    <button id="download-en-quiz-btn" class="btn btn-primary w-full justify-start text-left">2. 熟語テスト
                        (英語を解答)</button>
                    <button id="download-ja-quiz-btn" class="btn btn-primary w-full justify-start text-left">3. 熟語テスト
                        (意味を解答)</button>
                    <button id="download-mixed-quiz-btn" class="btn btn-primary w-full justify-start text-left">4. 熟語テスト
                        (混合)</button>
                    <button id="download-sentence-quiz-btn" class="btn btn-primary w-full justify-start text-left">5.
                        例文の穴埋め問題</button>
                    <button id="download-sentence-mixed-quiz-btn"
                        class="btn btn-primary w-full justify-start text-left">6. 例文の混合問題 (穴埋め/和訳)</button>
                </div>
                <div class="mt-6">
                    <button id="close-modal-btn" class="btn btn-secondary w-full">キャンセル</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const chapterData = [
    {
        "id": "８",
        "ja": "章　関係詞  QR ☚ 音読用動画　別解など",
        "en": "???",
        "answer": "",
        "explanation": "",
        "question": ""
    },
    {
        "id": "100",
        "ja": "● 文法編｜８章",
        "en": "???",
        "answer": "",
        "explanation": "",
        "question": ""
    },
    {
        "id": "102",
        "ja": "● 文法編｜８章",
        "en": "???",
        "answer": "",
        "explanation": "",
        "question": ""
    },
    {
        "id": "104",
        "ja": "● 文法編｜８章",
        "en": "???",
        "answer": "",
        "explanation": "",
        "question": ""
    },
    {
        "id": "106",
        "ja": "● 文法編｜８章",
        "en": "???",
        "answer": "",
        "explanation": "",
        "question": ""
    },
    {
        "id": "108",
        "ja": "● 文法編｜８章",
        "en": "???",
        "answer": "",
        "explanation": "",
        "question": ""
    },
    {
        "id": "110",
        "ja": "● 文法編｜８章",
        "en": "???",
        "answer": "",
        "explanation": "",
        "question": ""
    },
    {
        "id": "112",
        "ja": "● 文法編｜８章",
        "en": "???",
        "answer": "",
        "explanation": "",
        "question": ""
    },
    {
        "id": "114",
        "ja": "● 文法編｜８章",
        "en": "???",
        "answer": "",
        "explanation": "",
        "question": ""
    },
    {
        "id": "191-1",
        "ja": "その国では18歳以上の人は誰でも投票できる。",
        "en": "Anyone {who is} 18 years or older can vote in the country. {Anyone} can vote in the country. ＋ They are [He or she is] 18 years or older. → {Anyone} {who }[{that}] is 18 years or older can vote in the country.",
        "answer": "who is, Anyone, Anyone, who, that",
        "explanation": "F 113 ▶ 関係詞は直前の名詞(先行詞)と直後の節(関係詞節)をつなぎ，名詞を修飾する。to不定詞や分詞の形容詞的用法も名詞を修飾するが，関係詞節はS’＋V’が含まれる形容詞節をつくる。関係詞には，関係詞節の中で代名詞の働きをする関係代名詞と，副詞の働きをする関係副詞などがある。➡ p.140 ②\n▶ 主格の関係代名詞who [that]を使った文。➡ VI 20―p.8",
        "question": "Anyone (w   ) (    ) 18 years or older can vote in the country."
    },
    {
        "id": "191-2",
        "ja": "学習を楽しくする教育アプリがある。",
        "en": "There are educational apps {that [which] make} learning fun. There are {educational apps}. ＋ They make learning fun. → There are {educational apps} {that }[{which}] make learning fun.",
        "answer": "that [which] make, educational apps, educational apps, that, which",
        "explanation": "F 113 ▶ 主格の関係代名詞that [which]を使った文。人以外(apps)が先行詞で，関係代名",
        "question": "There are educational apps that make learning fun."
    },
    {
        "id": "192-1",
        "ja": "君が必要な情報はネットで見つけることができる。",
        "en": "You can find {the information} online. ＋ You need it.",
        "answer": "the information",
        "explanation": "F 114 ▶ 目的格の関係代名詞that [which]を使った文。人以外(the information)が先行詞",
        "question": "You can find the information (that) you need online. You can find the information (that [which]) you need online. → You can find the information (that [which]) you need    .online."
    },
    {
        "id": "192-2",
        "ja": "ヨーロッパにはいつか訪れたい国がたくさんある。",
        "en": "There are {many countries} in Europe {I would like to visit} someday. There are{ many countries} in Europe. ＋ I would like to visit them someday.",
        "answer": "many countries, I would like to visit, many countries",
        "explanation": "F 114 ▶ 目的格の関係代名詞は省略することが多い。… many countries in Europe (that [which]) I would like …。many countriesを先行詞とする関係代名詞that [which]が省略されている。in EuropeがcountriesとIの間に挿入されている。",
        "question": "There are many countries in Europe I would like to visit someday. → There are many countries in Europe (that [which]) I would like to visit    ."
    },
    {
        "id": "193-1",
        "ja": "お兄さんがオーストラリアに留学している友達がいる。",
        "en": "I have {a friend whose brother} is studying in Australia. I have{ a friend}. ＋ His [Her] brother is studying in Australia. → I have {a friend} {whose} brother is studying in Australia.",
        "answer": "a friend whose brother, a friend, a friend, whose",
        "explanation": "F 115 ▶ 所有格の関係代名詞は，先行詞が所有するものについて情報を加える場合に使う。先行詞が人か人以外かにかかわらずwhoseを使い，whose＋名詞の形にする。\n▶ 問題文は人(a friend)が先行詞。his [her] brotherがwhose brotherになる。",
        "question": "I have (    ) (    ) (    ) (    ) is studying in Australia."
    },
    {
        "id": "193-2",
        "ja": "田舎では，戸が開いている家をよく見かける。",
        "en": "In the countryside, it is common to see {houses whose doors} are open. It is common to see {houses}. ＋ Their doors are open. → It is common to see {houses} {whose} doors are open.",
        "answer": "houses whose doors, houses, houses, whose",
        "explanation": "F 115 ▶ 先行詞が人以外の場合でもwhoseを使う。➡ 193-1\n＝ It is common to see houses with open doors.\n▶ 問題文は，their doors(それらの戸[その家々の戸])だったものがwhose doorsとな",
        "question": "In the countryside, it is common to see (    ) (    ) (    ) are open."
    },
    {
        "id": "194-1",
        "ja": "君がノートパソコンを持ち運ぶバッグはどこ？ ただし，もとになる文を考えたとき，you carry your laptop    the bagでは何か が足りていない。",
        "en": "Where is the bag {in which} you carry your laptop? Where is{ the bag}? ＋ You carry your laptop in it. → Where is{ the bag} {in }{which} you carry your laptop .",
        "answer": "in which, the bag, the bag, in, which",
        "explanation": "Tip 「バッグ(先行詞)」と「君がノートパソコンを持ち運ぶ」を関係代名詞でつなぐ。\n▶ 関係代名詞が前置詞(in)の目的語になっている。問題文は，前置詞と関係代名詞をセットで前に置いた形。セットで置く場合，関係代名詞を省略することはできず，thatは使えない。２つめの文は関係代名詞を省略することも，thatを使うことも可能。\n▶ 問題文は，carry your laptop in itのin itがin whichとなり，それが先行詞the bagの直後に置かれている。前置詞を文末に残した２文めよりも硬い表現。",
        "question": "Where is the bag in which you carry your laptop? ＝Where is the bag (that [which]) you carry your laptop in?"
    },
    {
        "id": "194-2",
        "ja": "私にはいつでも頼れる友達がいる。",
        "en": "I have {a friend}. ＋ I can always count on him [her].",
        "answer": "a friend",
        "explanation": "Tip 「友達(先行詞)」と「私がいつも頼りにしている」を関係代名詞でつなぐ。\nF 117 ▶ 関係代名詞が前置詞(on)の目的語になっており，前置詞が後ろに残っている。count on A「Aを頼りにする」などの句動詞はそのまとまりで意味を持つので，前置詞を切り離さず後ろに残す。「人」が先行詞なのでwhoが好まれる。\n▶ 問題文は，count on him [her]のhim [her]がwho/whomまたはthatとなり，それが先行詞a friendの直後に置かれている。目的格なので省略可。",
        "question": "I have a friend (    ) (    ) (    ) always (c   ) (    ). I have a friend who(m) I can always count on. → I have a friend (who(m) [that]) I can always count on     ."
    },
    {
        "id": "195-1",
        "ja": "看護師である私の兄は，市立病院に勤務しています。",
        "en": "My brother{, }{who is a nurse,} works at the city hospital.",
        "answer": ",, who is a nurse,",
        "explanation": "F 119 ▶ 191から194で学んだ，名詞を修飾する用法を関係詞の限定用法と呼ぶ。195と196で学ぶのは追加の説明を加える用法で，これを関係詞の非限定用法と呼ぶ。非限定用法では関係詞の前にコンマを置く。➡ Grasp 13―p.104\n▶「私の兄」というすでに限定されている情報について追加の説明を加えるので，限定用法ではなく非限定用法の関係詞を使う。人(My brother)が先行詞の場合，非限定用法の関係代名詞は，主格の場合はwho，目的格の場合はwho(m)を使う。whomは硬い表現。",
        "question": "My brother, who is a nurse, works at the city hospital."
    },
    {
        "id": "195-2",
        "ja": "法？ ！ 非限定用法がある関係代名詞は，who, whom, which, whose。",
        "en": "Everyone needs medical care{, which is} a basic human right.",
        "answer": ", which is",
        "explanation": "▶ 関係代名詞の非限定用法。➡ 195-1　人以外(medical care)が先行詞の場合，非限定用法の関係代名詞はwhichを使う。",
        "question": "Everyone needs medical care , which is a basic human right."
    },
    {
        "id": "196",
        "ja": "多くの子どもがスマートフォンを使い過ぎており，そのことは彼らの健康に悪影響を及 ぼすことがある。",
        "en": "Many children use their smartphones too much{, }{which can have} a",
        "answer": ",, which can have",
        "explanation": "Tip  Many children ～ too muchという文について追加の説明を加えるには？\nnegative impact on their health.\n▶ 関係代名詞whichの非限定用法には，先行する主節の内容について追加の説明をし，「そしてそのことは～」を意味する用法もある。Many children ～ too muchまでの文全体が先行詞にあたる。",
        "question": "Many children use their smartphones too much, (    ) (    ) (    ) a negative impact on their health."
    },
    {
        "id": "197",
        "ja": "彼は電話に出ないかもしれないので，その場合はメッセージを残してください。",
        "en": "He may not answer the phone, {in which case} just leave a message.",
        "answer": "in which case",
        "explanation": "▶ in which caseで「そしてその場合は(＝and in that case,)」を意味する。このwhich",
        "question": "He may not answer the phone, (    ) (    ) (    ) just leave a message."
    },
    {
        "id": "198",
        "ja": "男性が地図を持って観光客のグループに道案内をしており，観光客は全員，熱心に聞い ている。",
        "en": "{all of whom} are listening intently.",
        "answer": "all of whom",
        "explanation": "Tip 「～，そして彼ら(観光客)は全員…」を表す，関係代名詞を使った表現は？\n▶〈～, whom …〉のwhomの前にall ofがついた形。先行詞はa group of tourists。",
        "question": "(    ) (    ) (    ) are listening intently. A man is holding a map and giving directions to a group of tourists,"
    },
    {
        "id": "199",
        "ja": "私たちは2つの解決策を試したが，どちらもうまくいかなかった。",
        "en": "We tried two solutions, {neither of which} worked. ～{, neither of whom} …",
        "answer": "neither of which, , neither of whom",
        "explanation": "▶〈～, which …〉のwhichの前にneither ofがついた形。先行詞はtwo solutions。\n▶ 先行詞が人の場合はwhomを，人以外の場合はwhichを使う。",
        "question": "We tried two solutions, (    ) (    ) (    ) worked."
    },
    {
        "id": "200-1",
        "ja": "人々が安心して暮らせる社会をつくらなければならない。",
        "en": "We have to create a{ society where} people can live in peace. We have to create {a society}.＋ People can live in peace there [＝in the society]. → We have to create {a society }{where} people can live in peace . ＝ We have to create {a society }{in which} people can live in peace .",
        "answer": "society where, a society, a society, where, a society, in which",
        "explanation": "F 121 ▶ 関係副詞は節の中で副詞の働きをしている。関係副詞whereは場所を表す先行詞を修飾する。➡ Grasp 14",
        "question": "We have to create a (s   ) (    ) people can live in peace."
    },
    {
        "id": "200-2",
        "ja": "あれが昨日，この靴を購入した店だ。",
        "en": "That’s the {store [shop] at which} I bought these shoes yesterday. ➡ {Grasp 14} That’s {the store}. ＋ I bought these shoes there [＝at the store] yesterday. → That’s {the store} {where} I bought these shoes yesterday. ＝ That’s {the store} {at which} I bought these shoes yesterday.",
        "answer": "store [shop] at which, Grasp 14, the store, the store, where, the store, at which",
        "explanation": "Tip 「店で」この靴を購入したということなので関係副詞whereを使って表せるが，\n▶ 場所が先行詞の場合，前置詞＋whichで関係副詞whereと同じ働きをする。",
        "question": "That’s the (    ) (    ) (    ) I bought these shoes yesterday."
    },
    {
        "id": "201",
        "ja": "彼女は私たちが座っている所へ走って来た。",
        "en": "She came running to {where we were sitting}.",
        "answer": "where we were sitting",
        "explanation": "Tip  the place「所」は，関係副詞の先行詞のとき，省略できる？ できない？\nF 121 ▶ 関係副詞whereは先行詞を省略して使うこともある(the placeの省略)。先行詞にthe placeを使うときは，関係副詞whereのほうを省略することもできる。",
        "question": "She came running to (    ) (    ) (    ) (    ). ＝ She came running to the place (where) we were sitting."
    },
    {
        "id": "202",
        "ja": "行ったことのない国を訪れたい。",
        "en": "I want to visit a{ country that [which]} I have never been to. ＝I want to visit {a country} {where }I have never been .",
        "answer": "country that [which], a country, where",
        "explanation": "Tip 「国(先行詞)」と「私が行ったことのない」を関係詞でつなぐ。後半がhave never\n▶ 先行詞が場所を表す語だからといって関係副詞whereを使うとは限らない。\n↑ I have never been to the country\n↑ I have never been there\n▶ × I have never been to thereではなく，○ I have never been to the countryとい",
        "question": "I want to visit a (    ) (    ) I have never been to. I want to visit a country (that [which]) I have never been to       ."
    },
    {
        "id": "203",
        "ja": "私たちは正解のない時代に生きている。",
        "en": "We live in an {age when} there are no right answers. We live in {an age}. ＋ There are no right answers in this age. → We live in {an age} {when} there are no right answers . ＝ We live in {an age} {in which} there are no right answers .",
        "answer": "age when, an age, an age, when, an age, in which",
        "explanation": "F 122 ▶ 関係副詞whenは時を表す先行詞を修飾する。",
        "question": "We live in an (    ) (    ) there are no right answers."
    },
    {
        "id": "204-1",
        "ja": "サッカーがそれほど多くの国で人気があるのには十分な理由がある。",
        "en": "There are {good reasons why} soccer is popular in so many countries. There are {good} {reasons}. ＋ Soccer is popular in so many countries for the reasons. → There are {good} {reasons} {why} soccer is popular in so many countries ? ＝ There are {good} {reasons} {for which} soccer is popular in so many countries",
        "answer": "good reasons why, good, reasons, good, reasons, why, good, reasons, for which",
        "explanation": "F 123 ▶ 関係副詞whyはreason(s)を先行詞とし，理由を表す節を導く。\n?",
        "question": "There are (    ) (r   ) (    ) soccer is popular in so many countries."
    },
    {
        "id": "204-2",
        "ja": "サラは毎朝，オンライン英会話のレッスンを受けている。",
        "en": "{That’s why} she is able to communicate fluently with foreign tourists.",
        "answer": "That’s why",
        "explanation": "Tip 「それで → そういうわけで」を関係副詞を使って表すと？\n▶ That’s (the reason) why …「それが…の理由だ」のthe reasonが省略された形。",
        "question": "Sara takes online English conversation lessons every morning. (    ) (    ) she is able to communicate fluently with foreign tourists. Sara takes online English conversation lessons every morning."
    },
    {
        "id": "205-1",
        "ja": "文化の違いにより，人々のあいさつの仕方に違いがある。",
        "en": "There are differences in {how people greet} each other in different ＝ There are differences in {the way} people greet each other in different cultures. ＝ There are differences in {the way in which} people greet each other in different cultures.",
        "answer": "how people greet, the way, the way in which",
        "explanation": "Tip 「人々のあいさつの仕方＝人々があいさつを交わす方法」。\ncultures.\n▶ 関係副詞howは先行詞なしで使われ，「…する方法，…するやり方」という意味の名詞節を導く。＝the way (in which)",
        "question": "There are differences in (    ) (p   ) (g   ) each other in different cultures."
    },
    {
        "id": "205-2",
        "ja": "誕生日には，みんなで特別な夕食をとる。",
        "en": "On birthdays, we have a special dinner together. {This is how} we",
        "answer": "This is how",
        "explanation": "Tip 「これが我が家の…の祝い方だ → このようにして私たちは家族で…を祝う」\ncelebrate them in our family.",
        "question": "On birthdays, we have a special dinner together. (    ) (    ) (    ) we celebrate them in our family."
    },
    {
        "id": "206",
        "ja": "ケンはカフェ・ココで働いているのだが，そこはおいしいコーヒーをいれる。",
        "en": "Ken works at Café Coco{, where they} make great coffee. Ken works {at Café Coco}. ＋ They make great coffee there [＝at Café Coco]. → Ken works {at Café Coco}{, where} they make great coffee .",
        "answer": ", where they, at Café Coco, at Café Coco, , where",
        "explanation": "Tip 「カフェで」に追加の説明を加えるとき，at Café Cocoの代わりをする関係副詞\nF 125 ▶ 関係代名詞に非限定用法があるように，関係副詞にも非限定用法がある。",
        "question": "Ken works at Café Coco, where they make great coffee."
    },
    {
        "id": "207",
        "ja": "私たちは2021年に愛犬のレオを迎え，その年は三重に引っ越してきた年だった。",
        "en": "We adopted our dog Leo in 2021, {when we} moved to Mie. We adopted our dog Leo {in 2021}. ＋ We moved to Mie then [＝in 2021]. → We adopted our dog Leo {in 2021}{, when} we moved to Mie .",
        "answer": "when we, in 2021, in 2021, , when",
        "explanation": "Tip 「2021年に」に追加の説明を加えるとき，in 2021の代わりをする関係副詞は？\nF 125 ▶ 時を表す語句(in 2021)が先行詞の場合，非限定用法の関係副詞はwhenを使う。",
        "question": "We adopted our dog Leo in 2021, (    ) (    ) moved to Mie."
    },
    {
        "id": "208-1",
        "ja": "重要なのは，すべての子どもたちに質の高い教育を提供することだ。",
        "en": "{What matters} is providing quality education for all children.",
        "answer": "What matters",
        "explanation": "F 118 ▶ 関係代名詞のwhatは「～すること，～するもの」を表す。whatは先行詞を含んでいるので，先行詞なしで使う。the thing(s) that [which]で書きかえられる場合が多い。whatが導く節は名詞節だから，文全体の中で主語・目的語・補語・前置詞の目的語になる。関係代名詞what自体は名詞として扱われ，節の中で主語・目的語・補語・前置詞の目的語の働きをする。\n▶ 文の中でwhat節が主語，節の中でもwhatは主語(what matters)。",
        "question": "(    ) (    ) is providing quality education for all children."
    },
    {
        "id": "208-2",
        "ja": "探しているものをネットで見つけるのは簡単だ。",
        "en": "It is easy to find {what you are looking for} online.",
        "answer": "what you are looking for",
        "explanation": "Tip 「あなたが探しているもの」という名詞節を，関係代名詞を使って表す。\nF 118 ▶ 文の中でwhat節はfindの目的語，節の中ではwhatは前置詞forの目的語",
        "question": "It is easy to find what you are looking for online. (you are looking for what)。➡ 208-1"
    },
    {
        "id": "208-3",
        "ja": "君が言ったことをずっと考えている。",
        "en": "I’ve been thinking about {what you said}.",
        "answer": "what you said",
        "explanation": "Tip 「君が言ったこと」という名詞節を，関係代名詞を使って表す。\n▶ 文の中でwhat節は前置詞aboutの目的語，節の中でwhatはsaidの目的語",
        "question": "I’ve been thinking about what you said. (you said what)。➡ 208-1"
    },
    {
        "id": "209",
        "ja": "持っていたわずかなお金で，友達にささやかなプレゼントを買った。",
        "en": "I bought a small gift for my friend with {what little money I had}.",
        "answer": "what little money I had",
        "explanation": "▶ このwhatは関係形容詞。後に名詞Aがきて，その後にS’＋V’またはV’を置く。",
        "question": "I bought a small gift for my friend with ( money / I / little / had / what )."
    },
    {
        "id": "210-1",
        "ja": "厳しいと思っていた先生がいたのだが，親切な先生だとわかった。",
        "en": "There was a teacher {who I thought} was strict, but he turned out to be There was{ a teacher}. ＋ {I thought} he was strict.",
        "answer": "who I thought, a teacher, I thought",
        "explanation": "Tip 「厳しいと(私が)思っていた先生」の下線部にあたる語句を挿入する。\nfriendly.\n▶ 関係代名詞の直後にI think, I believe, I supposeなどが続く場合がある。",
        "question": "There was a teacher (    ) (    ) (t   ) was strict, but he turned out to be friendly. → There was a teacher (who) I thought       was strict."
    },
    {
        "id": "210-2",
        "ja": "人の話を聞くのは大切だが，最後は，自分がいちばんいいと思うことをやるしかない。",
        "en": "{what you think} is best.",
        "answer": "what you think",
        "explanation": "Tip 「自分がいちばんいいと思うこと」の下線部にあたる語句を挿入する。",
        "question": "It is important to listen to others, but in the end, you have to do Whaty   othink is best. It is important to listen to others, but in the end, you have to do"
    },
    {
        "id": "211-1",
        "ja": "皆さんの応援があったからこそ，今の私があるのだと思います。",
        "en": "Thanks to your support, I’ve become {what I am} today.",
        "answer": "what I am",
        "explanation": "Tip 「今の私 → 今日の私であるもの」。「今」なのでbe動詞の時制は？\n▶ 関係詞節の中でwhatは補語の働きをしている。",
        "question": "Thanks to your support, I’ve become (    ) (    ) (    ) today."
    },
    {
        "id": "211-2",
        "ja": "今日の日本は30年前とは違う。",
        "en": "Japan today is not {what it was} thirty years ago. {what }S{ was }[{were}]",
        "answer": "what it was, what, was, were",
        "explanation": "Tip 「30年前とは違う → 30年前の日本(の姿)ではない」と表現する。",
        "question": "Japan today is not (w   ) (    ) (    ) thirty years ago."
    },
    {
        "id": "212",
        "ja": "私たちはいわゆる情報化時代に生きている。",
        "en": "We live in {what is called }the Information Age. {what is called }A",
        "answer": "what is called, what is called",
        "explanation": "Tip 「いわゆる情報化時代」は「情報化時代と呼ばれるもの」と表現する。",
        "question": "We live in (    ) (    ) (    ) the Information Age."
    },
    {
        "id": "213-1",
        "ja": "本を読むのが好きだが，それは本が私を楽しませ，しかも新しいことを学べるからだ。",
        "en": "I like reading books because they entertain me, and {what is more}, I can learn new things.",
        "answer": "what is more",
        "explanation": "Tip 「しかも → その上，さらに」。moreoverやbesidesと同じ意味を表す表現。",
        "question": "I like reading books because they entertain me, and (    ) (    ) (    ), I can learn new things."
    },
    {
        "id": "213-2",
        "ja": "私は映画に遅れてしまい，さらに悪いことに，財布を家に忘れてきた。",
        "en": "I was late for the movie, and {what was worse}, I had left my wallet at home.",
        "answer": "what was worse",
        "explanation": "Tip  bad「悪い」の比較級を使った表現。時制に注意する。\n▶ 主節の動詞が過去形なのでwhat was worseとなる。副詞句として副詞の働きをする。文と文をつなぐことはできないので，つなぐときはandが必要。",
        "question": "I was late for the movie, and (    ) (    ) (    ), I had left my wallet at home."
    },
    {
        "id": "214",
        "ja": "ケンにはよくあることだが，彼はミーティングに遅刻した。",
        "en": "Ken was late for the meeting, {as is often the case with} him. ＝ {As is }[{was}]{ often the case with} him, Ken was late for the meeting.",
        "answer": "as is often the case with, As is, was, often the case with",
        "explanation": "▶ 関係代名詞asの非限定用法。「…だが，…のように」を意味する。先行詞は主節の内容。先行詞が後にくることもある。",
        "question": "Ken was late for the meeting, ( with / the / often / case / is / as ) him."
    },
    {
        "id": "215",
        "ja": "ソーシャルメディアはあなたと同じ趣味を持つ人を見つけるのに役立つ。",
        "en": "Social media can help you find people who have {the}e same hobbies",
        "answer": "the",
        "explanation": "Tip  関係代名詞のasを使った表現。asの後にS’(＋V’)を続ける。\n▶ 関係代名詞asの限定用法。先行詞はthe same A。",
        "question": "Social media can help you find people who have the same hobbies as you (do)."
    },
    {
        "id": "216",
        "ja": "今，私たちが保護できないほど多くの，絶滅の危機に瀕した動物がいる。",
        "en": "There are {more endangered animals} {than we can protect} now.",
        "answer": "more endangered animals, than we can protect",
        "explanation": "Tip 「保護できないほど多くの＝保護できるよりも多くの～」と表現する。\n▶ thanを関係代名詞的に使う。more Aが先行詞にあたる。",
        "question": "There are ( endangered animals / protect / than / we / more / can )"
    },
    {
        "id": "217",
        "ja": "地域で助けを必要としている人は誰でも助けることが大切だ。",
        "en": "It is important to help {whoever is in need} in our community.",
        "answer": "whoever is in need",
        "explanation": "Tip 「～する人は誰でも」を，先行詞を含む関係代名詞で表すと？\nF 126 ▶ 関係代名詞に-everが付いたwhoever, whatever, whicheverを複合関係代名詞と呼ぶ。anyoneやanythingなどの先行詞を含む表現。➡ File 30―p.114\n▶ 名詞節を導くwhoever。whoever以下が動詞helpの目的語になっている。whoeverは単数扱いする。",
        "question": "It is important to help (    ) (i   ) (    ) (    ) in our community."
    },
    {
        "id": "218-1",
        "ja": "一人旅では，したいことが何でもできる。",
        "en": "When you travel alone, you can do {whatever you want}.",
        "answer": "whatever you want",
        "explanation": "Tip 「したいことが何でも → 望むことは何でも」\n▶ 名詞節を導くwhatever。whatever以下が動詞doの目的語。",
        "question": "When you travel alone, you can do (    ) (    ) (w   )."
    },
    {
        "id": "218-2",
        "ja": "何があっても，ずっと君の味方でいるよ。",
        "en": "I’ll always be there for you, {whatever happens}.",
        "answer": "whatever happens",
        "explanation": "Tip  先行詞を含む関係代名詞を使って「何が起こっても」を表す副詞節をつくる。\n▶ 副詞節を導くwhatever。whatever以下は主節を修飾する副詞節。whateverは単数扱いする。",
        "question": "I’ll always be there for you, (    ) (h   )."
    },
    {
        "id": "218-3",
        "ja": "誰が何と言おうと，私は決してあきらめない。",
        "en": "I’ll never give up, {no matter what anyone says}.",
        "answer": "no matter what anyone says",
        "explanation": "Tip  副詞節を導くwhateverと同じ意味を表す表現を使ってみよう。\n▶ 副詞節を導くno matter what …は，whateverと同じ意味を表す。",
        "question": "I’ll never give up, (n   ) (    ) (    ) (a   ) (s   )."
    },
    {
        "id": "219",
        "ja": "君がどちらのルートをとっても，30分かかるだろう。",
        "en": "{Whichever route you take}, it will take you 30 minutes.",
        "answer": "Whichever route you take",
        "explanation": "Tip 〈複合関係形容詞＋名詞〉を使って副詞節をつくる。\n▶ 副詞節を導くwhichever。ここでは名詞routeを修飾する複合関係形容詞。",
        "question": "(W   ) (r   ) (    ) (    ), it will take you 30 minutes."
    },
    {
        "id": "220",
        "ja": "リラックスしたい時はいつも好きな音楽を聴く。",
        "en": "I listen to my favorite music {whenever I want to} relax.",
        "answer": "whenever I want to",
        "explanation": "Tip 「…する時はいつでも」を表す複合関係副詞を使って副詞節をつくる。\nF 128 ▶ 関係副詞に-everが付いたwhenever, wherever, howeverを複合関係副詞と呼ぶ。副詞節を導く。➡ File 31\n▶ wheneverは副詞節を導く。",
        "question": "I listen to my favorite music (    ) (    ) (    ) (    ) relax."
    },
    {
        "id": "221-1",
        "ja": "スマートフォンはとても軽いので，どこへ行くにも持ち運べる。",
        "en": "You can take a smartphone with you {wherever you go} because it is very",
        "answer": "wherever you go",
        "explanation": "Tip 「…する所はどこへでも」を表す複合関係副詞を使って副詞節をつくる。\nlight.\n▶ whereverは副詞節を導く。この文では「…する所はどこへでも」の意味。",
        "question": "You can take a smartphone with you (w   ) (    ) (    ) because it is very light."
    },
    {
        "id": "221-2",
        "ja": "日本のどこへ行っても，お寺や神社が見つかるでしょう。",
        "en": "{Wherever you go in Japan}, you will find temples and shrines.",
        "answer": "Wherever you go in Japan",
        "explanation": "Tip 「どこへ…しようとも」を表す複合関係副詞を使って副詞節をつくる。\nF 129 ▶ whereverは副詞節を導く。この文では「どこへ…しようとも」の意味。➡ 221-1",
        "question": "(W   ) (    ) (    ) (i   ) (    ), you will find temples and shrines."
    },
    {
        "id": "222-1",
        "ja": "どんなに時間がかかっても，私たちはその問題を解決しなければならない。",
        "en": "{However long it takes}, we have to solve the problem.",
        "answer": "However long it takes",
        "explanation": "Tip 「どんなに…でも」を表す複合関係副詞を使って副詞節をつくる。\n▶ howeverは副詞節を導き，譲歩の意味を表す。× However it takes long,",
        "question": "(    ) (l   ) (    ) (    ), we have to solve the problem."
    },
    {
        "id": "222-2",
        "ja": "どんなに頑張っても，この数学の問題は解けそうにない。",
        "en": "{No matter how hard I try}, I can’t seem to solve this math problem. ＝{However hard I try}, I can’t seem to solve this math problem.",
        "answer": "No matter how hard I try, However hard I try",
        "explanation": "Tip  副詞節を導くhoweverと同じ意味を表す表現を使ってみよう。\n▶ no matter howは副詞節を導き，譲歩の意味を表す。",
        "question": "(N   ) (    ) (    ) (h   ) (    ) (t   ), I can’t seem to solve this math problem."
    }
];

        // --- App State ---
        let activeSentenceElement = null;
        let selectedSentences = new Set();
        let SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition;
        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.lang = 'en-US';
            recognition.interimResults = false;
        }

        // --- Voice Synthesis Setup ---
        let synthesisVoice = null;

        function setSynthesisVoice() {
            const voices = speechSynthesis.getVoices();
            // 優先順位: Google US English -> Microsoft Zira/David -> その他英語
            synthesisVoice = voices.find(voice => voice.name === 'Google US English') ||
                voices.find(voice => voice.name.includes('Google') && voice.lang.includes('en-US')) ||
                voices.find(voice => voice.name.includes('Microsoft') && voice.lang.includes('en-US')) ||
                voices.find(voice => voice.lang === 'en-US') ||
                voices.find(voice => voice.lang.startsWith('en'));
        }

        // 音声リストがロードされたら設定を実行
        if (speechSynthesis.onvoiceschanged !== undefined) {
            speechSynthesis.onvoiceschanged = setSynthesisVoice;
        }
        // 初期化時にも実行
        setSynthesisVoice();


        // --- DOM Elements ---
        const sentenceList = document.getElementById('sentence-list');
        const toggleAnswerBtn = document.getElementById('toggle-answer-btn');
        const playSoundBtn = document.getElementById('play-sound-btn');
        const recordBtn = document.getElementById('record-btn');
        const toggleExplanationBtn = document.getElementById('toggle-explanation-btn');
        const startQuizBtn = document.getElementById('start-quiz-btn');
        const messageModal = document.getElementById('message-modal');
        const messageContent = document.getElementById('message-content');
        const quizModal = document.getElementById('quiz-modal');
        const closeQuizBtn = document.getElementById('close-quiz-btn');
        const quizContent = document.getElementById('quiz-content');

        const selectAllCheckbox = document.getElementById('select-all-checkbox');
        const pdfModal = document.getElementById('pdf-modal');
        const openPdfModalBtn = document.getElementById('open-pdf-modal-btn');
        const closeModalBtn = document.getElementById('close-modal-btn');


        // --- Functions ---

        /**
         * Parses the English sentence template and creates the HTML structure.
         */
        function formatEnglishSentence(enTemplate, answer) {
            const blank = '__________';
            const answerHtml = `<span class="answer-span">${answer}</span>`;
            const underlineHtml = `<span class="underline-span">${blank}</span>`;
            const formattedSentence = enTemplate.replace(`{${answer}}`, `${answerHtml}${underlineHtml}`);
            return formattedSentence;
        }

        /**
         * Renders all sentences for the chapter.
         */
        function renderChapter() {
            sentenceList.innerHTML = '';
            chapterData.forEach(item => {
                const sentenceDiv = document.createElement('div');
                sentenceDiv.className = 'sentence-item p-4 border border-gray-200 rounded-lg bg-white transition-shadow duration-300 hover:shadow-md cursor-pointer';
                sentenceDiv.dataset.id = item.id;
                sentenceDiv.dataset.fullSentence = item.en.replace(`{${item.answer}}`, item.answer);

                const englishSentenceHtml = formatEnglishSentence(item.en, item.answer);

                sentenceDiv.innerHTML = `
                    <div class="flex items-start space-x-4">
                         <div class="flex items-center pt-1" onclick="event.stopPropagation()">
                            <input type="checkbox" class="sentence-checkbox h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500" data-id="${item.id}">
                        </div>
                        <span class="text-lg font-bold text-gray-500 w-10 shrink-0 pt-1">${item.id}</span>
                        <div class="flex-1">
                            <p class="mb-2 text-gray-700">${item.ja}</p>
                            <p class="font-english">${englishSentenceHtml}</p>
                            <div class="explanation mt-4 p-4 bg-yellow-100 border-l-4 border-yellow-400 text-gray-700 rounded-r-lg">
                                ${item.explanation}
                            </div>
                        </div>
                    </div>
                `;
                sentenceList.appendChild(sentenceDiv);
            });

            // Add click listener to each sentence item
            document.querySelectorAll('.sentence-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    // Don't select if clicking inside explanation
                    if (e.target.closest('.explanation')) return;
                    if (e.target.closest('.sentence-checkbox')) return; // Checkbox click is handled separately

                    if (activeSentenceElement) {
                        activeSentenceElement.classList.remove('ring-2', 'ring-blue-400', 'shadow-xl');
                    }
                    activeSentenceElement = item;
                    activeSentenceElement.classList.add('ring-2', 'ring-blue-400', 'shadow-xl');
                });
            });

            // Checkbox logic
            document.querySelectorAll('.sentence-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    const id = e.target.dataset.id;
                    if (e.target.checked) {
                        selectedSentences.add(id);
                    } else {
                        selectedSentences.delete(id);
                    }
                });
            });

            // Select the first sentence by default
            if (sentenceList.firstChild) {
                sentenceList.firstChild.click();
            }
        }

        // --- PDF / Print Logic ---

        function openPrintWindow(bodyContent, title) {
            const htmlContent = `
                <!DOCTYPE html>
                <html lang="ja">
                <head>
                    <meta charset="UTF-8">
                    <title>Insight App - Chapter 8</title>
                    <style>
                        body { font-family: "Hiragino Kaku Gothic ProN", "Meiryo", sans-serif; line-height: 1.8; margin: 25px; color: #333; }
                        @media print { .no-print { display: none; } }
                        h1, h2 { text-align: center; border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 25px; }
                        ol, ul { list-style-position: inside; padding-left: 0; }
                        li { margin-bottom: 15px; }
                        .list-container { 
                            column-count: 2; 
                            column-gap: 40px; 
                        }
                        .list-container li, .list-container p { 
                            -webkit-column-break-inside: avoid; 
                            page-break-inside: avoid; 
                            break-inside: avoid; 
                        }
                        ol li {
                            list-style-type: decimal;
                            margin-left: 1.5em; 
                        }
                        .inline-content {
                            display: inline;
                        }
                        @media (max-width: 700px) { .list-container { column-count: 1; } }
                        .answer-key { page-break-before: always; margin-top: 50px; }
                        u { text-decoration: underline; text-underline-offset: 3px; }
                    </style>
                </head>
                <body>
                    <h1>${title}</h1>
                    <p class="no-print" style="text-align:center; margin-bottom: 20px; font-size: 0.9em; color: #666;">
                        ※印刷ダイアログが表示されない場合は、Ctrl+P (または Cmd+P) を押してください。
                    </p>
                    ${bodyContent}
                </body>
                </html>
            `;
            const printWindow = window.open('', '_blank');
            if (!printWindow) {
                showMessage('<p>ポップアップがブロックされました。設定を確認してください。</p>', 5000);
                return;
            }
            printWindow.document.write(htmlContent);
            printWindow.document.close();
            setTimeout(() => {
                printWindow.focus();
                printWindow.print();
            }, 250);
        }

        function getSelectedItems() {
            if (selectedSentences.size === 0) {
                showMessage('<p>PDFを作成する問題を選択してください。</p>', 3000);
                return null;
            }
            // Sort items based on ID
            return Array.from(selectedSentences)
                .map(id => chapterData.find(item => item.id === id))
                .filter(Boolean)
                .sort((a, b) => {
                    // Handle IDs like "1382-1" vs "1382-2"
                    const aParts = a.id.split('-').map(s => parseInt(s) || 0);
                    const bParts = b.id.split('-').map(s => parseInt(s) || 0);
                    if (aParts[0] !== bParts[0]) return aParts[0] - bParts[0];
                    return (aParts[1] || 0) - (bParts[1] || 0);
                });
        }

        function getUniqueItems(items) {
            const uniqueMap = new Map();
            items.forEach(item => {
                // Use answer as key to deduplicate same phrases
                if (!uniqueMap.has(item.answer)) {
                    uniqueMap.set(item.answer, item);
                }
            });
            return Array.from(uniqueMap.values()).sort((a, b) => {
                const aId = parseInt(a.id.split('-')[0]);
                const bId = parseInt(b.id.split('-')[0]);
                return aId - bId;
            });
        }


        // --- Message & Sound Functions ---

        function showMessage(htmlContent, duration = null) {
            messageContent.innerHTML = htmlContent;
            messageModal.classList.remove('hidden');
            if (duration) {
                setTimeout(() => {
                    messageModal.classList.add('hidden');
                }, duration);
            }
        }

        function playSound() {
            if (!activeSentenceElement) {
                showMessage('<p>文を選択してください。</p>', 2000);
                return;
            }

            // 音声が未設定なら再取得を試みる
            if (!synthesisVoice) {
                setSynthesisVoice();
            }

            // 連続再生を防ぐために一度キャンセル
            speechSynthesis.cancel();

            let textToSpeak = activeSentenceElement.dataset.fullSentence;
            // 念のため不要な記号を除去
            textToSpeak = textToSpeak.replace(/[{}]/g, '');

            const utterance = new SpeechSynthesisUtterance(textToSpeak);
            utterance.lang = 'en-US';

            // 英語音声が取得できていれば設定
            if (synthesisVoice) {
                utterance.voice = synthesisVoice;
            }

            utterance.rate = 1.0;
            utterance.pitch = 1.0;

            speechSynthesis.speak(utterance);
        }

        function handleRecording() {
            if (!activeSentenceElement) {
                showMessage('<p>文を選択してください。</p>', 2000);
                return;
            }
            if (!SpeechRecognition) {
                showMessage('<p>お使いのブラウザは音声認識に対応していません。</p>', 3000);
                return;
            }

            showMessage('<p class="text-2xl">マイクに向かって話してください...</p><div class="animate-pulse text-red-500 text-4xl mt-4">●</div>');

            recognition.start();

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                evaluatePronunciation(transcript);
            };

            recognition.onerror = (event) => {
                showMessage(`<p>エラーが発生しました: ${event.error}</p>`, 3000);
            };

            recognition.onend = () => {
                if (messageModal.classList.contains('hidden') === false && messageContent.innerHTML.includes('マイクに')) {
                    messageModal.classList.add('hidden');
                }
            };
        }

        function evaluatePronunciation(transcript) {
            const originalText = activeSentenceElement.dataset.fullSentence;

            const cleanOrig = originalText.toLowerCase().replace(/[^\w\s]/g, '').split(' ');
            const cleanTrans = transcript.toLowerCase().replace(/[^\w\s]/g, '').split(' ');

            let matches = 0;
            cleanOrig.forEach(word => {
                if (cleanTrans.includes(word)) {
                    matches++;
                }
            });

            const similarity = matches / cleanOrig.length;

            let score;
            if (similarity > 0.9) {
                score = 95 + Math.floor(Math.random() * 5);
            } else if (similarity > 0.7) {
                score = 90 + Math.floor(Math.random() * 6);
            } else if (similarity > 0.5) {
                score = 85 + Math.floor(Math.random() * 5);
            } else if (similarity > 0.3) {
                score = 80 + Math.floor(Math.random() * 5);
            } else {
                score = 70 + Math.floor(Math.random() * 10);
            }

            if (score === 100 && Math.random() < 0.3) score = 99;

            const messageHtml = `
                <h3 class="text-2xl font-bold mb-4">評価結果</h3>
                <p class="text-7xl font-bold text-blue-600 mb-4">${score}<span class="text-2xl">点</span></p>
                <p class="text-gray-600 mb-2"><strong>あなたの発音:</strong> ${transcript}</p>
                <p class="text-gray-600"><strong>元の文:</strong> ${originalText}</p>
                <button onclick="document.getElementById('message-modal').classList.add('hidden')" class="mt-6 bg-blue-500 text-white py-2 px-6 rounded-lg">閉じる</button>
            `;
            showMessage(messageHtml);
        }

        // --- Quiz Functions ---

        function startQuiz() {
            if (chapterData.length < 10) {
                showMessage('<p>クイズを作成するには、文が10個以上必要です。</p>', 3000);
                return;
            }

            const shuffled = [...chapterData].sort(() => 0.5 - Math.random());
            const questions = shuffled.slice(0, 10);

            let currentQuestionIndex = 0;
            let score = 0;

            function showQuestion() {
                if (currentQuestionIndex >= questions.length) {
                    showQuizResult();
                    return;
                }

                const question = questions[currentQuestionIndex];
                const correctAnswer = question.answer;

                const incorrectAnswers = chapterData
                    .filter(item => item.answer !== correctAnswer)
                    .sort(() => 0.5 - Math.random())
                    .slice(0, 3)
                    .map(item => item.answer);

                const options = [correctAnswer, ...incorrectAnswers].sort(() => 0.5 - Math.random());

                // Use regex to replace ALL {answer} parts with (______)
                const questionSentence = question.en.replace(/\{.*?\}/g, ' (______) ');

                quizContent.innerHTML = `
                    <h3 class="text-2xl font-bold mb-2">問題 ${currentQuestionIndex + 1}/10</h3>
                    <p class="text-lg mb-4">${question.ja}</p>
                    <p class="font-english text-xl mb-6 p-4 bg-gray-100 rounded-lg">${questionSentence}</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        ${options.map(opt => `<button class="quiz-option p-4 bg-blue-100 hover:bg-blue-200 rounded-lg text-left text-lg font-english" data-answer="${opt}">${opt}</button>`).join('')}
                    </div>
                `;

                document.querySelectorAll('.quiz-option').forEach(button => {
                    button.addEventListener('click', () => {
                        if (button.dataset.answer === correctAnswer) {
                            score++;
                            button.classList.add('bg-green-400', 'text-white');
                        } else {
                            button.classList.add('bg-red-400', 'text-white');
                            document.querySelector(`.quiz-option[data-answer="${CSS.escape(correctAnswer)}"]`).classList.add('bg-green-400', 'text-white');
                        }

                        setTimeout(() => {
                            currentQuestionIndex++;
                            showQuestion();
                        }, 1200);
                    });
                });
            }

            function showQuizResult() {
                quizContent.innerHTML = `
                    <h3 class="text-3xl font-bold mb-4 text-center">テスト終了！</h3>
                    <p class="text-center text-xl mb-6">あなたのスコアは...</p>
                    <p class="text-center text-7xl font-bold text-purple-600">${score * 10}<span class="text-3xl">点</span></p>
                    <p class="text-center text-xl mt-2">(${questions.length}問中 ${score}問正解)</p>
                `;
            }

            showQuestion();
            quizModal.classList.remove('hidden');
        }


        // --- Event Listeners ---

        toggleAnswerBtn.addEventListener('click', () => {
            if (!activeSentenceElement) {
                showMessage('<p>文を選択してください。</p>', 2000);
                return;
            }
            activeSentenceElement.classList.toggle('show-answer');
        });

        toggleExplanationBtn.addEventListener('click', () => {
            if (!activeSentenceElement) {
                showMessage('<p>文を選択してください。</p>', 2000);
                return;
            }
            const explanationDiv = activeSentenceElement.querySelector('.explanation');
            if (explanationDiv.style.display === 'block') {
                explanationDiv.style.display = 'none';
            } else {
                explanationDiv.style.display = 'block';
            }
        });

        playSoundBtn.addEventListener('click', playSound);
        recordBtn.addEventListener('click', handleRecording);
        startQuizBtn.addEventListener('click', startQuiz);
        closeQuizBtn.addEventListener('click', () => quizModal.classList.add('hidden'));

        // Select All Logic
        selectAllCheckbox.addEventListener('change', (e) => {
            const isChecked = e.target.checked;
            const checkboxes = document.querySelectorAll('.sentence-checkbox');
            checkboxes.forEach(cb => {
                cb.checked = isChecked;
                if (isChecked) selectedSentences.add(cb.dataset.id);
                else selectedSentences.delete(cb.dataset.id);
            });
        });

        // PDF Modal Logic
        openPdfModalBtn.addEventListener('click', () => {
            if (selectedSentences.size === 0) {
                showMessage('<p>PDFを作成する問題を選択してください。</p>', 3000);
                return;
            }
            pdfModal.classList.remove('hidden');
        });
        closeModalBtn.addEventListener('click', () => pdfModal.classList.add('hidden'));

        // --- PDF Generation Buttons Listeners ---

        // 変更: PDF内のサブタイトルを「Insight 英文法・語法・熟語 ＋ 章とその題」の形式にする
        // h1: "Insight 英文法・語法・熟語"
        // h2: "学習用サイト（28章 その他の重要熟語）" -> "（28章 その他の重要熟語）" の部分を抽出して結合
        const mainTitle = document.querySelector('header h1').innerText;
        const subTitleRaw = document.getElementById('app-subtitle').innerText;
        // "学習用サイト" という文字が含まれていれば削除して整形
        const chapterTitle = subTitleRaw.replace('学習用サイト', '').trim();
        const subtitleText = `${mainTitle} ${chapterTitle}`;

        // 1. 完全なリスト
        document.getElementById('download-list-btn').addEventListener('click', () => {
            const items = getSelectedItems();
            if (!items) return;
            // リスト作成の場合は重複があっても良いが、見やすくするために熟語ベースでユニークにするか、
            // そのままID順で並べるか。ここではID順ですべて表示する。

            const listItems = items.map(item => {
                // Remove { } for clean display
                const cleanEn = item.en.replace(/[{}]/g, '');
                return `<li>
                    <span class="inline-content"><strong>${item.answer}</strong>: ${item.explanation.replace(/\n/g, '<br>')}</span><br>
                    <span style="font-size:0.9em; color:#555;">Ex: ${cleanEn} / ${item.ja}</span>
                </li>`;
            }).join('');

            openPrintWindow(`<ul class="list-container">${listItems}</ul>`, '重要熟語リスト');
            pdfModal.classList.add('hidden');
        });

        // 2. 英語を解答
        document.getElementById('download-en-quiz-btn').addEventListener('click', () => {
            const items = getUniqueItems(getSelectedItems());

            const quizItems = items.map(item =>
                `<li><span class="inline-content">${item.explanation.replace(/\n/g, ' ')} : ____________________</span></li>`
            ).join('');
            const answerItems = items.map(item =>
                `<li><span class="inline-content">${item.answer}</span></li>`
            ).join('');

            const body = `<h2>${subtitleText}</h2><ol class="list-container">${quizItems}</ol><div class="answer-key"><h2>解答</h2><ol class="list-container">${answerItems}</ol></div>`;
            openPrintWindow(body, '熟語テスト (英語を解答)');
            pdfModal.classList.add('hidden');
        });

        // 3. 意味を解答
        document.getElementById('download-ja-quiz-btn').addEventListener('click', () => {
            const items = getUniqueItems(getSelectedItems());

            const quizItems = items.map(item =>
                `<li><span class="inline-content"><strong>${item.answer}</strong> : ____________________</span></li>`
            ).join('');
            const answerItems = items.map(item =>
                `<li><span class="inline-content">${item.explanation.replace(/\n/g, ' ')}</span></li>`
            ).join('');

            const body = `<h2>${subtitleText}</h2><ol class="list-container">${quizItems}</ol><div class="answer-key"><h2>解答</h2><ol class="list-container">${answerItems}</ol></div>`;
            openPrintWindow(body, '熟語テスト (意味を解答)');
            pdfModal.classList.add('hidden');
        });

        // 4. 混合
        document.getElementById('download-mixed-quiz-btn').addEventListener('click', () => {
            const items = getUniqueItems(getSelectedItems());
            let quizItems = '';
            let answerItems = '';

            items.forEach(item => {
                if (Math.random() > 0.5) {
                    // 日本語 -> 英語
                    quizItems += `<li><span class="inline-content">${item.explanation.replace(/\n/g, ' ')} : ____________________</span></li>`;
                    answerItems += `<li><span class="inline-content">${item.answer}</span></li>`;
                } else {
                    // 英語 -> 日本語
                    quizItems += `<li><span class="inline-content"><strong>${item.answer}</strong> : ____________________</span></li>`;
                    answerItems += `<li><span class="inline-content">${item.explanation.replace(/\n/g, ' ')}</span></li>`;
                }
            });

            const body = `<h2>${subtitleText}</h2><ol class="list-container">${quizItems}</ol><div class="answer-key"><h2>解答</h2><ol class="list-container">${answerItems}</ol></div>`;
            openPrintWindow(body, '熟語テスト (混合)');
            pdfModal.classList.add('hidden');
        });

        // 5. 例文穴埋め
        document.getElementById('download-sentence-quiz-btn').addEventListener('click', () => {
            const items = getSelectedItems(); // 例文問題なので重複（文脈違い）も含める

            const quizItems = items.map(item => {
                // Replace {answer} with underscore
                const blankSentence = item.en.replace(`{${item.answer}}`, '____________________');
                return `<li>${blankSentence}<br><span style="font-size:0.9em;">(${item.ja})</span></li>`;
            }).join('');

            const answerItems = items.map(item =>
                `<li>${item.answer}</li>`
            ).join('');

            const body = `<h2>${subtitleText}</h2><ol>${quizItems}</ol><div class="answer-key"><h2>解答</h2><ol class="list-container">${answerItems}</ol></div>`;
            openPrintWindow(body, '熟語テスト (例文穴埋め)');
            pdfModal.classList.add('hidden');
        });

        // 6. 例文混合 (穴埋め / 下線部和訳)
        document.getElementById('download-sentence-mixed-quiz-btn').addEventListener('click', () => {
            const items = getSelectedItems();
            let quizItems = '';
            let answerItems = '';

            const instruction = '<p style="border:1px solid #ccc; padding:10px; margin-bottom:20px;">指示：空所には適切な語句を補い、下線部がある文は下線部の意味を日本語で答えなさい。</p>';

            items.forEach(item => {
                if (Math.random() > 0.5) {
                    // 穴埋め
                    const blankSentence = item.en.replace(`{${item.answer}}`, '____________________');
                    quizItems += `<li>${blankSentence}<br><span style="font-size:0.9em;">(${item.ja})</span></li>`;
                    answerItems += `<li>${item.answer}</li>`;
                } else {
                    // 下線部和訳 (ここでは熟語の意味を問う形にする)
                    const underlineSentence = item.en.replace(`{${item.answer}}`, `<u>${item.answer}</u>`);
                    quizItems += `<li>${underlineSentence}<br>意味: ____________________</li>`;
                    answerItems += `<li>${item.explanation.split('\n')[0]}</li>`; // 解説の1行目を答えとする
                }
            });

            const body = `<h2>${subtitleText}</h2>${instruction}<ol>${quizItems}</ol><div class="answer-key"><h2>解答</h2><ol class="list-container">${answerItems}</ol></div>`;
            openPrintWindow(body, '熟語テスト (例文混合)');
            pdfModal.classList.add('hidden');
        });


        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            renderChapter();
        });
    </script>
</body>

</html>