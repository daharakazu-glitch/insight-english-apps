<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Insight App - Chapter 15</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&family=Tinos:wght@700&display=swap');
        
        body {
            background-color: #007BFF; /* ビビットなブルー */
            font-family: 'Noto Sans JP', sans-serif;
        }

        /* 英語フォントをTimes New Romanに設定 */
        .font-english {
            font-family: 'Tinos', 'Times New Roman', serif;
            font-weight: 700;
            font-size: 1.25rem; /* 20px */
            line-height: 1.75rem; /* 28px */
        }

        .answer-span {
            color: #DC2626; /* 赤色 */
            font-weight: 700;
            display: none;
        }

        .underline-span {
            text-decoration: underline;
            text-underline-offset: 4px;
            display: inline;
        }

        .show-answer .answer-span {
            display: inline;
        }

        .show-answer .underline-span {
            display: none;
        }
        
        .explanation {
            display: none;
            white-space: pre-wrap;
        }

        /* Button Styles for Modal */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }
        .btn-primary {
            background-color: #3b82f6;
            color: white;
        }
        .btn-primary:hover {
            background-color: #2563eb;
        }
        .btn-secondary {
            background-color: #6b7280;
            color: white;
        }
        .btn-secondary:hover {
            background-color: #4b5563;
        }
    </style>
</head>
<body class="text-gray-800">

    <div id="app-container" class="container mx-auto p-4 md:p-8 max-w-4xl">
        <header class="text-center mb-8 bg-blue-500 p-4 rounded-xl shadow-lg">
            <h1 class="text-2xl md:text-3xl font-bold text-white">Insight 英文法・語法・熟語</h1>
            <h2 id="app-subtitle" class="text-xl md:text-2xl font-bold text-white">学習用サイト（Chapter 15）</h2>
        </header>

        <main class="bg-white/90 backdrop-blur-sm p-6 rounded-xl shadow-lg mb-28">
            <div class="flex justify-between items-center mb-6">
                 <!-- PDF Control Section -->
                 <div class="flex-1 mr-4">
                    <div class="p-4 bg-gray-50 rounded-lg border border-gray-200">
                        <h3 class="font-bold text-sm md:text-base mb-2">選択した問題でPDFを作成</h3>
                        <div class="flex flex-col md:flex-row md:items-center justify-between gap-3">
                            <div class="flex items-center">
                                <input type="checkbox" id="select-all-checkbox" class="h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                <label for="select-all-checkbox" class="ml-2 text-sm font-medium text-gray-700 cursor-pointer">すべて選択 / 解除</label>
                            </div>
                            <button id="open-pdf-modal-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow text-sm transition-transform transform hover:scale-105">
                                PDF作成メニュー
                            </button>
                        </div>
                    </div>
                </div>

                <button id="start-quiz-btn" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-lg shadow transition-transform transform hover:scale-105 whitespace-nowrap">
                    ランダムテスト
                </button>
            </div>

            <div id="sentence-list" class="space-y-6">
                <!-- Sentences will be populated by JS -->
            </div>
        </main>
    </div>

    <!-- Control Panel -->
    <div id="control-panel" class="fixed bottom-0 left-0 right-0 bg-white/80 backdrop-blur-md p-4 border-t-2 border-gray-200 shadow-2xl flex justify-center items-center space-x-2 md:space-x-4">
        <button id="toggle-answer-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">表示/非表示</button>
        <button id="play-sound-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">音声再生</button>
        <button id="record-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">録音評価</button>
        <button id="toggle-explanation-btn" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">解説</button>
    </div>

    <!-- Message/Score Modal -->
    <div id="message-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50">
        <div id="message-content" class="bg-white p-8 rounded-lg shadow-xl text-center">
            <!-- Message content will be populated by JS -->
        </div>
    </div>
    
    <!-- Quiz Modal -->
    <div id="quiz-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center z-40 p-4">
        <div class="bg-white w-full max-w-2xl p-8 rounded-2xl shadow-2xl relative">
            <button id="close-quiz-btn" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-3xl font-bold">&times;</button>
            <div id="quiz-content">
                <!-- Quiz content will be populated by JS -->
            </div>
        </div>
    </div>

    <!-- PDF Download Modal -->
    <div id="pdf-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50">
        <div class="relative mx-auto p-5 border w-11/12 md:w-1/2 lg:w-1/3 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">ダウンロードするPDFの種類を選択</h3>
                <div class="mt-2 space-y-3">
                    <button id="download-list-btn" class="btn btn-primary w-full justify-start text-left">1. 完全なリスト (熟語・意味・例文)</button>
                    <button id="download-en-quiz-btn" class="btn btn-primary w-full justify-start text-left">2. 熟語テスト (英語を解答)</button>
                    <button id="download-ja-quiz-btn" class="btn btn-primary w-full justify-start text-left">3. 熟語テスト (意味を解答)</button>
                    <button id="download-mixed-quiz-btn" class="btn btn-primary w-full justify-start text-left">4. 熟語テスト (混合)</button>
                    <button id="download-sentence-quiz-btn" class="btn btn-primary w-full justify-start text-left">5. 例文の穴埋め問題</button>
                    <button id="download-sentence-mixed-quiz-btn" class="btn btn-primary w-full justify-start text-left">6. 例文の混合問題 (穴埋め/和訳)</button>
                </div>
                <div class="mt-6">
                    <button id="close-modal-btn" class="btn btn-secondary w-full">キャンセル</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const chapterData = [
    {
        "id": "1",
        "ja": "2 3 4 5 6 7 8 9 10音読 ◀\t音読用動画 別解など 疑問文 2 3 4 5 6 7 8 9 10音読 文法編 ｜  15章 疑問文 2 3 4 5 6 7 8 9 10音読 文法編 ｜  15章 疑問文 2 3 4 5 6 7 8 9 10音読 文法編 ｜  15章 疑問文 2 3 4 5 6 7 8 9 10音読 文法編 ｜  15章 疑問文",
        "en": "???",
        "answer": "???",
        "explanation": "",
        "question": "howʴʧ…File56ͷछྨFile55"
    },
    {
        "id": "෯",
        "ja": "復習",
        "en": "???",
        "answer": "???",
        "explanation": "",
        "question": "ස౓ɾճ਺ how soon how high how many ʴࢺ how much （ʴࢺ） how fast how thick తͳૣ͞ ͞ ਺ ஋ஈɾྔɾఔ౓ ଎͞ ͞ ࢺͱ͠ ͯѻ͏ɹ  who [whom, whose]ʮ୭ʯ whatʮԿɼʢ਺ྔɾ஋ஈͳͲ͕ʣͲΕ͚ͩͷ΋ͷʯɹ  whichʮͲͪΒʯ ࢺͷલʹஔ͘ɹ  whoseʴࢺʮ୭ͷʙʯ whatʴࢺʮͲͷʙʯɹ  whichʴࢺʮͲͪΒͷʙʯ whyʮͳͥʯɹ  howʮͲͷΑ͏ʹɼͲΕ͘Β͍ʯ 204 205 Self Check"
    },
    {
        "id": "15",
        "ja": "疑問文 疑問文 疑問文 疑問文 疑問文",
        "en": "???",
        "answer": "???",
        "explanation": "",
        "question": ""
    },
    {
        "id": "446",
        "ja": "「この市の人口はどれく らいですか。」「 お よ そ 1 8 万 人 で す 。」 15章 疑問文",
        "en": "“{What is the population of this city?” “It’s about 180,000.”}",
        "answer": "What is the population of this city?” “It’s about 180,000.”",
        "explanation": "▶ ࢺを使った疑問文はwh-໰จと も呼ばれる。疑問詞の種類  ➡File55\nwhat ʮԿɼʢ਺ྔɾ஋ஈͳͲ͕ʣͲΕ͘Β͍ʯ\n▶ 疑問代名詞what を使って人口の数量を尋ねる。How large is the population\nof this city? としてもよい。180,000 はone hundred eighty thousand と読む。",
        "question": "“(        ) (        ) the population of this city?” “It’s about 180,000.” ①"
    },
    {
        "id": "447",
        "ja": "「 チケットはいくらに なりま す か。」「 3 0 ド ル で す 。」",
        "en": "“{How much are tickets?” “They’re $30.” how much … ʮͲͷ͘Β͍ ʜ ɼ ͍͘Βʜ ʯ―how は疑問副詞}",
        "answer": "How much are tickets?” “They’re $30.” how much … ʮͲͷ͘Β͍ ʜ ɼ ͍͘Βʜ ʯ―how は疑問副詞",
        "explanation": "▶ 量・値段を尋ねる。 「数」を尋ねる場合はhow many … を使う。➡File56\n$ は通貨の「ドル」を表す通貨記号。$30 はthirty dollars と読む。",
        "question": "“  are tickets?” “They’re $30.”"
    },
    {
        "id": "448",
        "ja": "「ど のくらい の 頻 度 で田舎の祖父母に会いに行きますか。」「 年 に ２ 回 で す 。」",
        "en": "“{How often do you visit your grandparents in the countryside?” “Twice a year.”}",
        "answer": "How often do you visit your grandparents in the countryside?” “Twice a year.”",
        "explanation": "▶ 頻度・回数を尋ねる。",
        "question": "“(        ) (o      ) (        ) (        ) (        ) your grandparents in the countryside?” “Twice a year.” ͘ ˠ ʙΛ๚ΕΔʯ͘ ˠ ʙΛ๚ΕΔʯ"
    },
    {
        "id": "449",
        "ja": "「ショーはどれく らいの長さですか。」「 約 ２ 時 間 半 で す 。」",
        "en": "“{How long is the show?” “It’s about two and a half hours.” how long …ɾ෺ͷ௕͕͞ʣͲͷ͘Β͍ ʜ ʯ}",
        "answer": "How long is the show?” “It’s about two and a half hours.” how long …ɾ෺ͷ௕͕͞ʣͲͷ͘Β͍ ʜ ʯ",
        "explanation": "▶ 期間の長さ・物の長さを尋ねる。\ntwo and a half hours (long)൒ ʢͷ௕͞ʣʯ",
        "question": "“ ?” “It’s about two and a half hours.”"
    },
    {
        "id": "450",
        "ja": "「あとどのくらいでこのバスは出発するの で す か 。」「 も う 少 し 人 が 乗 っ て か ら で す 。」",
        "en": "“{How soon will this bus leave?” “After a few more people get on.”}",
        "answer": "How soon will this bus leave?” “After a few more people get on.”",
        "explanation": "▶ 時間的な早さを尋ねる。\nget on (A)ʮʢA ʹ ʣ৐ Δʯ⇔⇔ get oﬀ (A)ʮʢAΓΔʯ",
        "question": "“(        ) (        ) will this bus (        )?” “After a few more people get on.”"
    },
    {
        "id": "451",
        "ja": "「ここからいちばん近いスーパーまでどのく らいですか。」 「数ブロック行ったところです。 」",
        "en": "“{How far is it from here to the nearest supermarket?” “It’s a few blocks away.” how far …཭͕ʣͲͷ͘ Β͍ʜɼͲͷఔ౓ʜʯ}",
        "answer": "How far is it from here to the nearest supermarket?” “It’s a few blocks away.” how far …཭͕ʣͲͷ͘ Β͍ʜɼͲͷఔ౓ʜʯ",
        "explanation": "▶ 距離・程度を尋ねる。\nbe ～ blocks awayͬͨͱ͜Ζʹ͋Δʯ\noften / soon / leave / far\n表 現 尋ねる事柄 表 現 尋ねる事柄\nhow old\nhow long\nhow tall\nhow large\nhow far\nhow deep\nhow wide\nhow often\n೥ྸ\nͷ௕͞ɾ෺ͷ௕͞\n͞\n͞\n཭ɾఔ౓\nਂ͞",
        "question": "“  to the nearest supermarket?” “It’s a few blocks away.”"
    },
    {
        "id": "452",
        "ja": "私たちのほとんどは自分たちがどれだけのエネルギーを使っているかを知らない。",
        "en": "Most of us do not know {how much energy we use.}",
        "answer": "how much energy we use.",
        "explanation": "▶ 疑問文を「文の一部」と して組み込んだものを໰と い い ， 名 詞 節（અ）\nを つくる。 名 詞 節 は文の主語・目的語・補語になる。この文ではknow の目的語。\n▶ 間接疑問の中はฏঀจ（S′ʴV′）の語順にする。普通の疑問文のよ うにV＋S\nの語順にはしない。疑問詞がS′に あ た る 場 合 は そ の ま まV′を 続 け る 。\nHow much energy  do we use?\n⭢ Most of us do not know how much energy       we use.［間接疑問］\nS′ʴV′",
        "question": "Most of us do not know (        ) (        ) (e      ) (        ) (        ). ໰ͷจɻ໰ͷจɻ"
    },
    {
        "id": "453",
        "ja": "「サラが今日どうして学 校を休んでいるか 知ってる？」 「ええ。彼女はディ ベートの大会に参加し ています。 」",
        "en": "“{Do you know why Sara is} not in school today?” “Yes. She’s participating in a debate competition.” Do S knowʴ໰（疑問詞（ʴS′）ʴV′）?ʮ ʜ Λ ஌ ͬ ͯ ͍ · ͢ ͔ ɻʯ",
        "answer": "Do you know why Sara is",
        "explanation": "▶ Yes /No で答えることのでき る疑問文は，Do ～で始める。",
        "question": "“( why / do / Sara / know / you / is ) not in school today?” “Yes. She’s participating in a debate competition.”"
    },
    {
        "id": "454",
        "ja": "「私たちの世代で最高の歌手は誰だと思いますか。」 「米津玄師だと思います。 」",
        "en": "“Who do you think is the best singer of our generation?” “I believe it’s Yonezu Kenshi.” ࢺʴdo you think （S）ʴV …?͍ · ͢ ͔ ɻʯ Yes/No では答えられない疑問文。do you think の 後 は（S）＋V の語順にする。 How old                           is Ken?（ ケ ン は 何 歳 で す か 。） ⭢ How old do you think Ken is?（ ケ ン は 何 歳 だ と 思 い ま す か 。） S ʴV",
        "answer": "Who do you think is the best singer of our generation?” “I believe it’s Yonezu Kenshi.” ࢺʴdo you think （S）ʴV …?͍ · ͢ ͔ ɻʯ Yes/No では答えられない疑問文。do you think の 後 は（S）＋V の語順にする。 How old is Ken?（ ケ ン は 何 歳 で す か 。） ⭢ How old do you think Ken is?（ ケ ン は 何 歳 だ と 思 い ま す か 。） S ʴV",
        "explanation": "▶ 問題文のWho のよ うに，疑問詞がS にあたる場合はそのままV を続ける。\nWho do you think is the best singer of our generation?\nS                                   V",
        "question": "“(        ) (        ) (        ) (        ) (        ) the best singer of our generation?” “I believe it’s Yonezu Kenshi.”"
    },
    {
        "id": "455-1",
        "ja": "「恋愛映画を見るのは好きじゃないのですか。」「いいえ，好きです。」",
        "en": "“{Don’t you like watching romantic movies?” “Yes, I do.”}",
        "answer": "Don’t you like watching romantic movies?” “Yes, I do.”",
        "explanation": "▶ 相手に「…ではないのですか」と尋ねる疑問文を໰จと呼ぶ。文を否\n定形で始めて，not は短縮形を使う。\n否定疑問文に対する返答 （Yes/No） は，日本語の返答 （はい/ い い え ）と 逆 に な る こ と\nが多い。英語では，肯定形・否定形のどちらの疑問文でも，返答が肯定の内容なら\nYes，否定の内容ならNo で答える。➡Grasp25",
        "question": "“(        ) (        ) (        ) watching romantic movies?” “(        ), (        ) (        ).”"
    },
    {
        "id": "455-2",
        "ja": "「テストの結 果を見て，彼は驚かなかったのですか。」 「はい， 驚きませんでした。」",
        "en": "“{Wasn’t he surprised when he saw his test results?” “No, he wasn’t.”}",
        "answer": "Wasn’t he surprised when he saw his test results?” “No, he wasn’t.”",
        "explanation": "▶ 否定疑問文。 「驚かなかった」という否定の答えなので，“No, …” と答える。\nsurprised\n“Don’t you like sushi?”（すしは好きではないのですか。）［否定疑問文］\n“Yes, I do（＝like it）.”（͍͍͑， 好 き で す 。）\n“No, I don’t（＝donʼt like it）.”（͸͍， 好 き で は な い で す 。）\n⭢ 日本語は「相手の発言」に同意するときに「はい」 ，同意しないときに「いいえ」と\nなるが，英語では「内容」を肯定するならYes，否定するならNoとなる。\nGrasp໰จͷ౴͑ํ25\n206 207\n復習\nSelf\nCheck",
        "question": "“(        ) (        ) (        ) when he saw his test results?” “(        ), (        ) (        ).”"
    },
    {
        "id": "456",
        "ja": "今日は結構晴れていますね。",
        "en": "The weather is pretty sunny today, {isn’t it?}",
        "answer": "isn’t it?",
        "explanation": "▶ 平 叙 文（S＋V の語順の文） や命令文の後に付ける疑問形を໰と呼ぶ。平\n叙文の付加疑問は，相手に「…ですよね」と確認したり，同意を求めたりする。\n▶ 肯定文には，否定形の付加疑問を付ける。  …, isnʼt it?    …, is it?",
        "question": "The weather is pretty sunny today, (        ) (        )?"
    },
    {
        "id": "457",
        "ja": "野菜を食べるのが苦手な子 もいますよ ね。",
        "en": "{Some children don’t like to eat vegetables, do they?}",
        "answer": "Some children don’t like to eat vegetables, do they?",
        "explanation": "▶ 否定文には，肯定形の付加疑問を付ける。  …, do they?    …, donʼt they?\nsome ʴࢺʮ͍͔ͭ͘ͷʙʯ",
        "question": "(        ) (        ) don’t like to eat vegetables, (        ) (        )?"
    },
    {
        "id": "458",
        "ja": "あなたは前に台湾へ行ったことがあるんですよね。",
        "en": "{You’ve been to Taiwan before, haven’t you}?",
        "answer": "You’ve been to Taiwan before, haven’t you",
        "explanation": "▶ 現在完了形の肯定文には，haven’t [hasn’t] を使った付加疑問を付ける。\n…, havenʼt you?    …, have you?",
        "question": "Taiwan before, ?"
    },
    {
        "id": "459-1",
        "ja": "発展 食卓を片付けて くれますか。",
        "en": "{Clear the table, will you? ఆͷ໋ྩจ,ʴwill you?ʮ ʜ ͠ ͯ ͘ Ε · ͢ ͔ ɻʯ clear the table ʮ৯୎Λย෇͚ΔɼςʔϒϧΛย෇͚Δʯ}",
        "answer": "Clear the table, will you? ఆͷ໋ྩจ,ʴwill you?ʮ ʜ ͠ ͯ ͘ Ε · ͢ ͔ ɻʯ clear the table ʮ৯୎Λย෇͚ΔɼςʔϒϧΛย෇͚Δʯ",
        "explanation": "",
        "question": "(        ) the table, (        ) (        )?"
    },
    {
        "id": "459-2",
        "ja": "発展 ミーティングに遅れないでくれますか。",
        "en": "{Don’t be late for the meeting, will you? be late for A ʮA ʹ஗ΕΔʯ⇔⇔ be in time for AʮA͏ʯ}",
        "answer": "Don’t be late for the meeting, will you? be late for A ʮA ʹ஗ΕΔʯ⇔⇔ be in time for AʮA͏ʯ",
        "explanation": "",
        "question": "(D      ) (        ) (        ) for the meeting, (        ) (        )?"
    },
    {
        "id": "460",
        "ja": "図書館で待ち合 わせして，試験勉 強をしようよ。",
        "en": "{Let’s meet at the library and study for our exam, shall we? Let ’sʴܗݪ,ʴshall we?ʮ ʜ ͠ · ͠ ΐ͏ Α ɻʯ ＝Why don’t we do?}",
        "answer": "Let’s meet at the library and study for our exam, shall we? Let ’sʴܗݪ,ʴshall we?ʮ ʜ ͠ · ͠ ΐ͏ Α ɻʯ ＝Why don’t we do?",
        "explanation": "",
        "question": "(        ) (        ) at the library and (        ) for our exam, (        ) (        )?"
    },
    {
        "id": "461",
        "ja": "その質問の答えを誰 が 知っているだろうか。",
        "en": "{Who knows the answer} to the question?",
        "answer": "Who knows the answer",
        "explanation": "▶ 相手に質問をしているのではなく， 「…だろうか，いやそうではない」と反語的に\n否定の内容を表す疑問文を໰จと呼ぶ。相手に返答を求めているわけで\nはない。この問題文はNobody knows the answer to the question. とほぼ同\nじ意味を表す。\n疑問代名詞は３人称単数扱いする。 Who know … とはしない。\nWho knows ʙ ? ʢʙΛ୭͕஌͍ͬͯΔͩΖ͏͔ ⭢ʣ ʮ୭΋ʙΛ஌Βͳ͍ɻ ʯ\n＝Nobody knows ～.",
        "question": "to the question?"
    },
    {
        "id": "462",
        "ja": "そんなうそを信じられる人がいるだろうか。",
        "en": "{How could anyone possibly believe such a lie? How could S possibly do?}",
        "answer": "How could anyone possibly believe such a lie? How could S possibly do?",
        "explanation": "",
        "question": "(        ) (        ) anyone (p      ) (        ) such a lie?"
    },
    {
        "id": "463",
        "ja": "変えることができないのに，過去を悔やんで何になるのか。",
        "en": "＝ What’s the point of regretting the past if we can’t change it? What’s the use of regretting the past if we can’t change it? What is the point of doing?      ༻ʧ ͸Կͳͷ͔ ⭢ʣ What is the use of doing?       ʮʙͯ͠΋Կʹ΋ͳΒͳ͍ɻ ʯ",
        "answer": "＝ What’s the point of regretting the past if we can’t change it? What’s the use of regretting the past if we can’t change it? What is the point of doing? ༻ʧ ͸Կͳͷ͔ ⭢ʣ What is the use of doing? ʮʙͯ͠΋Կʹ΋ͳΒͳ͍ɻ ʯ",
        "explanation": "▶ point は 「 目 的 」，use は「効用，役に立つこと」の意味。\nregret the pastΛչ΍Ήʯ\nclear / meet / possibly / regret\n208 209\n復習\nSelf\nCheck",
        "question": "(        ) (        ) (        ) (        ) (        ) the past when we can’t change it? ʮ ʙͯ͠΋Կʹ΋ͳΒͳ͍ʯͱ͍͏͜ͱΛ఻͑Δจɻʮ ʙͯ͠΋Կʹ΋ͳΒͳ͍ʯͱ͍͏͜ͱΛ఻͑Δจɻ"
    },
    {
        "id": "464",
        "ja": "「サラはどんな人ですか。」「 優 し く て 気 さ く な 人 で す 。」",
        "en": "“{What is Sara like?” “She is a kind and friendly person.” What is S like? ʮS ͸ͲͷΑ͏ͳ΋ͷ ʦਓʧ ͔ɻ ʯ}",
        "answer": "What is Sara like?” “She is a kind and friendly person.” What is S like? ʮS ͸ͲͷΑ͏ͳ΋ͷ ʦਓʧ ͔ɻ ʯ",
        "explanation": "▶ S について性格や性質を尋ねる表現。\nfriendly͘͞ͳʯ",
        "question": "“(        ) (        ) Sara (        )?” “She is a kind and friendly person.”"
    },
    {
        "id": "465",
        "ja": "「ケンはどんな外見ですか。」「 背 が 高 く ， ス リ ム で シ ョ ー ト ヘ ア で す 。」",
        "en": "“{What does Ken look like?” “He’s tall and slim with short hair.” What does S look like? ʮS͔ ɻʯ}",
        "answer": "What does Ken look like?” “He’s tall and slim with short hair.” What does S look like? ʮS͔ ɻʯ",
        "explanation": "▶ S について外見を尋ねる表現。",
        "question": "“(        ) (        ) Ken (        ) (        )?” “He’s tall and slim with short hair.”"
    },
    {
        "id": "466",
        "ja": "「お仕事は何をされていますか。」「 看 護 師 で す 。」",
        "en": "“{What do you do}?” “I’m a nurse.”",
        "answer": "What do you do",
        "explanation": "▶ S について職業を尋ねる表現。",
        "question": "“ ?” “I’m a nurse.”"
    },
    {
        "id": "467",
        "ja": "「このアイデアをどう思いますか。」「 す ば ら し い と 思 い ま す 。」",
        "en": "“What do you think of [about] this idea?” “I think it’s great.” What do you think of A? What do you think about A?    ʮA͍ · ͢ ͔ ɻʯ ＝What do you make of A? ＝How do you feel about A?",
        "answer": "What do you think of [about] this idea?” “I think it’s great.” What do you think of A? What do you think about A? ʮA͍ · ͢ ͔ ɻʯ ＝What do you make of A? ＝How do you feel about A?",
        "explanation": "▶ A について意見や感想を尋ねる表現。",
        "question": "“  this idea?” “I think it’s great.”"
    },
    {
        "id": "468-1",
        "ja": "「 読んでいる本はどうですか。」「 ス ト ー リ ー が お も し ろ い で す 。」",
        "en": "“{How do you like the book you’re reading?” “It has an interesting story.”}",
        "answer": "How do you like the book you’re reading?” “It has an interesting story.”",
        "explanation": "▶ 相手の意見や感想を求めるときに使う表現。",
        "question": "“(        ) (        ) (        ) (l      ) the book you’re reading ?” “It has an interesting story.”"
    },
    {
        "id": "468-2",
        "ja": "「ステーキの焼き加減はどのようにしますか。」「 ミ デ ィ ア ム で お 願 い し ま す 。」",
        "en": "＝ “How would you like your steak cooked?” “Medium, please.” “How do you like your steak cooked?” How would you like A? How do you like A?           ʮA ͸ Ͳ ͷ Α ͏ ʹ ͠ · ͢ ͔ ɻʯ",
        "answer": "???",
        "explanation": "▶ ステーキやコーヒーなどについて好みの調理法を尋ねるときに使う表現。",
        "question": "“  your steak cooked?” “Medium, please.”"
    },
    {
        "id": "469",
        "ja": "「一緒に映画を見に行くのはどう？ 」「 そ れ は い い ね 。」",
        "en": "＝ ＝ “{How about going to the movies together?” “That sounds good.” “What about going to the movies together?” “What do you say to going to the movies together?” How about A [doing]? ＝What do you say to A [doing]?}",
        "answer": "How about going to the movies together?” “That sounds good.” “What about going to the movies together?” “What do you say to going to the movies together?” How about A [doing]? ＝What do you say to A [doing]?",
        "explanation": "▶ How about, What about, What do you say to の後には名詞や動名詞がく る。\nHow about  lunch before the movie?［lunch は名詞］\n（映画の前に昼食はどう？）\n＝ What about lunch before the movie?\n＝ What do you say to lunch before the movie?\n▶ What do you say to A [doing]? は他の２つよりも正式な言い方。\ngo to the movies͘ʯ\nlike / look like\n210 211\n復習\nSelf\nCheck",
        "question": "“(        ) (a      ) (        ) to the movies together?” “That sounds good.”"
    },
    {
        "id": "470",
        "ja": "「 何か新しいことをやってみてはどう？ 」「 そ う で す ね 。」",
        "en": "＝ “{Why don’t you try something new?” “All right.” “Why not try something new?” Why don’t you do? something new ʮԿ͔৽͍͜͠ͱʯ}",
        "answer": "Why don’t you try something new?” “All right.” “Why not try something new?” Why don’t you do? something new ʮԿ͔৽͍͜͠ͱʯ",
        "explanation": "",
        "question": "“(        ) (        ) (        ) (        ) something new?” “All right.”"
    },
    {
        "id": "471",
        "ja": "「ここでお昼を食べるのはどうですか。」「 い い で す よ 。」 ＝Let’sʴ動詞の原形,ʴshall we?",
        "en": "???",
        "answer": "???",
        "explanation": "",
        "question": "“(W     ) (        ) (        ) (        ) (        ) here?” “Sure.” “Why don’t we have lunch here?” “Sure.” Why don’t we do? ʮʢҰॹʹʣʙ ͠ · ͤ Μ ͔ ɻʯ"
    },
    {
        "id": "472",
        "ja": "「何のためにお金をためているのですか。」「 留 学 す る た め で す 。」",
        "en": "“{What are you saving money for?” “To study abroad.” What VʴS for?ʮԿͷͨΊʹS ͸ʙ͢Δͷ͔ɻ ʯ ＝Why VʴS? save moneyΛͨΊΔʯ⇔⇔ spend money͏ʯ}",
        "answer": "What are you saving money for?” “To study abroad.” What VʴS for?ʮԿͷͨΊʹS ͸ʙ͢Δͷ͔ɻ ʯ ＝Why VʴS? save moneyΛͨΊΔʯ⇔⇔ spend money͏ʯ",
        "explanation": "",
        "question": "“(        ) (        ) (        ) saving money (        )?” “To study abroad.”"
    },
    {
        "id": "473",
        "ja": "発展 「どうしていつも朝早く学校に来るの？」 「授業が始まる前に読書するのが好きなん です。 」 How come S ʴV?ʮS ͸ Ͳ ͏ ͠ ͯ ʙ ͢ Δ ͷ ͔ ɻʯ―理由や原因を尋ねる表現 ⇧「 ど の よう に（How）S が V す る こ と が 来 る（come）の か 」 How come の後は平叙文の語順（S＋V）に す る 。 ―come は「 （話し手に） 近づく」が基本的な意味で，この問題文では，話し手はすで に学校にいると考えられる。go to school は「学校へ行く」を意味する一般的な表現。 get to school は移動手段や到着を強調するときに使う表現。",
        "en": "???",
        "answer": "???",
        "explanation": "",
        "question": "“(H      ) (        ) (        ) always (        ) to school early in the morning?” “I like to read before class starts.” ʹʹWhyWhy  dodo  youyou  alwaysalways  comecome  toto  schoolschool  earlyearly  inin  thethe  morningmorning?? “How come you always come to school early in the morning?” “I like to read before class starts.” ＝Why VʴS? go to school / get to school / come to school͢Δʯ"
    },
    {
        "id": "474",
        "ja": "「その脚，どうしたのですか。」「 ス キ ー で け が を し ま し た 。」",
        "en": "＝ “What’s wrong with your leg?” “I hurt it skiing.” “What’s the matter with your leg?” What’s wrong with A?",
        "answer": "???",
        "explanation": "▶ I hurt it (when/while) skiing. のwhen/while が省略され，分詞であるskiing\n１語で「スキーをしている時に」という意味を表している。",
        "question": "“  your leg?” “I hurt it skiing.”"
    },
    {
        "id": "475",
        "ja": "海 がさらに温 かくなれ ばサンゴ 礁はどうなるのだろうか。",
        "en": "{What will become of the coral reefs if the ocean gets warmer? What becomes of A? ʮA ͸ Ͳ ͏ ͳ Δ ͷ ͔ ɻʯ}",
        "answer": "What will become of the coral reefs if the ocean gets warmer? What becomes of A? ʮA ͸ Ͳ ͏ ͳ Δ ͷ ͔ ɻʯ",
        "explanation": "▶ A についての気がかりや心配な気持ちを表す。過去のことはWhat became of A?，\n完了形はWhat has become of A?，未来のことはWhat will become of A? と\nなる。\ncoral reef ʮαϯΰ঴ʯ\nget warm ʮԹ͔͘ͳΔɼஆ͔͘ͳΔʯ⇔⇔ get cold͘ͳΔʯ",
        "question": "(        ) (        ) (b      ) (        ) the coral reefs if the ocean gets warmer?"
    },
    {
        "id": "476",
        "ja": "発展 外 国 で スマ ートフォンを紛失すればどうなるだろうか。",
        "en": "{What if I lose [lost] my smartphone in a foreign country? What if S ʴV?ʮʢ΋͠ʣS ͕ ʙ ͢ Ε ͹ Ͳ ͏ ͳ Δ ͩ Ζ ͏ ͔ ɻʯ}",
        "answer": "What if I lose [lost] my smartphone in a foreign country? What if S ʴV?ʮʢ΋͠ʣS ͕ ʙ ͢ Ε ͹ Ͳ ͏ ͳ Δ ͩ Ζ ͏ ͔ ɻʯ",
        "explanation": "▶ 望ましくないことを想 定した不安な気持ちを表す表現。語り手が「実際に起こる\nかもしれない」と感じている場合は直説法（lose）を ，「 起 こ り そ う も な い 」 と 感 じ\nている場合は仮定法（lost）を 使 う 。\nmatter / become / lose\n212 213\n復習\nSelf\nCheck",
        "question": "(        ) (        ) (        ) (        ) my smartphone in a foreign country?"
    }
];

        // --- App State ---
        let activeSentenceElement = null;
        let selectedSentences = new Set();
        let SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition;
        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.lang = 'en-US';
            recognition.interimResults = false;
        }
        
        // --- Voice Synthesis Setup ---
        let synthesisVoice = null;

        function setSynthesisVoice() {
            const voices = speechSynthesis.getVoices();
            // 優先順位: Google US English -> Microsoft Zira/David -> その他英語
            synthesisVoice = voices.find(voice => voice.name === 'Google US English') ||
                             voices.find(voice => voice.name.includes('Google') && voice.lang.includes('en-US')) ||
                             voices.find(voice => voice.name.includes('Microsoft') && voice.lang.includes('en-US')) ||
                             voices.find(voice => voice.lang === 'en-US') ||
                             voices.find(voice => voice.lang.startsWith('en'));
        }

        // 音声リストがロードされたら設定を実行
        if (speechSynthesis.onvoiceschanged !== undefined) {
            speechSynthesis.onvoiceschanged = setSynthesisVoice;
        }
        // 初期化時にも実行
        setSynthesisVoice();


        // --- DOM Elements ---
        const sentenceList = document.getElementById('sentence-list');
        const toggleAnswerBtn = document.getElementById('toggle-answer-btn');
        const playSoundBtn = document.getElementById('play-sound-btn');
        const recordBtn = document.getElementById('record-btn');
        const toggleExplanationBtn = document.getElementById('toggle-explanation-btn');
        const startQuizBtn = document.getElementById('start-quiz-btn');
        const messageModal = document.getElementById('message-modal');
        const messageContent = document.getElementById('message-content');
        const quizModal = document.getElementById('quiz-modal');
        const closeQuizBtn = document.getElementById('close-quiz-btn');
        const quizContent = document.getElementById('quiz-content');
        
        const selectAllCheckbox = document.getElementById('select-all-checkbox');
        const pdfModal = document.getElementById('pdf-modal');
        const openPdfModalBtn = document.getElementById('open-pdf-modal-btn');
        const closeModalBtn = document.getElementById('close-modal-btn');


        // --- Functions ---

        /**
         * Parses the English sentence template and creates the HTML structure.
         */
        function formatEnglishSentence(enTemplate, answer) {
            const blank = '__________';
            const answerHtml = `<span class="answer-span">${answer}</span>`;
            const underlineHtml = `<span class="underline-span">${blank}</span>`;
            const formattedSentence = enTemplate.replace(`{${answer}}`, `${answerHtml}${underlineHtml}`);
            return formattedSentence;
        }

        /**
         * Renders all sentences for the chapter.
         */
        function renderChapter() {
            sentenceList.innerHTML = '';
            chapterData.forEach(item => {
                const sentenceDiv = document.createElement('div');
                sentenceDiv.className = 'sentence-item p-4 border border-gray-200 rounded-lg bg-white transition-shadow duration-300 hover:shadow-md cursor-pointer';
                sentenceDiv.dataset.id = item.id;
                sentenceDiv.dataset.fullSentence = item.en.replace(`{${item.answer}}`, item.answer);

                const englishSentenceHtml = formatEnglishSentence(item.en, item.answer);

                sentenceDiv.innerHTML = `
                    <div class="flex items-start space-x-4">
                         <div class="flex items-center pt-1" onclick="event.stopPropagation()">
                            <input type="checkbox" class="sentence-checkbox h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500" data-id="${item.id}">
                        </div>
                        <span class="text-lg font-bold text-gray-500 w-10 shrink-0 pt-1">${item.id}</span>
                        <div class="flex-1">
                            <p class="mb-2 text-gray-700">${item.ja}</p>
                            <p class="font-english">${englishSentenceHtml}</p>
                            <div class="explanation mt-4 p-4 bg-yellow-100 border-l-4 border-yellow-400 text-gray-700 rounded-r-lg">
                                ${item.explanation}
                            </div>
                        </div>
                    </div>
                `;
                sentenceList.appendChild(sentenceDiv);
            });
            
            // Add click listener to each sentence item
            document.querySelectorAll('.sentence-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    // Don't select if clicking inside explanation
                    if (e.target.closest('.explanation')) return;
                    if (e.target.closest('.sentence-checkbox')) return; // Checkbox click is handled separately

                    if (activeSentenceElement) {
                        activeSentenceElement.classList.remove('ring-2', 'ring-blue-400', 'shadow-xl');
                    }
                    activeSentenceElement = item;
                    activeSentenceElement.classList.add('ring-2', 'ring-blue-400', 'shadow-xl');
                });
            });

            // Checkbox logic
            document.querySelectorAll('.sentence-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    const id = e.target.dataset.id;
                    if (e.target.checked) {
                        selectedSentences.add(id);
                    } else {
                        selectedSentences.delete(id);
                    }
                });
            });
            
            // Select the first sentence by default
            if (sentenceList.firstChild) {
                 sentenceList.firstChild.click();
            }
        }
        
        // --- PDF / Print Logic ---
        
        function openPrintWindow(bodyContent, title) {
            const htmlContent = `
                <!DOCTYPE html>
                <html lang="ja">
                <head>
                    <meta charset="UTF-8">
                    <title>Insight App - Chapter 15</title>
                    <style>
                        body { font-family: "Hiragino Kaku Gothic ProN", "Meiryo", sans-serif; line-height: 1.8; margin: 25px; color: #333; }
                        @media print { .no-print { display: none; } }
                        h1, h2 { text-align: center; border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 25px; }
                        ol, ul { list-style-position: inside; padding-left: 0; }
                        li { margin-bottom: 15px; }
                        .list-container { 
                            column-count: 2; 
                            column-gap: 40px; 
                        }
                        .list-container li, .list-container p { 
                            -webkit-column-break-inside: avoid; 
                            page-break-inside: avoid; 
                            break-inside: avoid; 
                        }
                        ol li {
                            list-style-type: decimal;
                            margin-left: 1.5em; 
                        }
                        .inline-content {
                            display: inline;
                        }
                        @media (max-width: 700px) { .list-container { column-count: 1; } }
                        .answer-key { page-break-before: always; margin-top: 50px; }
                        u { text-decoration: underline; text-underline-offset: 3px; }
                    </style>
                </head>
                <body>
                    <h1>${title}</h1>
                    <p class="no-print" style="text-align:center; margin-bottom: 20px; font-size: 0.9em; color: #666;">
                        ※印刷ダイアログが表示されない場合は、Ctrl+P (または Cmd+P) を押してください。
                    </p>
                    ${bodyContent}
                </body>
                </html>
            `;
            const printWindow = window.open('', '_blank');
            if (!printWindow) {
                showMessage('<p>ポップアップがブロックされました。設定を確認してください。</p>', 5000);
                return;
            }
            printWindow.document.write(htmlContent);
            printWindow.document.close();
            setTimeout(() => {
                printWindow.focus(); 
                printWindow.print();
            }, 250);
        }

        function getSelectedItems() {
            if (selectedSentences.size === 0) {
                showMessage('<p>PDFを作成する問題を選択してください。</p>', 3000);
                return null;
            }
            // Sort items based on ID
            return Array.from(selectedSentences)
                .map(id => chapterData.find(item => item.id === id))
                .filter(Boolean)
                .sort((a, b) => {
                     // Handle IDs like "1382-1" vs "1382-2"
                     const aParts = a.id.split('-').map(s => parseInt(s) || 0);
                     const bParts = b.id.split('-').map(s => parseInt(s) || 0);
                     if (aParts[0] !== bParts[0]) return aParts[0] - bParts[0];
                     return (aParts[1] || 0) - (bParts[1] || 0);
                });
        }
        
        function getUniqueItems(items) {
             const uniqueMap = new Map();
             items.forEach(item => {
                 // Use answer as key to deduplicate same phrases
                 if (!uniqueMap.has(item.answer)) {
                     uniqueMap.set(item.answer, item);
                 }
             });
             return Array.from(uniqueMap.values()).sort((a, b) => {
                 const aId = parseInt(a.id.split('-')[0]);
                 const bId = parseInt(b.id.split('-')[0]);
                 return aId - bId;
             });
        }


        // --- Message & Sound Functions ---
        
        function showMessage(htmlContent, duration = null) {
            messageContent.innerHTML = htmlContent;
            messageModal.classList.remove('hidden');
            if (duration) {
                setTimeout(() => {
                    messageModal.classList.add('hidden');
                }, duration);
            }
        }

        function playSound() {
            if (!activeSentenceElement) {
                showMessage('<p>文を選択してください。</p>', 2000);
                return;
            }

            // 音声が未設定なら再取得を試みる
            if (!synthesisVoice) {
                setSynthesisVoice();
            }

            // 連続再生を防ぐために一度キャンセル
            speechSynthesis.cancel();
            
            let textToSpeak = activeSentenceElement.dataset.fullSentence;
            // 念のため不要な記号を除去
            textToSpeak = textToSpeak.replace(/[{}]/g, '');

            const utterance = new SpeechSynthesisUtterance(textToSpeak);
            utterance.lang = 'en-US';

            // 英語音声が取得できていれば設定
            if (synthesisVoice) {
                utterance.voice = synthesisVoice;
            }

            utterance.rate = 1.0; 
            utterance.pitch = 1.0;

            speechSynthesis.speak(utterance);
        }

        function handleRecording() {
            if (!activeSentenceElement) {
                showMessage('<p>文を選択してください。</p>', 2000);
                return;
            }
            if (!SpeechRecognition) {
                showMessage('<p>お使いのブラウザは音声認識に対応していません。</p>', 3000);
                return;
            }

            showMessage('<p class="text-2xl">マイクに向かって話してください...</p><div class="animate-pulse text-red-500 text-4xl mt-4">●</div>');
            
            recognition.start();

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                evaluatePronunciation(transcript);
            };

            recognition.onerror = (event) => {
                showMessage(`<p>エラーが発生しました: ${event.error}</p>`, 3000);
            };
            
            recognition.onend = () => {
                 if (messageModal.classList.contains('hidden') === false && messageContent.innerHTML.includes('マイクに')) {
                    messageModal.classList.add('hidden');
                 }
            };
        }
        
        function evaluatePronunciation(transcript) {
            const originalText = activeSentenceElement.dataset.fullSentence;

            const cleanOrig = originalText.toLowerCase().replace(/[^\w\s]/g, '').split(' ');
            const cleanTrans = transcript.toLowerCase().replace(/[^\w\s]/g, '').split(' ');
            
            let matches = 0;
            cleanOrig.forEach(word => {
                if (cleanTrans.includes(word)) {
                    matches++;
                }
            });

            const similarity = matches / cleanOrig.length;
            
            let score;
            if (similarity > 0.9) {
                score = 95 + Math.floor(Math.random() * 5);
            } else if (similarity > 0.7) {
                score = 90 + Math.floor(Math.random() * 6);
            } else if (similarity > 0.5) {
                score = 85 + Math.floor(Math.random() * 5);
            } else if (similarity > 0.3) {
                score = 80 + Math.floor(Math.random() * 5);
            } else {
                score = 70 + Math.floor(Math.random() * 10);
            }
            
            if (score === 100 && Math.random() < 0.3) score = 99;

            const messageHtml = `
                <h3 class="text-2xl font-bold mb-4">評価結果</h3>
                <p class="text-7xl font-bold text-blue-600 mb-4">${score}<span class="text-2xl">点</span></p>
                <p class="text-gray-600 mb-2"><strong>あなたの発音:</strong> ${transcript}</p>
                <p class="text-gray-600"><strong>元の文:</strong> ${originalText}</p>
                <button onclick="document.getElementById('message-modal').classList.add('hidden')" class="mt-6 bg-blue-500 text-white py-2 px-6 rounded-lg">閉じる</button>
            `;
            showMessage(messageHtml);
        }

        // --- Quiz Functions ---

        function startQuiz() {
            if (chapterData.length < 10) {
                 showMessage('<p>クイズを作成するには、文が10個以上必要です。</p>', 3000);
                 return;
            }

            const shuffled = [...chapterData].sort(() => 0.5 - Math.random());
            const questions = shuffled.slice(0, 10);

            let currentQuestionIndex = 0;
            let score = 0;

            function showQuestion() {
                if (currentQuestionIndex >= questions.length) {
                    showQuizResult();
                    return;
                }

                const question = questions[currentQuestionIndex];
                const correctAnswer = question.answer;

                const incorrectAnswers = chapterData
                    .filter(item => item.answer !== correctAnswer)
                    .sort(() => 0.5 - Math.random())
                    .slice(0, 3)
                    .map(item => item.answer);

                const options = [correctAnswer, ...incorrectAnswers].sort(() => 0.5 - Math.random());
                
                const questionSentence = question.en.replace(`{${question.answer}}`, ' (______) ');

                quizContent.innerHTML = `
                    <h3 class="text-2xl font-bold mb-2">問題 ${currentQuestionIndex + 1}/10</h3>
                    <p class="text-lg mb-4">${question.ja}</p>
                    <p class="font-english text-xl mb-6 p-4 bg-gray-100 rounded-lg">${questionSentence}</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        ${options.map(opt => `<button class="quiz-option p-4 bg-blue-100 hover:bg-blue-200 rounded-lg text-left text-lg font-english" data-answer="${opt}">${opt}</button>`).join('')}
                    </div>
                `;

                document.querySelectorAll('.quiz-option').forEach(button => {
                    button.addEventListener('click', () => {
                        if (button.dataset.answer === correctAnswer) {
                            score++;
                            button.classList.add('bg-green-400', 'text-white');
                        } else {
                            button.classList.add('bg-red-400', 'text-white');
                            document.querySelector(`.quiz-option[data-answer="${CSS.escape(correctAnswer)}"]`).classList.add('bg-green-400', 'text-white');
                        }
                        
                        setTimeout(() => {
                            currentQuestionIndex++;
                            showQuestion();
                        }, 1200);
                    });
                });
            }

            function showQuizResult() {
                quizContent.innerHTML = `
                    <h3 class="text-3xl font-bold mb-4 text-center">テスト終了！</h3>
                    <p class="text-center text-xl mb-6">あなたのスコアは...</p>
                    <p class="text-center text-7xl font-bold text-purple-600">${score * 10}<span class="text-3xl">点</span></p>
                    <p class="text-center text-xl mt-2">(${questions.length}問中 ${score}問正解)</p>
                `;
            }

            showQuestion();
            quizModal.classList.remove('hidden');
        }


        // --- Event Listeners ---

        toggleAnswerBtn.addEventListener('click', () => {
            if (!activeSentenceElement) {
                showMessage('<p>文を選択してください。</p>', 2000);
                return;
            }
            activeSentenceElement.classList.toggle('show-answer');
        });

        toggleExplanationBtn.addEventListener('click', () => {
            if (!activeSentenceElement) {
                showMessage('<p>文を選択してください。</p>', 2000);
                return;
            }
            const explanationDiv = activeSentenceElement.querySelector('.explanation');
            if (explanationDiv.style.display === 'block') {
                explanationDiv.style.display = 'none';
            } else {
                explanationDiv.style.display = 'block';
            }
        });
        
        playSoundBtn.addEventListener('click', playSound);
        recordBtn.addEventListener('click', handleRecording);
        startQuizBtn.addEventListener('click', startQuiz);
        closeQuizBtn.addEventListener('click', () => quizModal.classList.add('hidden'));
        
        // Select All Logic
        selectAllCheckbox.addEventListener('change', (e) => {
            const isChecked = e.target.checked;
            const checkboxes = document.querySelectorAll('.sentence-checkbox');
            checkboxes.forEach(cb => {
                cb.checked = isChecked;
                if (isChecked) selectedSentences.add(cb.dataset.id);
                else selectedSentences.delete(cb.dataset.id);
            });
        });

        // PDF Modal Logic
        openPdfModalBtn.addEventListener('click', () => {
             if (selectedSentences.size === 0) {
                showMessage('<p>PDFを作成する問題を選択してください。</p>', 3000);
                return;
            }
            pdfModal.classList.remove('hidden');
        });
        closeModalBtn.addEventListener('click', () => pdfModal.classList.add('hidden'));

        // --- PDF Generation Buttons Listeners ---

        // 変更: PDF内のサブタイトルを「Insight 英文法・語法・熟語 ＋ 章とその題」の形式にする
        // h1: "Insight 英文法・語法・熟語"
        // h2: "学習用サイト（28章 その他の重要熟語）" -> "（28章 その他の重要熟語）" の部分を抽出して結合
        const mainTitle = document.querySelector('header h1').innerText;
        const subTitleRaw = document.getElementById('app-subtitle').innerText;
        // "学習用サイト" という文字が含まれていれば削除して整形
        const chapterTitle = subTitleRaw.replace('学習用サイト', '').trim();
        const subtitleText = `${mainTitle} ${chapterTitle}`;

        // 1. 完全なリスト
        document.getElementById('download-list-btn').addEventListener('click', () => {
            const items = getSelectedItems();
            if(!items) return;
            // リスト作成の場合は重複があっても良いが、見やすくするために熟語ベースでユニークにするか、
            // そのままID順で並べるか。ここではID順ですべて表示する。
            
            const listItems = items.map(item => {
                // Remove { } for clean display
                const cleanEn = item.en.replace(/[{}]/g, '');
                return `<li>
                    <span class="inline-content"><strong>${item.answer}</strong>: ${item.explanation.replace(/\n/g, '<br>')}</span><br>
                    <span style="font-size:0.9em; color:#555;">Ex: ${cleanEn} / ${item.ja}</span>
                </li>`;
            }).join('');
            
            openPrintWindow(`<ul class="list-container">${listItems}</ul>`, '重要熟語リスト');
            pdfModal.classList.add('hidden');
        });

        // 2. 英語を解答
        document.getElementById('download-en-quiz-btn').addEventListener('click', () => {
            const items = getUniqueItems(getSelectedItems());
            
            const quizItems = items.map(item => 
                `<li><span class="inline-content">${item.explanation.replace(/\n/g, ' ')} : ____________________</span></li>`
            ).join('');
            const answerItems = items.map(item => 
                `<li><span class="inline-content">${item.answer}</span></li>`
            ).join('');
            
            const body = `<h2>${subtitleText}</h2><ol class="list-container">${quizItems}</ol><div class="answer-key"><h2>解答</h2><ol class="list-container">${answerItems}</ol></div>`;
            openPrintWindow(body, '熟語テスト (英語を解答)');
            pdfModal.classList.add('hidden');
        });

        // 3. 意味を解答
        document.getElementById('download-ja-quiz-btn').addEventListener('click', () => {
            const items = getUniqueItems(getSelectedItems());
            
            const quizItems = items.map(item => 
                `<li><span class="inline-content"><strong>${item.answer}</strong> : ____________________</span></li>`
            ).join('');
            const answerItems = items.map(item => 
                `<li><span class="inline-content">${item.explanation.replace(/\n/g, ' ')}</span></li>`
            ).join('');
            
            const body = `<h2>${subtitleText}</h2><ol class="list-container">${quizItems}</ol><div class="answer-key"><h2>解答</h2><ol class="list-container">${answerItems}</ol></div>`;
            openPrintWindow(body, '熟語テスト (意味を解答)');
            pdfModal.classList.add('hidden');
        });

        // 4. 混合
        document.getElementById('download-mixed-quiz-btn').addEventListener('click', () => {
            const items = getUniqueItems(getSelectedItems());
            let quizItems = '';
            let answerItems = '';
            
            items.forEach(item => {
                if (Math.random() > 0.5) {
                    // 日本語 -> 英語
                    quizItems += `<li><span class="inline-content">${item.explanation.replace(/\n/g, ' ')} : ____________________</span></li>`;
                    answerItems += `<li><span class="inline-content">${item.answer}</span></li>`;
                } else {
                    // 英語 -> 日本語
                    quizItems += `<li><span class="inline-content"><strong>${item.answer}</strong> : ____________________</span></li>`;
                    answerItems += `<li><span class="inline-content">${item.explanation.replace(/\n/g, ' ')}</span></li>`;
                }
            });
            
            const body = `<h2>${subtitleText}</h2><ol class="list-container">${quizItems}</ol><div class="answer-key"><h2>解答</h2><ol class="list-container">${answerItems}</ol></div>`;
            openPrintWindow(body, '熟語テスト (混合)');
            pdfModal.classList.add('hidden');
        });

        // 5. 例文穴埋め
        document.getElementById('download-sentence-quiz-btn').addEventListener('click', () => {
            const items = getSelectedItems(); // 例文問題なので重複（文脈違い）も含める
            
            const quizItems = items.map(item => {
                // Replace {answer} with underscore
                const blankSentence = item.en.replace(`{${item.answer}}`, '____________________');
                return `<li>${blankSentence}<br><span style="font-size:0.9em;">(${item.ja})</span></li>`;
            }).join('');
            
            const answerItems = items.map(item => 
                `<li>${item.answer}</li>`
            ).join('');

            const body = `<h2>${subtitleText}</h2><ol>${quizItems}</ol><div class="answer-key"><h2>解答</h2><ol class="list-container">${answerItems}</ol></div>`;
            openPrintWindow(body, '熟語テスト (例文穴埋め)');
            pdfModal.classList.add('hidden');
        });

        // 6. 例文混合 (穴埋め / 下線部和訳)
        document.getElementById('download-sentence-mixed-quiz-btn').addEventListener('click', () => {
            const items = getSelectedItems();
            let quizItems = '';
            let answerItems = '';
            
            const instruction = '<p style="border:1px solid #ccc; padding:10px; margin-bottom:20px;">指示：空所には適切な語句を補い、下線部がある文は下線部の意味を日本語で答えなさい。</p>';

            items.forEach(item => {
                if (Math.random() > 0.5) {
                    // 穴埋め
                    const blankSentence = item.en.replace(`{${item.answer}}`, '____________________');
                    quizItems += `<li>${blankSentence}<br><span style="font-size:0.9em;">(${item.ja})</span></li>`;
                    answerItems += `<li>${item.answer}</li>`;
                } else {
                    // 下線部和訳 (ここでは熟語の意味を問う形にする)
                    const underlineSentence = item.en.replace(`{${item.answer}}`, `<u>${item.answer}</u>`);
                    quizItems += `<li>${underlineSentence}<br>意味: ____________________</li>`;
                    answerItems += `<li>${item.explanation.split('\n')[0]}</li>`; // 解説の1行目を答えとする
                }
            });

            const body = `<h2>${subtitleText}</h2>${instruction}<ol>${quizItems}</ol><div class="answer-key"><h2>解答</h2><ol class="list-container">${answerItems}</ol></div>`;
            openPrintWindow(body, '熟語テスト (例文混合)');
            pdfModal.classList.add('hidden');
        });


        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            renderChapter();
        });
    </script>
</body>
</html>