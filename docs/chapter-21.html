<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Insight App - Chapter 21</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&family=Tinos:wght@700&display=swap');
        
        body {
            background-color: #007BFF; /* ビビットなブルー */
            font-family: 'Noto Sans JP', sans-serif;
        }

        /* 英語フォントをTimes New Romanに設定 */
        .font-english {
            font-family: 'Tinos', 'Times New Roman', serif;
            font-weight: 700;
            font-size: 1.25rem; /* 20px */
            line-height: 1.75rem; /* 28px */
        }

        .answer-span {
            color: #DC2626; /* 赤色 */
            font-weight: 700;
            display: none;
        }

        .underline-span {
            text-decoration: underline;
            text-underline-offset: 4px;
            display: inline;
        }

        .show-answer .answer-span {
            display: inline;
        }

        .show-answer .underline-span {
            display: none;
        }
        
        .explanation {
            display: none;
            white-space: pre-wrap;
        }

        /* Button Styles for Modal */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }
        .btn-primary {
            background-color: #3b82f6;
            color: white;
        }
        .btn-primary:hover {
            background-color: #2563eb;
        }
        .btn-secondary {
            background-color: #6b7280;
            color: white;
        }
        .btn-secondary:hover {
            background-color: #4b5563;
        }
    </style>
</head>
<body class="text-gray-800">

    <div id="app-container" class="container mx-auto p-4 md:p-8 max-w-4xl">
        <header class="text-center mb-8 bg-blue-500 p-4 rounded-xl shadow-lg">
            <h1 class="text-2xl md:text-3xl font-bold text-white">Insight 英文法・語法・熟語</h1>
            <h2 id="app-subtitle" class="text-xl md:text-2xl font-bold text-white">学習用サイト（Chapter 21）</h2>
        </header>

        <main class="bg-white/90 backdrop-blur-sm p-6 rounded-xl shadow-lg mb-28">
            <div class="flex justify-between items-center mb-6">
                 <!-- PDF Control Section -->
                 <div class="flex-1 mr-4">
                    <div class="p-4 bg-gray-50 rounded-lg border border-gray-200">
                        <h3 class="font-bold text-sm md:text-base mb-2">選択した問題でPDFを作成</h3>
                        <div class="flex flex-col md:flex-row md:items-center justify-between gap-3">
                            <div class="flex items-center">
                                <input type="checkbox" id="select-all-checkbox" class="h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                <label for="select-all-checkbox" class="ml-2 text-sm font-medium text-gray-700 cursor-pointer">すべて選択 / 解除</label>
                            </div>
                            <button id="open-pdf-modal-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow text-sm transition-transform transform hover:scale-105">
                                PDF作成メニュー
                            </button>
                        </div>
                    </div>
                </div>

                <button id="start-quiz-btn" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-lg shadow transition-transform transform hover:scale-105 whitespace-nowrap">
                    ランダムテスト
                </button>
            </div>

            <div id="sentence-list" class="space-y-6">
                <!-- Sentences will be populated by JS -->
            </div>
        </main>
    </div>

    <!-- Control Panel -->
    <div id="control-panel" class="fixed bottom-0 left-0 right-0 bg-white/80 backdrop-blur-md p-4 border-t-2 border-gray-200 shadow-2xl flex justify-center items-center space-x-2 md:space-x-4">
        <button id="toggle-answer-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">表示/非表示</button>
        <button id="play-sound-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">音声再生</button>
        <button id="record-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">録音評価</button>
        <button id="toggle-explanation-btn" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">解説</button>
    </div>

    <!-- Message/Score Modal -->
    <div id="message-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50">
        <div id="message-content" class="bg-white p-8 rounded-lg shadow-xl text-center">
            <!-- Message content will be populated by JS -->
        </div>
    </div>
    
    <!-- Quiz Modal -->
    <div id="quiz-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center z-40 p-4">
        <div class="bg-white w-full max-w-2xl p-8 rounded-2xl shadow-2xl relative">
            <button id="close-quiz-btn" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-3xl font-bold">&times;</button>
            <div id="quiz-content">
                <!-- Quiz content will be populated by JS -->
            </div>
        </div>
    </div>

    <!-- PDF Download Modal -->
    <div id="pdf-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50">
        <div class="relative mx-auto p-5 border w-11/12 md:w-1/2 lg:w-1/3 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">ダウンロードするPDFの種類を選択</h3>
                <div class="mt-2 space-y-3">
                    <button id="download-list-btn" class="btn btn-primary w-full justify-start text-left">1. 完全なリスト (熟語・意味・例文)</button>
                    <button id="download-en-quiz-btn" class="btn btn-primary w-full justify-start text-left">2. 熟語テスト (英語を解答)</button>
                    <button id="download-ja-quiz-btn" class="btn btn-primary w-full justify-start text-left">3. 熟語テスト (意味を解答)</button>
                    <button id="download-mixed-quiz-btn" class="btn btn-primary w-full justify-start text-left">4. 熟語テスト (混合)</button>
                    <button id="download-sentence-quiz-btn" class="btn btn-primary w-full justify-start text-left">5. 例文の穴埋め問題</button>
                    <button id="download-sentence-mixed-quiz-btn" class="btn btn-primary w-full justify-start text-left">6. 例文の混合問題 (穴埋め/和訳)</button>
                </div>
                <div class="mt-6">
                    <button id="close-modal-btn" class="btn btn-secondary w-full">キャンセル</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const chapterData = [
    {
        "id": "1",
        "ja": "2 3 4 5 6 7 8 9 10音読 ◀\t音読用動画 別解など 副詞の語法 2 3 4 5 6 7 8 9 10音読 時 制 副 詞 過去形と共に 現在完了形と 共に 過去完了形と 共に 副詞の語法 2 3 4 5 6 7 8 9 10音読 肯定文 否定文 疑問文 副詞の語法 2 3 4 5 6 7 8 9 10音読 副詞の語法 2 3 4 5 6 7 8 9 10音読 副詞の語法 2 3 4 5 6 7 8 9 10音読 副詞の語法 2 3 4 5 6 7 8 9 10音読 副詞の語法 2 3 4 5 6 7 8 9 10音読 副詞の語法",
        "en": "???",
        "answer": "???",
        "explanation": "",
        "question": "ΘΕΔso ͱnotFile 99 ؒظʴago ؒظʴbefore most΋ʯ mostlyʮओʹɼ͍͍ͨͯʯ high͘ʯ highlyʮඇৗʹʯ prettyʯ prettilyʮ͖Ε͍ʹʯ sharp͕ʣ͖͔ͬΓʯ sharplyʹɼӶ͘ʯ hard໋ʹʯ hardlyʮ΄ͱΜͲʜͳ͍ʯ➡401 lateʮ஗͘ʯ latelyʯ near͘ʹʯ yet  ʢ·ͩʣ · ͩʢ ʜ ͯ͠ ͍ ͳ ͍ ʣ ΋ ͏ʢ ʜ ͔ ʣ still · ͩʢ ʜ ͯ͠ ͍ Δ ʣ · ͩʢ ʜ ͯ͠ ͍ Δ ͷ ͔ ʣ"
    },
    {
        "id": "21",
        "ja": "副詞の語法 ① 21章 副詞の語法 語法編 ｜  21章 副詞の語法 ② 現在ࡏݱ 語法編 ｜  21章 副詞の語法 ③ 語法編 ｜  21章 副詞の語法 ④ 語法編 ｜  21章 副詞の語法 ⑤ 語法編 ｜  21章 副詞の語法 ⑥ 語法編 ｜  21章 副詞の語法 ⑦ 語法編 ｜  21章 副詞の語法 ⑧",
        "en": "???",
        "answer": "???",
        "explanation": "",
        "question": ""
    },
    {
        "id": "832",
        "ja": "「 サ ラ は 来 る の ？ 」「そう願ってる。」",
        "en": "“Is Sara coming?” “{I hope so.” so ʮͦͷΑ͏ʹʯ―副詞}",
        "answer": "I hope so.” so ʮͦͷΑ͏ʹʯ―副詞",
        "explanation": "▶ 先行するthat 節の肯定の内容をso で代用する場合がある。➡File99\nこの問題文のso はI hope that Sara is coming. のthat節の代用。",
        "question": "“Is Sara coming?” “(        ) (        ) (        )”"
    },
    {
        "id": "833",
        "ja": "「 サ ラ は ま だ 体 調 が 悪 い の ？ 」「そうじゃないことを願ってる。」",
        "en": "“Is Sara still sick?” “{I hope not.”}",
        "answer": "I hope not.”",
        "explanation": "▶ 先行するthat 節の否定の内容をnot で代用する場合がある。➡File99\nこの問題文のnot はI hope that Sara is not sick. のthat節の代用。",
        "question": "“Is Sara still sick?” “(        ) (        ) (        )”"
    },
    {
        "id": "834-1",
        "ja": "家に帰らないといけない。",
        "en": "I have to {go home. go homeΔʯ}",
        "answer": "go home. go homeΔʯ",
        "explanation": "▶ この場合のhome は副詞なのでto などの前置詞は不要。  go to home",
        "question": "I have to ."
    },
    {
        "id": "834-2",
        "ja": "帰り道で昔の友達に会って，楽しいおしゃべりをした。",
        "en": "I met an old friend {on the [my] way home and we had a nice chat. ⇧「 家 へ（home）の 道（the way）の 途 上 で（on）」}",
        "answer": "on the [my] way home and we had a nice chat. ⇧「 家 へ（home）の 道（the way）の 途 上 で（on）」",
        "explanation": "▶ … way to home は誤り。➡File100",
        "question": "I met an old friend (        ) (        ) (        ) (h      ) and we had a nice chat."
    },
    {
        "id": "835",
        "ja": "視野を広げるために私は外国へ行きたいです。",
        "en": "I would like to {go abroad to broaden my horizons. go abroad͘ʯ}",
        "answer": "go abroad to broaden my horizons. go abroad͘ʯ",
        "explanation": "▶ abroad は副詞なのでto などの前置詞は不要。  go to abroad ➡File100\nbroaden one’s horizons͛Δʯ＝expand one’s horizons",
        "question": "I would like to  to broaden my horizons."
    },
    {
        "id": "836",
        "ja": "「私たちと一緒にどう ？」 「もちろん，参加するよ。」",
        "en": "“Do you want to join us?” “Sure, {I’m in.”}",
        "answer": "I’m in.”",
        "explanation": "▶ in は前置詞の用法だけではなく，単独で副詞の働きをすることがある。",
        "question": "“Do you want to join us?” “Sure, (        ) (        ).”"
    },
    {
        "id": "837",
        "ja": "彼は今，外出中です。 ݱ（前置詞は不要）File 100 that節の肯定の内容をso で代用 that節の否定の内容をnot で代用 復習",
        "en": "???",
        "answer": "???",
        "explanation": "",
        "question": "He is (        ) right now. He is out right now. right now  ͙͢ʯ way / abroad go home（  go to home）Δʯɹ  get homeʮՈʹண͘ʯ come homeͬͯ͘Δʯɹ  walk homeΔʯ drive homeΔʯɹ  stay homeʮՈʹ͍Δʯ travel abroad͢Δʯɹ  study abroad͢Δʯ go overseas͘ʯɹ  go downtown͘ʯ go upstairs͘ʯɹ  go downstairs͘ʯ live next door (to A)ʮʢA ͷ ʣྡ ʹ ॅ Ήʯ I think so. / I suppose so. / I guess so. / I expect so.͏ɻʯ I believe so.ʮͦ͏৴͍ͯ͡Δɻʯɹ  I hope so.͏ɻʯ I’m afraid so. / I fear so.೦ͳ͕Βͦ͏ͩɻʯ I guess not. / I believe not.Θͳ͍ɻʯ I hope not.͏ɻʯ 322 323 Self Check"
    },
    {
        "id": "838",
        "ja": "彼女はいつも安全のために明かりをつけっぱなしにしておく。",
        "en": "She always keeps the lights {on} for security. {on} ʮʢςϨϏɾর໌ͳͲ͕ʣ͍ͭͯʯ⇔ oﬀʮʢςϨϏɾর໌ͳͲ͕ʣফ͑ͯʯ",
        "answer": "on",
        "explanation": "▶ このon は前置詞ではなく副詞。➡Grasp30 – p.379\nfor security / for safety ʮ҆શͷͨΊʹʯ",
        "question": "She always keeps the lights (        ) for security."
    },
    {
        "id": "839",
        "ja": "すべての明かりが消えていることを確認して。",
        "en": "???",
        "answer": "???",
        "explanation": "",
        "question": "Make sure all the lights are (        ). Make sure all the lights are oﬀ. off ʮʢςϨϏɾর໌ͳͲ͕ʣফ͑ͯʯ⇔ onʮʢςϨϏɾর໌ͳͲ͕ʣ͍ͭͯʯ make sure (that) …  ᶃʮ…͔ΊΔʯ ᶄʮඞͣ…͢ΔΑ͏ʹ͢Δʯ"
    },
    {
        "id": "840",
        "ja": "夏休みが終わった。",
        "en": "The summer vacation {is over. over ʮऴΘͬͯʯ}",
        "answer": "is over. over ʮऴΘͬͯʯ",
        "explanation": "▶ 「 休みが 終わった」⭢「 休みは今終 わ っ て（over）いる状態である（is）」 と 考 え る 。\nbe動詞を過去形にしないこと。",
        "question": "The summer vacation (i      ) (        )."
    },
    {
        "id": "841",
        "ja": "祖父は3 年 前 に亡くなった。",
        "en": "F 332 ＝ My grandfather died three years ago. My grandfather has been dead for three years.  ➡30 ؒظʴago͔Βʣʙલʹʯ",
        "answer": "???",
        "explanation": "▶ ～ ago は過去形と共に使う。現在を基準にした過去の時点を表す。\n➡Grasp27, File101",
        "question": "My grandfather ."
    },
    {
        "id": "842",
        "ja": "数年前に会ったことがあったので，彼女のことは覚え ていた。",
        "en": "I remembered her because I h{ad met her a few years before. ؒظʴbefore఺͔Βʣʙલʹʯ}",
        "answer": "ad met her a few years before. ؒظʴbefore఺͔Βʣʙલʹʯ",
        "explanation": "▶ ～ before は過去完了形と共に使う。過去のある時点を基準にした過去の時点を\n表す。➡Grasp27, File101",
        "question": "I remembered her because I  her a few ."
    },
    {
        "id": "843",
        "ja": "以前，金閣寺を訪れたこ とがある。",
        "en": "I have visited Kinkaku-ji Temple {before}. ͏{before}ʮҎલʹʯ―副詞",
        "answer": "before",
        "explanation": "▶ 過去形・現在完了形・過去完了形と共に使う。➡File101  通例，文末に置く。\nbefore S′ʴV′ʮ…͢Δલʹɼ…͠ͳ͍͏ͪʹʯ―接続詞  ➡237-1",
        "question": "I have visited Kinkaku-ji Temple (        )."
    },
    {
        "id": "844",
        "ja": "それ以来，彼とは会っていない。",
        "en": "I have not seen him since. ͏(ever) sinceʮͦΕҎདྷʢͣͬͱʣʯ―副詞",
        "answer": "have not seen him since. ͏ever sinceʮͦΕҎདྷʢͣͬͱʣʯ―副詞",
        "explanation": "▶ 現在完了形・過去完了形と共に使う。➡File101\n伝えたい内容を強調したいときにever を付ける。\n(ever) since S′ʴV′ʮ…ͯ͠Ҏ དྷʢͣͬͱʣʯ―接続詞\n(ever) since AʮA Ҏདྷʢͣͬͱʣʯ―前置詞\nmeet / see\nago / before / since๏File 101\na week ago（１週間前）\n［過去形と共に使う］\na week before（その１週間前）\n［過去完了形と共に使う］\nGrasp ～ ago ͱ ～ before27\n324 325\nSelf\nCheck\n復習",
        "question": "I (        ) not (        ) him (        )."
    },
    {
        "id": "845-1",
        "ja": "私 たちはそのコンサ ートのチケットをすでに買ってある。",
        "en": "We have {already} bought tickets for the concert.",
        "answer": "already",
        "explanation": "▶ 肯定文で「すでに（…した）」という完了を表す。➡File102\n完了形で使うことが多いが，他の時制でも使う。",
        "question": "We have (        ) bought tickets for the concert."
    },
    {
        "id": "845-2",
        "ja": "そのコンサ ートのチケットをもう買ったのですか。",
        "en": "Have you {already} bought tickets for the concert? {already} ʮ΋͏ʢ…ͨ͠ͷ͔ʣʯ",
        "answer": "already",
        "explanation": "▶ 疑問文で「もう（…したのか）」という驚きの気持ちを表す。➡File102",
        "question": "Have you (        ) bought tickets for the concert?"
    },
    {
        "id": "846-1",
        "ja": "ちょっと待って。まだ準備ができていない。",
        "en": "Wait a minute. I’m {not ready yet. not … yetʮ·ͩ ʜ͍ͯ͠ͳ͍ ʯ}",
        "answer": "not ready yet. not … yetʮ·ͩ ʜ͍ͯ͠ͳ͍ ʯ",
        "explanation": "▶ 否定文でyet を使い，「まだ…していな い」という未完了を表す。➡File102\nどの時制・完了形でも使う。yet は 文 末 にくることが 多 い 。",
        "question": "Wait a minute. I’m (        ) ready (        )."
    },
    {
        "id": "846-2",
        "ja": "「もう準備できた？」 「まだだって言ったでしょ ！」",
        "en": "“Are you ready {yet}?” “I told you I’m not!” {yet} ʮ΋͏ʢ…͔ʣʯ",
        "answer": "yet",
        "explanation": "▶ 疑問文で「もう（…か）」を表す。この意味ではyet は文末に置く。➡File102",
        "question": "“Are you ready (        )?” “I told you I’m not!”"
    },
    {
        "id": "846-3",
        "ja": "発展 彼は待つように言ったけど， 私 はとに かくそ の 場 を 離 れ た 。",
        "en": "He told me to wait, {(and) yet I left anyway. (and) yet …ʮ͕ͩʜɼ͔͠͠ʜʯ ＝but …}",
        "answer": "(and) yet I left anyway. (and) yet …ʮ͕ͩʜɼ͔͠͠ʜʯ ＝but …",
        "explanation": "▶ and yet のyet は副詞だが，and を省略すると接続詞扱いになる。",
        "question": "He told me to wait,  I left anyway."
    },
    {
        "id": "847",
        "ja": "コンテストで１位を受賞したなんて今でも信じられない。",
        "en": "I {still} can’t believe I won first prize in the contest. {still}΋ͳ͓ʯ",
        "answer": "still",
        "explanation": "▶ 継続を表す。➡File102  どの時制・完了形でも使う。\nwin /f_irst prize ʮ̍ҐʹͳΔɼ༏উ͢Δʯ―first の前に冠詞は不要。",
        "question": "I (        ) can’t believe I won first prize in the contest."
    },
    {
        "id": "848",
        "ja": "彼らはたいていテキストメッセ ー ジで やり取りしている。",
        "en": "They communicate {mostly} by text message. {mostly} ʮ ओ ʹʢ＝mainlyʣɼ ͨ ͍ ͯ ͍ ʯ most΋ʯ➡File103 text messageଳి࿩ͷʣςΩετϝοηʔδɼγϣʔτϝʔϧʯ",
        "answer": "mostly",
        "explanation": "",
        "question": "They communicate (m     ) by text message."
    },
    {
        "id": "849",
        "ja": "インフルエンザは感染力が非常に高い。 復習",
        "en": "???",
        "answer": "???",
        "explanation": "",
        "question": "Influenza is (h      ) contagious. Influenza is highly contagious. highly ʮඇৗʹʯ＝very high͘ʯ➡File103 contagiousછੑͷʯ＝infectious not already / yet / still๏ -lyࢺFile 102 File 103 326 327 Self Check"
    },
    {
        "id": "850",
        "ja": "ケンは試験に向けて懸命に勉強している。 hard໋ʹʯ―hard には形容詞「難しい」だけでなく，副詞の用法もある。",
        "en": "???",
        "answer": "???",
        "explanation": "",
        "question": "Ken has been studying (        ) for his exams. Ken has been studying hard for his exams. hardly ʮ΄ͱΜͲ…ͳ͍ʯ＝scarcely  ➡401, File103 – p.327"
    },
    {
        "id": "851",
        "ja": "結果はなかなか良かった。",
        "en": "The results were {pretty good. prettyɼͳ͔ͳ͔ʯ＝quite ＝rather prettily ʮ͖Ε͍ʹʯ➡File103 – p.327}",
        "answer": "pretty good. prettyɼͳ͔ͳ͔ʯ＝quite ＝rather prettily ʮ͖Ε͍ʹʯ➡File103 – p.327",
        "explanation": "",
        "question": "The results were (        ) (        )."
    },
    {
        "id": "852",
        "ja": "４時ちょうどにここで会いましょう。",
        "en": "???",
        "answer": "???",
        "explanation": "",
        "question": "Let’s meet here . Let’s meet here at four (o’clock) sharp. at ʴࠁ࣌ʴsharp͖͔ͬΓʹʯ sharplyʹɼӶ͘ʯ➡File103 – p.327"
    },
    {
        "id": "853-1",
        "ja": "そ の 新 しい スマ ートフォン はあまりにも高すぎる。",
        "en": "That new smartphone is {far [much] too expensive.}",
        "answer": "far [much] too expensive.",
        "explanation": "▶ 「ఔ౓」ࢺは修飾する語句の直前に置く。\n副詞 far [much, way] が too expensive を修飾する表現。\nfar too ʴʧ\nmuch too ʴʧ\nway too ʴʧ",
        "question": "That new smartphone is (        ) (        ) (        )."
    },
    {
        "id": "853-2",
        "ja": "サラは結婚するにはあまりにも若すぎる。",
        "en": "Sara is {much too young to get married.}",
        "answer": "much too young to get married.",
        "explanation": "▶ 〈much too＋形容詞 ［副詞］ 〉 「あま りにも～すぎる」 too much young ➡853-1\nget married͢Δʯ",
        "question": "Sara is (        ) (        ) (        ) to get married."
    },
    {
        "id": "854-1",
        "ja": "電気のない生活を想像するのはほとんど不可能だ。",
        "en": "It is almost [nearly] impossible to imagine life without electricity. almost ʴʧ nearly ʴʧ    ʮ΄ͱΜͲʙʯ",
        "answer": "almost [nearly] impossible to imagine life without electricity. almost ʴʧ nearly ʴʧ ʮ΄ͱΜͲʙʯ",
        "explanation": "",
        "question": "It is (        ) (        ) to imagine life without electricity."
    },
    {
        "id": "854-2",
        "ja": "幼稚園を卒園し てから彼女とは会っ ていない。もう10年近く前になります。",
        "en": "I haven’t seen her since we graduated from kindergarten, which is {nearly [almost] ten years ago.}",
        "answer": "nearly [almost] ten years ago.",
        "explanation": "▶ 〈nearly＋形容詞 ［副詞］ 〉 「ほとんど～ （近く） 」 。➡854-1  この場合のten はyears\nを修飾する形容詞。which は関係代名詞の非限定用法で，we graduated from\nkindergarten という節を受けている。 「卒園した」 ＝ 「１ ０年近く前」\nkindergarten ʮ༮ஓԂʯ",
        "question": "I haven’t seen her since we graduated from kindergarten, which is (        ) (        ) years ago."
    },
    {
        "id": "855-1",
        "ja": "子どもの頃，海でおぼれかけたことがある。",
        "en": "When I was a child, I {almost [nearly] drowned in the sea. almost ʴࢺ}",
        "answer": "almost [nearly] drowned in the sea. almost ʴࢺ",
        "explanation": "▶ almost もnearly も， 「完全にはその状態に達してはいない」ことを表す。\ndrown͵ʯ",
        "question": "When I was a child, I (        ) (        ) in the sea."
    },
    {
        "id": "855-2",
        "ja": "電車で居眠りし てしまい，危うく乗り過ごすところだった。",
        "en": "I fell asleep on the train and {nearly [almost] missed my stop.}",
        "answer": "nearly [almost] missed my stop.",
        "explanation": "▶ 〈nearly [almost]＋動詞〉 「危う く ［も う少しで］ …するところ」➡855-1\nfall asleep ʮ຾ΓʹམͪΔɼ৸ೖΔʯ\nmiss one’s stopʮ৐Γա͢͝ʯ⇦「停留所 （stop）を と ら え 損 な う（miss）」\nsharp / expensive / impossible / drown / miss\nʮ͋·Γʹ΋ʙ͗͢Δʯ\n―way too ～ は口語でよく使われる。\n328 329\nSelf\nCheck\n復習",
        "question": "I fell asleep on the train and (        ) (        ) my stop."
    },
    {
        "id": "856",
        "ja": "彼は持っ ていたわずかな食料でかろうじて生き延びることができた。",
        "en": "He could barely survive on the little food he had. barely  ᶃʮ ͔ Ζ͏͡ ͯ ʯ ᶄʮ ΄ ͱ Μ Ͳ ʜ ͳ ͍ʢ＝hardlyʣʯ",
        "answer": "barely survive on the little food he had. barely ᶃʮ ͔ Ζ͏͡ ͯ ʯ ᶄʮ ΄ ͱ Μ Ͳ ʜ ͳ ͍ʢ＝hardlyʣʯ",
        "explanation": "▶ barely の後には動詞や形容詞がくる。\nThe elderly person could barely stand.［後ろに動詞］\n＝ The elderly person was barely able to stand.［後ろに形容詞］\n（ そ の お 年 寄 り は 立 っ て い る の が や っ と だ っ た 。）\nthe little A ʮগͳ͍͚ΕͲશ෦ͷAɼͳ͚ͳ͠ͷAʯ＝what little A  ➡209",
        "question": "He could (b      ) (        ) on the little food he had."
    },
    {
        "id": "857",
        "ja": "私たちは間一髪で車の事故を免れた。",
        "en": "We {narrowly avoided a car accident. narrowly ʴࢺʮ͔Ζ͏ͯ͡ʜ͢Δʯ ＝barelyʴࢺ avoid an accidentΛආ͚Δʯ}",
        "answer": "narrowly avoided a car accident. narrowly ʴࢺʮ͔Ζ͏ͯ͡ʜ͢Δʯ ＝barelyʴࢺ avoid an accidentΛආ͚Δʯ",
        "explanation": "",
        "question": "We (n      ) (a      ) a car accident."
    },
    {
        "id": "858",
        "ja": "学校は教師の増員をとても必 要としている。",
        "en": "Schools {badly} need more teachers. {badly} ʮͻͲ͘ɼେ͍ʹʯ ＝awfully ＝terribly  ➡File104",
        "answer": "badly",
        "explanation": "",
        "question": "Schools (b      ) need more teachers."
    },
    {
        "id": "859",
        "ja": "幸い，遠足の当日は晴れだった。",
        "en": "{Fortunately}, it was sunny on the day of the excursion. {Fortunately}, S ʴVӡʹ΋ʜʯ＝Luckily, SʴV ＝It is fortunate that S′ʴV′",
        "answer": "Fortunately",
        "explanation": "▶ 文全体を修飾する副詞。文全体を修飾する副詞には話し手の判断や気持ちを\n表すものがある。➡File105\nexcursion ʮԕ଍ʯ",
        "question": "(F      ), it was sunny on the day of the excursion."
    },
    {
        "id": "860",
        "ja": "不運にも，今朝は電車に乗り遅れて学校に遅刻した。",
        "en": "{Unfortunately}, I missed the train this morning and was late for school. {Unfortunately}, S ʴV೦ͳ͕Βʜʯ miss ʮʢ৐Γ෺ʣʹ৐Γ஗ΕΔʯ⇔⇔ catch͏ʯ be late for A ʮA ʹ஗ΕΔʯ⇔⇔ be in time for AʮA͏ʯ",
        "answer": "Unfortunately",
        "explanation": "",
        "question": "(U      ), I missed the train this morning and was late for school."
    },
    {
        "id": "861",
        "ja": "興味深いこ とに，１円玉を作るのに約３円かかる。 復習",
        "en": "???",
        "answer": "???",
        "explanation": "",
        "question": "(        ), it costs about 3 yen to make a 1-yen coin. Interestingly, it costs about 3 yen to make a 1-yen coin. Interestingly, S ʴVຯਂ͍͜ͱʹʜʯ ＝It is interesting that S′ʴV′ cost  ɾඅ༻ʣ͕͔͔Δʯ survive / avoid luckily / fortunatelyӡʹ΋ʯɹ  unfortunatelyʮෆӡʹ΋ʯ clearly / obviously / evidentlyʮ໌Β͔ʹʯɹ  surely͔ʹʯ naturallyʮ౰વɼ΋ͪΖΜʯɹ  foolishly͔ʹ΋ʯ surprisingly͘΂͖͜ͱʹʯɹ  interestinglyຯਂ͍͜ͱʹʯ apparentlyʮͲ͏΍ΒʜΒ͍͠ʯ absolutelyʮઈରʹʯɹ  completely / entirely / utterlyશʹɼ·ͬͨ͘ʯ greatlyʮେ͍ʹʯɹ  awfully / terriblyʮͱͯ΋ɼͻͲ͘ʯ very / much / tooʮͱͯ΋ʯɹ  quite / ratherʯɹ  fullyʮे෼ʹʯ reallyʮຊ౰ʹʯɹ  fairlyͱʯɹ  somewhatʮ͍͘ͿΜʯ slightlyʮΘ͔ͣʹʯɹ  hardly / scarcelyʮ΄ͱΜͲʜͳ͍ʯ➡401 ࢺFile 105File 104 330 331 Self Check"
    },
    {
        "id": "862",
        "ja": "ケンとサラはそれぞれ16歳と17歳だ。",
        "en": "Ken and Sara are 16 and 17 years old {respectively}. {respectively} ʮͦΕͧΕʹʯ respective ʮͦΕͧΕͷʯ",
        "answer": "respectively",
        "explanation": "▶ respectively を使う ときは，それぞれに「対応するもの」が伴う。この問題文で\nはKen と16 (years old)，Sara と17 years old がそれぞれ対応している。",
        "question": "Ken and Sara are 16 and 17 years old (r      )."
    },
    {
        "id": "863",
        "ja": "電話が鳴った時，妹は熟 睡していた。",
        "en": "My sister was fast asleep when the phone rang. fast asleep sound asleep    ʮ͙ͬ͢Γ຾ͬͯɼख़ਭͯ͠ʯ",
        "answer": "fast asleep when the phone rang. fast asleep sound asleep ʮ͙ͬ͢Γ຾ͬͯɼख़ਭͯ͠ʯ",
        "explanation": "▶ このfast / sound はいずれも副詞。",
        "question": "My sister was (        ) (        ) when the phone rang."
    },
    {
        "id": "864-1",
        "ja": "コーヒーではなくて，何かほかの飲み物が欲しいです。",
        "en": "I don’t want coffee. I’d like {something else to drink, please. else ʮͦͷ΄͔ʹʯ―副詞}",
        "answer": "something else to drink, please. else ʮͦͷ΄͔ʹʯ―副詞",
        "explanation": "▶ else は，something / anything / someone / anyone / no one や who / what\nなどの後に続けて「そのほかに」という意味を表す。",
        "question": "I don’t want coffee. I’d like (        ) (        ) to drink, please."
    },
    {
        "id": "864-2",
        "ja": "「ほかに誰が ミ ー テ ィ ン グ に 来 ま す か 。」「 ケ ン が 来 ま す 。」",
        "en": "“{Who else is coming to the meeting?” “Ken.”}",
        "answer": "Who else is coming to the meeting?” “Ken.”",
        "explanation": "▶ who の後にelse「そのほかに」が続く形。応答文は，Ken (is coming). の\nis coming が省略されている。\nwho else ʮ΄͔ʹ୭͔ʯ",
        "question": "“(        ) (        ) is coming to the meeting?” “Ken.”"
    },
    {
        "id": "865",
        "ja": "連休中，どこかおもしろい所に行きましたか。",
        "en": "Did you go {anywhere} interesting during the holidays?",
        "answer": "anywhere",
        "explanation": "▶ 形容詞 （interesting）が 副 詞（anywhere）を 修 飾 す る ま れ な ケ ー ス 。\nduring the holidaysʹʯ",
        "question": "Did you go (a      ) interesting during the holidays?"
    },
    {
        "id": "866",
        "ja": "私たちはこれ以上，これらの問題を無視するこ とはできない。",
        "en": "＝ We cannot ignore these problems any longer [anymore]. We can no longer ignore these problems. not ʙ any longer [anymore]ʮ΋͸΍ʙͳ͍ʯ＝no longer ignore͢Δʯ",
        "answer": "???",
        "explanation": "",
        "question": "We  ignore these problems ."
    },
    {
        "id": "867",
        "ja": "私が留学したい理由は 3 つある。第一に，私は異文化を体験したい。第二に，英語 を練習したい。最後に，新しい友達をつく りたい。",
        "en": "There are three reasons I want to study abroad. {First, I want to experience a different culture. Second, I want to practice my English. Finally, I want to make new friends.}",
        "answer": "First, I want to experience a different culture. Second, I want to practice my English. Finally, I want to make new friends.",
        "explanation": "▶ 867～876の副詞は文章の中で༿（σΟείʔεϚʔΧʔ）とし て 使 う\nことができる。つなぎの言葉を効果的に使うと，論理的でわかりやすい文章を書く\nことができ る。読むときにも，つなぎの言葉に着目すると文のつながりや論理の\n展開が理解しやすく なる。➡自由英作文の論理パターン ―巻末\n/f_irst ＝/f_irstlyʮୈҰʹʯ\nsecond ＝secondlyʮୈೋʹʯ\nthird ＝thirdlyʹʯ\n/f_inally ＝lastlyʹʯ\n▶ 列挙を表すつなぎの言葉。\nasleep / something\n332 333\nSelf\nCheck\n復習",
        "question": "There are three reasons I want to study abroad. (        ), I want to experience a different culture. (        ), I want to practice my English. (        ), I want to make new friends."
    },
    {
        "id": "868-1",
        "ja": "学校で英語を学んでいる。さらに，毎朝英語のラジオ番組を聴いている。",
        "en": "I’m learning English at school. {Besides}, I listen to English radio programs every morning. besides ʮͦͷ্ʯ＝what’s more ＝also",
        "answer": "Besides",
        "explanation": "▶ 追加を表すつなぎの言葉。会話や比較的カジュアルな文章で使うことが多い。\nbesides AʮA ʹՃ͑ͯʯ―beside AʮA ͷͦ͹ʹʯ➡764",
        "question": "I’m learning English at school. (B      ), I listen to English radio programs every morning."
    },
    {
        "id": "868-2",
        "ja": "ボランティ アをするこ とは地域社会に恩恵をもたらす。さらには，新しい人と出会う いい方法でもある。",
        "en": "Volunteering benefits the community. {Moreover [Furthermore]}, it is a great way to meet new people. moreover furthermore    ʮͦͷ্ɼ͞Βʹ͸ʯ＝in addition",
        "answer": "Moreover [Furthermore]",
        "explanation": "▶ 追加を表すつなぎの言葉。書き言葉や公式な文書で使うことが多い。\nvolunteer  ʮϘϥϯςΟΞΛ͢Δʯ\n―volunteering で「ボランティアをすること」の意味になる。\nbene/f_it  ʮʙʹརӹΛ༩͑Δʯ\ncommunityձʯ",
        "question": "Volunteering benefits the community. (        ), it is a great way to meet new people."
    },
    {
        "id": "869",
        "ja": "私は毎日バランスの取れた食事をし ている。しかしながら，自分へのごほうびによく アイスクリームを食べてしまう。",
        "en": "I eat a balanced diet every day. {However}, I often treat myself to ice cream. however ʮ͔͠͠ͳ͕Βʯ",
        "answer": "However",
        "explanation": "▶ 逆接を表す。  But, S＋V .  butは接続詞なので，普通はコンマを付けない。\nBut で文を始めることは正式な文書では避けられることが多い。\na balanced dietʯ\ntreat A to BʮA ʹB Λ͓͝Δʯ",
        "question": "I eat a balanced diet every day. (H      ), I often treat myself to ice cream."
    },
    {
        "id": "870",
        "ja": "誰もが 平 和を望んでいる。それにもかかわらず，世界の多くの地域で戦争が続いて いる。",
        "en": "Everyone wants peace. {Nevertheless [Nonetheless]}, wars continue in many parts of the world. nevertheless",
        "answer": "Nevertheless [Nonetheless]",
        "explanation": "▶ 逆接を表すつなぎの言葉。",
        "question": "Everyone wants peace. (N      ), wars continue in many parts of the world."
    },
    {
        "id": "871",
        "ja": "石油価格が急騰した。それに応じて，ガソリンも高くなった。",
        "en": "Oil prices rose sharply. {Accordingly}, gas became more expensive. accordingly ʮ͕ͨͬͯ͠ʯ＝therefore ＝so",
        "answer": "Accordingly",
        "explanation": "▶ 結果を表すつなぎの言葉。同意語のso は「したがって」を表す最も日常的な\n表現。\noil pricesʯ\ngas / gasoline / petrolʮΨιϦϯʯ",
        "question": "Oil prices rose sharply. (A      ), gas became more expensive."
    },
    {
        "id": "872",
        "ja": "これらの統計は誤解を招く ものであり，したがって混乱を招く。",
        "en": "These statistics are misleading and {therefore} confusing. {therefore} thus                   ʮͦΕΏ͑ɼ͕ͨͬͯ͠ʯ hence",
        "answer": "therefore",
        "explanation": "▶ 結果を表すつなぎの言葉。thus /ð%s/ とhence は硬い表現。\nstatisticsʯ― 「統計」は複数扱い， 「統計学」は単数扱い。\nmisleadingղΛট͖΍͍͢ʯ―形容詞\nconfusingཚͤ͞Δʯ―形容詞\nmoreover / therefore\n334 335\nSelf\nCheck\n復習",
        "question": "These statistics are misleading and (t      ) confusing."
    },
    {
        "id": "873",
        "ja": "汚染は環境を害し，その結果，人間の健康にも影響を及ぼす。",
        "en": "Pollution harms the environment and {consequently} affects human health. {consequently}Ռʯ＝as a result ＝as a consequence",
        "answer": "consequently",
        "explanation": "▶ 結果を表すつなぎの言葉。\nharm AʮA΅͢ʯ＝do harm to A ＝do A harm\naﬀect AʮA͢Δʯ＝in/f_luence A ＝have an eﬀect on A",
        "question": "Pollution harms the environment and (c      ) affects human health."
    },
    {
        "id": "874",
        "ja": "私は京都が大好きで，特に秋の京都が好きだ。",
        "en": "I love Kyoto, {especially} in the fall. {especially} particularly    ʮಛʹʯ＝in particular",
        "answer": "especially",
        "explanation": "▶ 強調を表すつなぎの言葉。\nin (the) fallʮळʹʯ＝in (the) autumn",
        "question": "I love Kyoto, (        ) in the fall."
    },
    {
        "id": "875",
        "ja": "私は公園には行かなかった。代わりに，家にいてお気に入りの 1 冊を読んだ。",
        "en": "???",
        "answer": "???",
        "explanation": "",
        "question": "I didn’t go to the park. (        ), I stayed home and read one of my favorite books. I didn’t go to the park. Instead, I stayed home and read one of my favorite books. instead ʮ୅ΘΓʹʯ instead of A ʮA ͷ୅ΘΓʹʯ＝in place of A  ➡1362 stay (at) homeʮՈʹ͍Δʯ⇔⇔ go outʮ֎ग़͢Δʯ"
    },
    {
        "id": "876",
        "ja": "子どもには多様な経験が必要だ。そうでないと視 野 が 狭くなる。 （バスに間に合うように早く出発します。さもなければバ ス に 乗 り 遅 れ ま す 。） Otherwise ＝If I don’t leave early …（も し早く出発しなければ…） （あなたはバスに間に合うように早く出発したほうがいい。そうでなければバスに乗り 遅れ る で し ょう 。）［仮定法過去］ Otherwise ＝If you didn’t leave early …（仮に早く出発しないと したら…） （私たちはバスに間に合うように早く出発した。そうでなかったならバスに乗り遅れて い た だ ろ う 。）［仮定法過去完了］ Otherwise ＝If we hadn’t left early …（仮に早く出発しなかったと したら…） （私はそれは不可能だと思ったが，サラはそうではないと［違ったふうに］考 え た 。） （この部屋は狭いが，そのほかの点では申 し 分 な い 。） 復習",
        "en": "???",
        "answer": "???",
        "explanation": "",
        "question": "Children need a variety of experiences. (        ) they will have a narrow view of things. Children need a variety of experiences. Otherwise they will have a narrow view of things. otherwise ʮ͞΋ͳ͚Ε͹ʯ have a variety of experiencesΛ͢Δʯ have a narrow view of things͍ʯ ˱˱have a broad view of things͍ʯ ᶃ I will leave early to catch the bus. Otherwise I will miss it. ᶄ You had better leave early to catch the bus. Otherwise you would miss it. ᶅ We left early to catch the bus. Otherwise we would have missed it. ᶆ I thought it was impossible, but Sara thought otherwise. ᶇ This room is small, but otherwise perfect. consequently 336 337 Self Check"
    }
];

        // --- App State ---
        let activeSentenceElement = null;
        let selectedSentences = new Set();
        let SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition;
        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.lang = 'en-US';
            recognition.interimResults = false;
        }
        
        // --- Voice Synthesis Setup ---
        let synthesisVoice = null;

        function setSynthesisVoice() {
            const voices = speechSynthesis.getVoices();
            // 優先順位: Google US English -> Microsoft Zira/David -> その他英語
            synthesisVoice = voices.find(voice => voice.name === 'Google US English') ||
                             voices.find(voice => voice.name.includes('Google') && voice.lang.includes('en-US')) ||
                             voices.find(voice => voice.name.includes('Microsoft') && voice.lang.includes('en-US')) ||
                             voices.find(voice => voice.lang === 'en-US') ||
                             voices.find(voice => voice.lang.startsWith('en'));
        }

        // 音声リストがロードされたら設定を実行
        if (speechSynthesis.onvoiceschanged !== undefined) {
            speechSynthesis.onvoiceschanged = setSynthesisVoice;
        }
        // 初期化時にも実行
        setSynthesisVoice();


        // --- DOM Elements ---
        const sentenceList = document.getElementById('sentence-list');
        const toggleAnswerBtn = document.getElementById('toggle-answer-btn');
        const playSoundBtn = document.getElementById('play-sound-btn');
        const recordBtn = document.getElementById('record-btn');
        const toggleExplanationBtn = document.getElementById('toggle-explanation-btn');
        const startQuizBtn = document.getElementById('start-quiz-btn');
        const messageModal = document.getElementById('message-modal');
        const messageContent = document.getElementById('message-content');
        const quizModal = document.getElementById('quiz-modal');
        const closeQuizBtn = document.getElementById('close-quiz-btn');
        const quizContent = document.getElementById('quiz-content');
        
        const selectAllCheckbox = document.getElementById('select-all-checkbox');
        const pdfModal = document.getElementById('pdf-modal');
        const openPdfModalBtn = document.getElementById('open-pdf-modal-btn');
        const closeModalBtn = document.getElementById('close-modal-btn');


        // --- Functions ---

        /**
         * Parses the English sentence template and creates the HTML structure.
         */
        function formatEnglishSentence(enTemplate, answer) {
            const blank = '__________';
            const answerHtml = `<span class="answer-span">${answer}</span>`;
            const underlineHtml = `<span class="underline-span">${blank}</span>`;
            const formattedSentence = enTemplate.replace(`{${answer}}`, `${answerHtml}${underlineHtml}`);
            return formattedSentence;
        }

        /**
         * Renders all sentences for the chapter.
         */
        function renderChapter() {
            sentenceList.innerHTML = '';
            chapterData.forEach(item => {
                const sentenceDiv = document.createElement('div');
                sentenceDiv.className = 'sentence-item p-4 border border-gray-200 rounded-lg bg-white transition-shadow duration-300 hover:shadow-md cursor-pointer';
                sentenceDiv.dataset.id = item.id;
                sentenceDiv.dataset.fullSentence = item.en.replace(`{${item.answer}}`, item.answer);

                const englishSentenceHtml = formatEnglishSentence(item.en, item.answer);

                sentenceDiv.innerHTML = `
                    <div class="flex items-start space-x-4">
                         <div class="flex items-center pt-1" onclick="event.stopPropagation()">
                            <input type="checkbox" class="sentence-checkbox h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500" data-id="${item.id}">
                        </div>
                        <span class="text-lg font-bold text-gray-500 w-10 shrink-0 pt-1">${item.id}</span>
                        <div class="flex-1">
                            <p class="mb-2 text-gray-700">${item.ja}</p>
                            <p class="font-english">${englishSentenceHtml}</p>
                            <div class="explanation mt-4 p-4 bg-yellow-100 border-l-4 border-yellow-400 text-gray-700 rounded-r-lg">
                                ${item.explanation}
                            </div>
                        </div>
                    </div>
                `;
                sentenceList.appendChild(sentenceDiv);
            });
            
            // Add click listener to each sentence item
            document.querySelectorAll('.sentence-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    // Don't select if clicking inside explanation
                    if (e.target.closest('.explanation')) return;
                    if (e.target.closest('.sentence-checkbox')) return; // Checkbox click is handled separately

                    if (activeSentenceElement) {
                        activeSentenceElement.classList.remove('ring-2', 'ring-blue-400', 'shadow-xl');
                    }
                    activeSentenceElement = item;
                    activeSentenceElement.classList.add('ring-2', 'ring-blue-400', 'shadow-xl');
                });
            });

            // Checkbox logic
            document.querySelectorAll('.sentence-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    const id = e.target.dataset.id;
                    if (e.target.checked) {
                        selectedSentences.add(id);
                    } else {
                        selectedSentences.delete(id);
                    }
                });
            });
            
            // Select the first sentence by default
            if (sentenceList.firstChild) {
                 sentenceList.firstChild.click();
            }
        }
        
        // --- PDF / Print Logic ---
        
        function openPrintWindow(bodyContent, title) {
            const htmlContent = `
                <!DOCTYPE html>
                <html lang="ja">
                <head>
                    <meta charset="UTF-8">
                    <title>Insight App - Chapter 21</title>
                    <style>
                        body { font-family: "Hiragino Kaku Gothic ProN", "Meiryo", sans-serif; line-height: 1.8; margin: 25px; color: #333; }
                        @media print { .no-print { display: none; } }
                        h1, h2 { text-align: center; border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 25px; }
                        ol, ul { list-style-position: inside; padding-left: 0; }
                        li { margin-bottom: 15px; }
                        .list-container { 
                            column-count: 2; 
                            column-gap: 40px; 
                        }
                        .list-container li, .list-container p { 
                            -webkit-column-break-inside: avoid; 
                            page-break-inside: avoid; 
                            break-inside: avoid; 
                        }
                        ol li {
                            list-style-type: decimal;
                            margin-left: 1.5em; 
                        }
                        .inline-content {
                            display: inline;
                        }
                        @media (max-width: 700px) { .list-container { column-count: 1; } }
                        .answer-key { page-break-before: always; margin-top: 50px; }
                        u { text-decoration: underline; text-underline-offset: 3px; }
                    </style>
                </head>
                <body>
                    <h1>${title}</h1>
                    <p class="no-print" style="text-align:center; margin-bottom: 20px; font-size: 0.9em; color: #666;">
                        ※印刷ダイアログが表示されない場合は、Ctrl+P (または Cmd+P) を押してください。
                    </p>
                    ${bodyContent}
                </body>
                </html>
            `;
            const printWindow = window.open('', '_blank');
            if (!printWindow) {
                showMessage('<p>ポップアップがブロックされました。設定を確認してください。</p>', 5000);
                return;
            }
            printWindow.document.write(htmlContent);
            printWindow.document.close();
            setTimeout(() => {
                printWindow.focus(); 
                printWindow.print();
            }, 250);
        }

        function getSelectedItems() {
            if (selectedSentences.size === 0) {
                showMessage('<p>PDFを作成する問題を選択してください。</p>', 3000);
                return null;
            }
            // Sort items based on ID
            return Array.from(selectedSentences)
                .map(id => chapterData.find(item => item.id === id))
                .filter(Boolean)
                .sort((a, b) => {
                     // Handle IDs like "1382-1" vs "1382-2"
                     const aParts = a.id.split('-').map(s => parseInt(s) || 0);
                     const bParts = b.id.split('-').map(s => parseInt(s) || 0);
                     if (aParts[0] !== bParts[0]) return aParts[0] - bParts[0];
                     return (aParts[1] || 0) - (bParts[1] || 0);
                });
        }
        
        function getUniqueItems(items) {
             const uniqueMap = new Map();
             items.forEach(item => {
                 // Use answer as key to deduplicate same phrases
                 if (!uniqueMap.has(item.answer)) {
                     uniqueMap.set(item.answer, item);
                 }
             });
             return Array.from(uniqueMap.values()).sort((a, b) => {
                 const aId = parseInt(a.id.split('-')[0]);
                 const bId = parseInt(b.id.split('-')[0]);
                 return aId - bId;
             });
        }


        // --- Message & Sound Functions ---
        
        function showMessage(htmlContent, duration = null) {
            messageContent.innerHTML = htmlContent;
            messageModal.classList.remove('hidden');
            if (duration) {
                setTimeout(() => {
                    messageModal.classList.add('hidden');
                }, duration);
            }
        }

        function playSound() {
            if (!activeSentenceElement) {
                showMessage('<p>文を選択してください。</p>', 2000);
                return;
            }

            // 音声が未設定なら再取得を試みる
            if (!synthesisVoice) {
                setSynthesisVoice();
            }

            // 連続再生を防ぐために一度キャンセル
            speechSynthesis.cancel();
            
            let textToSpeak = activeSentenceElement.dataset.fullSentence;
            // 念のため不要な記号を除去
            textToSpeak = textToSpeak.replace(/[{}]/g, '');

            const utterance = new SpeechSynthesisUtterance(textToSpeak);
            utterance.lang = 'en-US';

            // 英語音声が取得できていれば設定
            if (synthesisVoice) {
                utterance.voice = synthesisVoice;
            }

            utterance.rate = 1.0; 
            utterance.pitch = 1.0;

            speechSynthesis.speak(utterance);
        }

        function handleRecording() {
            if (!activeSentenceElement) {
                showMessage('<p>文を選択してください。</p>', 2000);
                return;
            }
            if (!SpeechRecognition) {
                showMessage('<p>お使いのブラウザは音声認識に対応していません。</p>', 3000);
                return;
            }

            showMessage('<p class="text-2xl">マイクに向かって話してください...</p><div class="animate-pulse text-red-500 text-4xl mt-4">●</div>');
            
            recognition.start();

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                evaluatePronunciation(transcript);
            };

            recognition.onerror = (event) => {
                showMessage(`<p>エラーが発生しました: ${event.error}</p>`, 3000);
            };
            
            recognition.onend = () => {
                 if (messageModal.classList.contains('hidden') === false && messageContent.innerHTML.includes('マイクに')) {
                    messageModal.classList.add('hidden');
                 }
            };
        }
        
        function evaluatePronunciation(transcript) {
            const originalText = activeSentenceElement.dataset.fullSentence;

            const cleanOrig = originalText.toLowerCase().replace(/[^\w\s]/g, '').split(' ');
            const cleanTrans = transcript.toLowerCase().replace(/[^\w\s]/g, '').split(' ');
            
            let matches = 0;
            cleanOrig.forEach(word => {
                if (cleanTrans.includes(word)) {
                    matches++;
                }
            });

            const similarity = matches / cleanOrig.length;
            
            let score;
            if (similarity > 0.9) {
                score = 95 + Math.floor(Math.random() * 5);
            } else if (similarity > 0.7) {
                score = 90 + Math.floor(Math.random() * 6);
            } else if (similarity > 0.5) {
                score = 85 + Math.floor(Math.random() * 5);
            } else if (similarity > 0.3) {
                score = 80 + Math.floor(Math.random() * 5);
            } else {
                score = 70 + Math.floor(Math.random() * 10);
            }
            
            if (score === 100 && Math.random() < 0.3) score = 99;

            const messageHtml = `
                <h3 class="text-2xl font-bold mb-4">評価結果</h3>
                <p class="text-7xl font-bold text-blue-600 mb-4">${score}<span class="text-2xl">点</span></p>
                <p class="text-gray-600 mb-2"><strong>あなたの発音:</strong> ${transcript}</p>
                <p class="text-gray-600"><strong>元の文:</strong> ${originalText}</p>
                <button onclick="document.getElementById('message-modal').classList.add('hidden')" class="mt-6 bg-blue-500 text-white py-2 px-6 rounded-lg">閉じる</button>
            `;
            showMessage(messageHtml);
        }

        // --- Quiz Functions ---

        function startQuiz() {
            if (chapterData.length < 10) {
                 showMessage('<p>クイズを作成するには、文が10個以上必要です。</p>', 3000);
                 return;
            }

            const shuffled = [...chapterData].sort(() => 0.5 - Math.random());
            const questions = shuffled.slice(0, 10);

            let currentQuestionIndex = 0;
            let score = 0;

            function showQuestion() {
                if (currentQuestionIndex >= questions.length) {
                    showQuizResult();
                    return;
                }

                const question = questions[currentQuestionIndex];
                const correctAnswer = question.answer;

                const incorrectAnswers = chapterData
                    .filter(item => item.answer !== correctAnswer)
                    .sort(() => 0.5 - Math.random())
                    .slice(0, 3)
                    .map(item => item.answer);

                const options = [correctAnswer, ...incorrectAnswers].sort(() => 0.5 - Math.random());
                
                const questionSentence = question.en.replace(`{${question.answer}}`, ' (______) ');

                quizContent.innerHTML = `
                    <h3 class="text-2xl font-bold mb-2">問題 ${currentQuestionIndex + 1}/10</h3>
                    <p class="text-lg mb-4">${question.ja}</p>
                    <p class="font-english text-xl mb-6 p-4 bg-gray-100 rounded-lg">${questionSentence}</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        ${options.map(opt => `<button class="quiz-option p-4 bg-blue-100 hover:bg-blue-200 rounded-lg text-left text-lg font-english" data-answer="${opt}">${opt}</button>`).join('')}
                    </div>
                `;

                document.querySelectorAll('.quiz-option').forEach(button => {
                    button.addEventListener('click', () => {
                        if (button.dataset.answer === correctAnswer) {
                            score++;
                            button.classList.add('bg-green-400', 'text-white');
                        } else {
                            button.classList.add('bg-red-400', 'text-white');
                            document.querySelector(`.quiz-option[data-answer="${CSS.escape(correctAnswer)}"]`).classList.add('bg-green-400', 'text-white');
                        }
                        
                        setTimeout(() => {
                            currentQuestionIndex++;
                            showQuestion();
                        }, 1200);
                    });
                });
            }

            function showQuizResult() {
                quizContent.innerHTML = `
                    <h3 class="text-3xl font-bold mb-4 text-center">テスト終了！</h3>
                    <p class="text-center text-xl mb-6">あなたのスコアは...</p>
                    <p class="text-center text-7xl font-bold text-purple-600">${score * 10}<span class="text-3xl">点</span></p>
                    <p class="text-center text-xl mt-2">(${questions.length}問中 ${score}問正解)</p>
                `;
            }

            showQuestion();
            quizModal.classList.remove('hidden');
        }


        // --- Event Listeners ---

        toggleAnswerBtn.addEventListener('click', () => {
            if (!activeSentenceElement) {
                showMessage('<p>文を選択してください。</p>', 2000);
                return;
            }
            activeSentenceElement.classList.toggle('show-answer');
        });

        toggleExplanationBtn.addEventListener('click', () => {
            if (!activeSentenceElement) {
                showMessage('<p>文を選択してください。</p>', 2000);
                return;
            }
            const explanationDiv = activeSentenceElement.querySelector('.explanation');
            if (explanationDiv.style.display === 'block') {
                explanationDiv.style.display = 'none';
            } else {
                explanationDiv.style.display = 'block';
            }
        });
        
        playSoundBtn.addEventListener('click', playSound);
        recordBtn.addEventListener('click', handleRecording);
        startQuizBtn.addEventListener('click', startQuiz);
        closeQuizBtn.addEventListener('click', () => quizModal.classList.add('hidden'));
        
        // Select All Logic
        selectAllCheckbox.addEventListener('change', (e) => {
            const isChecked = e.target.checked;
            const checkboxes = document.querySelectorAll('.sentence-checkbox');
            checkboxes.forEach(cb => {
                cb.checked = isChecked;
                if (isChecked) selectedSentences.add(cb.dataset.id);
                else selectedSentences.delete(cb.dataset.id);
            });
        });

        // PDF Modal Logic
        openPdfModalBtn.addEventListener('click', () => {
             if (selectedSentences.size === 0) {
                showMessage('<p>PDFを作成する問題を選択してください。</p>', 3000);
                return;
            }
            pdfModal.classList.remove('hidden');
        });
        closeModalBtn.addEventListener('click', () => pdfModal.classList.add('hidden'));

        // --- PDF Generation Buttons Listeners ---

        // 変更: PDF内のサブタイトルを「Insight 英文法・語法・熟語 ＋ 章とその題」の形式にする
        // h1: "Insight 英文法・語法・熟語"
        // h2: "学習用サイト（28章 その他の重要熟語）" -> "（28章 その他の重要熟語）" の部分を抽出して結合
        const mainTitle = document.querySelector('header h1').innerText;
        const subTitleRaw = document.getElementById('app-subtitle').innerText;
        // "学習用サイト" という文字が含まれていれば削除して整形
        const chapterTitle = subTitleRaw.replace('学習用サイト', '').trim();
        const subtitleText = `${mainTitle} ${chapterTitle}`;

        // 1. 完全なリスト
        document.getElementById('download-list-btn').addEventListener('click', () => {
            const items = getSelectedItems();
            if(!items) return;
            // リスト作成の場合は重複があっても良いが、見やすくするために熟語ベースでユニークにするか、
            // そのままID順で並べるか。ここではID順ですべて表示する。
            
            const listItems = items.map(item => {
                // Remove { } for clean display
                const cleanEn = item.en.replace(/[{}]/g, '');
                return `<li>
                    <span class="inline-content"><strong>${item.answer}</strong>: ${item.explanation.replace(/\n/g, '<br>')}</span><br>
                    <span style="font-size:0.9em; color:#555;">Ex: ${cleanEn} / ${item.ja}</span>
                </li>`;
            }).join('');
            
            openPrintWindow(`<ul class="list-container">${listItems}</ul>`, '重要熟語リスト');
            pdfModal.classList.add('hidden');
        });

        // 2. 英語を解答
        document.getElementById('download-en-quiz-btn').addEventListener('click', () => {
            const items = getUniqueItems(getSelectedItems());
            
            const quizItems = items.map(item => 
                `<li><span class="inline-content">${item.explanation.replace(/\n/g, ' ')} : ____________________</span></li>`
            ).join('');
            const answerItems = items.map(item => 
                `<li><span class="inline-content">${item.answer}</span></li>`
            ).join('');
            
            const body = `<h2>${subtitleText}</h2><ol class="list-container">${quizItems}</ol><div class="answer-key"><h2>解答</h2><ol class="list-container">${answerItems}</ol></div>`;
            openPrintWindow(body, '熟語テスト (英語を解答)');
            pdfModal.classList.add('hidden');
        });

        // 3. 意味を解答
        document.getElementById('download-ja-quiz-btn').addEventListener('click', () => {
            const items = getUniqueItems(getSelectedItems());
            
            const quizItems = items.map(item => 
                `<li><span class="inline-content"><strong>${item.answer}</strong> : ____________________</span></li>`
            ).join('');
            const answerItems = items.map(item => 
                `<li><span class="inline-content">${item.explanation.replace(/\n/g, ' ')}</span></li>`
            ).join('');
            
            const body = `<h2>${subtitleText}</h2><ol class="list-container">${quizItems}</ol><div class="answer-key"><h2>解答</h2><ol class="list-container">${answerItems}</ol></div>`;
            openPrintWindow(body, '熟語テスト (意味を解答)');
            pdfModal.classList.add('hidden');
        });

        // 4. 混合
        document.getElementById('download-mixed-quiz-btn').addEventListener('click', () => {
            const items = getUniqueItems(getSelectedItems());
            let quizItems = '';
            let answerItems = '';
            
            items.forEach(item => {
                if (Math.random() > 0.5) {
                    // 日本語 -> 英語
                    quizItems += `<li><span class="inline-content">${item.explanation.replace(/\n/g, ' ')} : ____________________</span></li>`;
                    answerItems += `<li><span class="inline-content">${item.answer}</span></li>`;
                } else {
                    // 英語 -> 日本語
                    quizItems += `<li><span class="inline-content"><strong>${item.answer}</strong> : ____________________</span></li>`;
                    answerItems += `<li><span class="inline-content">${item.explanation.replace(/\n/g, ' ')}</span></li>`;
                }
            });
            
            const body = `<h2>${subtitleText}</h2><ol class="list-container">${quizItems}</ol><div class="answer-key"><h2>解答</h2><ol class="list-container">${answerItems}</ol></div>`;
            openPrintWindow(body, '熟語テスト (混合)');
            pdfModal.classList.add('hidden');
        });

        // 5. 例文穴埋め
        document.getElementById('download-sentence-quiz-btn').addEventListener('click', () => {
            const items = getSelectedItems(); // 例文問題なので重複（文脈違い）も含める
            
            const quizItems = items.map(item => {
                // Replace {answer} with underscore
                const blankSentence = item.en.replace(`{${item.answer}}`, '____________________');
                return `<li>${blankSentence}<br><span style="font-size:0.9em;">(${item.ja})</span></li>`;
            }).join('');
            
            const answerItems = items.map(item => 
                `<li>${item.answer}</li>`
            ).join('');

            const body = `<h2>${subtitleText}</h2><ol>${quizItems}</ol><div class="answer-key"><h2>解答</h2><ol class="list-container">${answerItems}</ol></div>`;
            openPrintWindow(body, '熟語テスト (例文穴埋め)');
            pdfModal.classList.add('hidden');
        });

        // 6. 例文混合 (穴埋め / 下線部和訳)
        document.getElementById('download-sentence-mixed-quiz-btn').addEventListener('click', () => {
            const items = getSelectedItems();
            let quizItems = '';
            let answerItems = '';
            
            const instruction = '<p style="border:1px solid #ccc; padding:10px; margin-bottom:20px;">指示：空所には適切な語句を補い、下線部がある文は下線部の意味を日本語で答えなさい。</p>';

            items.forEach(item => {
                if (Math.random() > 0.5) {
                    // 穴埋め
                    const blankSentence = item.en.replace(`{${item.answer}}`, '____________________');
                    quizItems += `<li>${blankSentence}<br><span style="font-size:0.9em;">(${item.ja})</span></li>`;
                    answerItems += `<li>${item.answer}</li>`;
                } else {
                    // 下線部和訳 (ここでは熟語の意味を問う形にする)
                    const underlineSentence = item.en.replace(`{${item.answer}}`, `<u>${item.answer}</u>`);
                    quizItems += `<li>${underlineSentence}<br>意味: ____________________</li>`;
                    answerItems += `<li>${item.explanation.split('\n')[0]}</li>`; // 解説の1行目を答えとする
                }
            });

            const body = `<h2>${subtitleText}</h2>${instruction}<ol>${quizItems}</ol><div class="answer-key"><h2>解答</h2><ol class="list-container">${answerItems}</ol></div>`;
            openPrintWindow(body, '熟語テスト (例文混合)');
            pdfModal.classList.add('hidden');
        });


        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            renderChapter();
        });
    </script>
</body>
</html>